<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   
      <title>Chapter&nbsp;2.&nbsp;Items</title>
      <link rel="stylesheet" href="../css/bigworld.css" type="text/css">
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0">
      <link rel="start" href="index.html" title="How To Implement Items And Trading">
      <link rel="up" href="index.html" title="How To Implement Items And Trading">
      <link rel="prev" href="ch01.html" title="Chapter&nbsp;1.&nbsp;Introduction">
      <link rel="next" href="ch03.html" title="Chapter&nbsp;3.&nbsp;Trading"><script type="text/javascript" src="../css/bigworld.js"></script></head>
   <body onLoad="loader();">
      <div id="bigworld-header"><img src="bigworld_logo.gif" id="bwLogo" alt="bw logo"></div>
      <div id="content">
         <div class="navheader">
            <table width="95%" align="center" summary="Navigation header">
               <tr>
                  <th colspan="3" align="center">Chapter&nbsp;2.&nbsp;Items</th>
               </tr>
               <tr>
                  <td width="20%" align="left"><a accesskey="p" href="ch01.html">Prev</a>&nbsp;
                  </td>
                  <th width="55%" align="center">&nbsp;</th>
                  <td width="20%" align="right">&nbsp;<a accesskey="n" href="ch03.html">Next</a></td>
               </tr>
            </table>
            <hr class="navheaderline">
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title"><a name="d0e25"></a>Chapter&nbsp;2.&nbsp;Items
                     </h2>
                  </div>
               </div>
            </div>
            <div class="toc">
               <p><b>Table of Contents</b></p>
               <dl>
                  <dt><span class="sect1"><a href="ch02.html#d0e34">2.1. Item definition</a></span></dt>
                  <dt><span class="sect1"><a href="ch02.html#d0e125">2.2. Additional Security</a></span></dt>
                  <dt><span class="sect1"><a href="ch02.html#d0e133">2.3. Rendering the Item</a></span></dt>
                  <dt><span class="sect1"><a href="ch02.html#d0e215">2.4. The Inventory</a></span></dt>
                  <dd>
                     <dl>
                        <dt><span class="sect2"><a href="ch02.html#d0e363">2.4.1. Inventory Manager</a></span></dt>
                        <dt><span class="sect2"><a href="ch02.html#d0e417">2.4.2. Serial Numbers</a></span></dt>
                     </dl>
                  </dd>
                  <dt><span class="sect1"><a href="ch02.html#xref_Dropping_And_Picking_Items_Up">2.5. Dropping and picking items up</a></span></dt>
                  <dd>
                     <dl>
                        <dt><span class="sect2"><a href="ch02.html#xref_Dropping_An_Item_On_The_Ground">2.5.1. Dropping an item on the ground</a></span></dt>
                        <dt><span class="sect2"><a href="ch02.html#d0e602">2.5.2. Picking an item up from the ground</a></span></dt>
                     </dl>
                  </dd>
                  <dt><span class="sect1"><a href="ch02.html#xref_Locking_Inventory_Items">2.6. Locking inventory items</a></span></dt>
               </dl>
            </div>
            <p>Items are things that players and other entities can possess, such
                   as guns, swords, loot, etc.
            </p>
            <p>Since these are, most of the time, attached to other entities and do
                   not have a position of their own in the world, they do not need to be
                   BigWorld entities. The only exceptions are items lying on the ground. For
                   more details, see <a href="ch02.html#xref_Dropping_And_Picking_Items_Up" title="2.5.&nbsp;Dropping and picking items up">Dropping and picking items up</a>.
            </p>
            <div class="sect1" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e34"></a>2.1.&nbsp;Item definition
                        </h2>
                     </div>
                  </div>
               </div>
               <p>The simplest way of representing an item is as an integer value,
                        representing the <em class="emphasis">item type ID</em>. This <em class="emphasis">type
                           ID</em> can then be transmitted between the server and
                        clients.
               </p>
               <p>It is recommended that an <em class="emphasis">alias</em> be defined
                        for the item type in the file
                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</span>
                        (where <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span> is the
                        first folder specified in environment variables
                        <span class="literal">BW_RES_PATH</span>). In the sample implementation, the
                        definition looks like this:
               </p><pre class="programlisting">&lt;root&gt;
    ...
    &lt;ITEMTYPE&gt;    INT32    &lt;/ITEMTYPE&gt;
    ....   </pre><p>The items types are enumerated inside the file
                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/ItemBase.py</span>:
               </p><pre class="programlisting">class ItemBase:
    ...
    NONE_TYPE          = -1
    STAFF_TYPE         =  2
    STAFF_TYPE_2       =  3
    DRUMSTICK_TYPE     =  4
    SPIDER_LEG_TYPE    =  5
    BINOCULARS_TYPE    =  6
    SWORD_TYPE         =  7
    SWORD_TYPE_2       =  9
    GOBLET_TYPE        =  17
    ...</pre><p>Mapping from <em class="emphasis">item type ID</em> to specific item
                        look and behaviour can be coded on the client and server as needed. This
                        can be done by simply using lookup tables or item classes. In the sample
                        implementation, item classes are used on the client to implement the
                        behaviour of each type of item. All items types derive from a base Item
                        class and must specialize items behaviours like
                        <span class="literal">enact</span>, <span class="literal">enactIdle</span><span class="literal">,
                           enactDrawn</span> and <span class="literal">use</span>.
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Item.py</span>:</em></p><pre class="programlisting">import ItemBase
....

class Item( ItemBase.ItemBase ):
    def use( self, user, target ):
        ...
    def name( self ):
        ...

class Food(Item):
    def use( self, user, target ):
        ....
        user.eat( self.itemType )
        user.cell.eat( self.itemType )
        ...</pre></li>
                  </ul>
               </div>
               <p>The type classes are also used to carry information about the
                        items look, like models and icons.
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Item.py</span>:</em></p><pre class="programlisting">class Food(Item):
    ...
    modelNames = {
        STRIFF_DRUMSTICK: "sets/items/item_food_drumstick.model",
        SPIDER_LEG:       "characters/npc/spider/spider_leg.model",
        WINE_GOBLET:      "sets/items/grail.model"
    }
    ...
    guiIconNames = {
        STRIFF_DRUMSTICK: "gui/maps/icon_items/icon_food_drumstick.tga",
        SPIDER_LEG:       "gui/maps/icon_items/icon_spider_leg.tga",
        WINE_GOBLET:      "gui/maps/icon_items/icon_grail.tga"
    }
    ...</pre></li>
                  </ul>
               </div>
               <p>Within this system, creating a new item type is done by inserting
                        a new <em class="emphasis">item type ID</em> into the items type list and
                        implementing class for the specialized behaviour.
               </p>
               <p>You can build more complex structures to represent an item as
                        needed, such as adding its ammo count. This information could be encoded
                        into the <span class="literal">int32</span> data type, or a new class structure
                        could be created to implement it.
               </p>
            </div>
            <div class="sect1" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e125"></a>2.2.&nbsp;Additional Security
                        </h2>
                     </div>
                  </div>
               </div>
               <p>The creation and deletion of items are best done using a
                        <em class="emphasis">global items</em> manager on the base. This manager
                        should ensure that items are created and destroyed according to specific
                        rules, assign unique serial number to items, and enforce security so
                        that things such as duplication exploits cannot be used.
               </p>
            </div>
            <div class="sect1" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e133"></a>2.3.&nbsp;Rendering the Item
                        </h2>
                     </div>
                  </div>
               </div>
               <p>For the item currently equipped by an Avatar to be properly
                        rendered on all clients, the property containing the <em class="emphasis">item type
                           ID</em> must be current on all clients at all times. Whenever a
                        player chooses to equip a new item, it must notify its cell. The cell
                        will then update all other clients with the newly selected
                        <em class="emphasis">item type ID</em>.
               </p>
               <p>In the sample implementation, the property
                        <span class="literal">rightHand</span> carries the Avatar&#8217;s currently equipped
                        item. The fact that this property is flagged
                        <span class="literal">OTHER_CLIENTS</span> means that the owner
                        <span class="literal">Avatar</span> in the client will not be updated when the
                        property changes in the cell (this is because changes to it are
                        triggered by the client <span class="literal">Avatar</span> itself).
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/interfaces/Avatar.def</span>:</em></p><pre class="programlisting">&lt;root&gt;
    ...
    &lt;Properties&gt;
        &lt;rightHand&gt;
            &lt;Type&gt; ITEMTYPE &lt;/Type&gt;
            &lt;Flags&gt; OTHER_CLIENTS &lt;/Flags&gt;
            &lt;Default&gt; -1  &lt;/Default&gt;
            &lt;Editable&gt; true &lt;/Editable&gt;
    &lt;/rightHand&gt;
    ...</pre></li>
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class PlayerAvatar:
    ...
    def equip( self, itemType ... ):
        ...
        self.rightHand = itemType          # change locally
        self.cell.setRightHand( itemType ) # tell the world
        ...</pre></li>
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</span>:</em></p><pre class="programlisting">def setRightHand( self, sourceID, itemType ):
    ...
    self.rightHand = itemType # will propagate to all otherClients</pre></li>
                  </ul>
               </div>
               <p>To render the item in the player's hand, the 3D model representing
                        the item must be attached to a hard point in the Avatar model. This
                        should be done whenever the player equips a new item. The sample
                        implementation uses the <span class="literal">set_rightHand</span> method to do
                        that. The <span class="literal">set_rightHand</span> method is implicitly called
                        whenever the value of the property <span class="literal">rightHand</span> is
                        updated in the client by the server.
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class Avatar:
    def set_rightHand( self, oldRH = None ... ):
        ...
        self.lockRightHandModel( True )
        ...

    def lockRightHandModel( self, lock, itemLoader = None ):
        ...
            self.rightHandItem = Item.newItem( self.rightHand )
            ...
            if self.rightHandItem != None:
                ...
                self.model.right_hand = self.rightHandItem.model
                ...
        ...</pre></li>
                  </ul>
               </div>
            </div>
            <div class="sect1" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e215"></a>2.4.&nbsp;The Inventory
                        </h2>
                     </div>
                  </div>
               </div>
               <p>An inventory is a collection of items. Inventories are typically
                        stored on both the client and the base. Having the inventory on the cell
                        would increase the load of migrating entities from cell to cell as they
                        move in the space.
               </p>
               <p>The authoritative copy of an inventory should always reside on the
                        base entity, where it can be easily stored and retrieved from persistent
                        storage through the BigWorld database interface. The client copy of the
                        inventory can then be regenerated from the base whenever
                        necessary.
               </p>
               <p>The client should have a graphics user interface to the inventory,
                        so that players can view their items. They can use this interface to add
                        or remove items from their inventories. This should then be updated on
                        the base entity and stored on the database at convenient times.
               </p>
               <p>In the sample implementation, the inventory data is stored in a
                        set of <span class="literal">BASE_AND_CLIENT</span> properties in the Avatar
                        entity:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><span class="literal">inventoryItems</span></p>
                     </li>
                     <li>
                        <p><span class="literal">inventoryLocks</span></p>
                     </li>
                     <li>
                        <p><span class="literal">inventoryGoldPieces</span></p>
                     </li>
                  </ul>
               </div>
               <p><span class="literal">inventoryItems</span> is an array of the type
                        <span class="literal">InventoryEntry</span>. <span class="literal">inventoryLocks</span> is
                        an array of the type <span class="literal">LockedEntry</span>. Both
                        <span class="literal">InventoryEntry</span> and <span class="literal">LockedEntry</span>
                        types are defined in the
                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml
                           file</span>. These types are defined using BigWorld&#8217;s
                        <span class="literal">FIXED_DICT</span> type feature.
                        <span class="literal">inventoryGoldPieces</span> is of type
                        <span class="literal">INT32</span>.
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/Avatar.def</span>:</em></p><pre class="programlisting">&lt;root&gt;
    &lt;Properties&gt;
        ...
        &lt;inventoryItems&gt;
            &lt;Type&gt;  ARRAY &lt;of&gt; InventoryEntry &lt;/of&gt; &lt;/Type&gt;
            &lt;Flags  BASE_AND_CLIENT &lt;/Flags&gt;
            &lt;Persistent&gt; true   &lt;/Persistent&gt;
            &lt;Default&gt;  ...   &lt;/ Default &gt;
        &lt;/inventoryItems&gt;

         &lt;inventoryLocks&gt;
             &lt;Type&gt;   ARRAY &lt;of&gt; LockedEntry &lt;/of&gt; &lt;/Type&gt;
             &lt;Flags&gt; BASE_AND_CLIENT &lt;/Flags&gt;
             &lt;Persistent&gt; true   &lt;/Persistent&gt;
        &lt;/inventoryLocks&gt;

        &lt;inventoryGoldPieces&gt;
            &lt;Type&gt;  INT32   &lt;/Type&gt;
            &lt;Flags&gt;  BASE_AND_CLIENT &lt;/Flags&gt;
            &lt;Persistent&gt; true   &lt;/Persistent&gt;
            &lt;Default&gt; 100 &lt;/Default&gt;
        &lt;/inventoryGoldPieces&gt;
        ....</pre></li>
                     <li>
                        <p><em class="emphasis">In
                                        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</span>:</em></p><pre class="programlisting">&lt;root&gt;
    ...
    &lt;ITEMSERIAL&gt;  INT32  &lt;/ITEMSERIAL&gt;
    &lt;LOCKHANDLE&gt;  INT32  &lt;/LOCKHANDLE&gt;
    &lt;GOLDPIECES&gt;  INT16  &lt;/GOLDPIECES&gt;

    &lt;InventoryEntry&gt; FIXED_DICT
        &lt;Properties&gt;
            &lt;itemType&gt;
                &lt;Type&gt; ITEMTYPE &lt;/Type&gt;
            &lt;/itemType&gt;
            &lt;serial&gt;
                &lt;Type&gt; ITEMSERIAL &lt;/Type&gt;
            &lt;/serial&gt;
            &lt;lockHandle&gt;
                &lt;Type&gt; LOCKHANDLE &lt;/Type&gt;
            &lt;/lockHandle&gt;
       &lt;/Properties&gt;
    &lt;/InventoryEntry&gt;

    &lt;LockedEntry&gt; FIXED_DICT
        &lt;Properties&gt;
            &lt;lockHandle&gt;
                &lt;Type&gt; LOCKHANDLE &lt;/Type&gt;
            &lt;/lockHandle&gt;
            &lt;goldPieces&gt;
                &lt;Type&gt; GOLDPIECES &lt;/Type&gt;
            &lt;/goldPieces&gt;
        &lt;/Properties&gt;
    &lt;/LockedEntry&gt;
    ....</pre></li>
                  </ul>
               </div>
               <p>The fact that the inventory properties are flagged
                        <span class="literal">BASE_AND_CLIENT</span>, means that:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p>When initialised, the owning client entity will be carrying an
                                     exact copy of the properties as set on the base entity
                        </p>
                     </li>
                     <li>
                        <p>The inventory property will not exist neither in the cell
                                     entity nor in client Avatars not controlled by the owning
                                     player.
                        </p>
                     </li>
                     <li>
                        <p>Changes to the inventory property's value in the base will not
                                     be propagated to the client. The game logic must take care of
                                     keeping both copies synchronized as changes are made to the
                                     inventory.
                        </p>
                        <p>One example of such logic is an item being added to the
                                     inventory after being picked up by the player:
                        </p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p><em class="emphasis">After the pick up, the base adds the
                                                     item into the inventory and notifies the cell.</em></p>
                              </li>
                              <li>
                                 <p><em class="emphasis">The cell forwards the notification
                                                     to the client.</em></p>
                                 <div class="itemizedlist">
                                    <ul type="square">
                                       <li>
                                          <p><em class="emphasis">In
                                                                  <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/Avatar.py</span>:</em></p><pre class="programlisting">def pickUpResponse( self, success, droppedItemID, itemType ):
    ...
    itemsSerial = self.inventoryMgr.addItem( itemType )
    self.cell.pickUpResponse( True, droppedItemID, itemType, itemsSerial )
    ...</pre></li>
                                       <li>
                                          <p><em class="emphasis">In
                                                                  <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</span>:</em></p><pre class="programlisting">def pickUpResponse( self, success, droppedItemID, itemType, itemSerial ):
    ...
    self.client.pickUpResponse( True, droppedItemID, itemSerial )
    ...</pre></li>
                                    </ul>
                                 </div>
                              </li>
                              <li>
                                 <p><em class="emphasis">In the client, the Player replicates
                                                     the addition of the item into the inventory.</em></p>
                                 <div class="itemizedlist">
                                    <ul type="square">
                                       <li>
                                          <p><em class="emphasis">In
                                                                  <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class PlayerAvatar:
    ...
    def pickUpResponse( self, success, droppedItemID, itemSerial ):
        ...
        droppedItem = BigWorld.entities[ droppedItemID ]
        self._pickUpProcedure( droppedItem, itemSerial )
        ...
    
    def _pickUpProcedure( self, droppedItem, itemSerial ):
        ...
        itemType = droppedItem.classType
        self.inventoryMgr.addItem( itemType, itemSerial )
        ...</pre></li>
                                    </ul>
                                 </div>
                              </li>
                           </ul>
                        </div>
                     </li>
                  </ul>
               </div>
               <div class="sect2" lang="en">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e363"></a>2.4.1.&nbsp;Inventory Manager
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>In the sample implementation, the class
                             <span class="literal">InventoryMgr</span> encapsulates the logic of adding,
                             removing, selecting, locking, and trading items in the inventory. The
                             <span class="literal">InventoryMgr</span> is initialised with a reference to the
                             inventory holder entity. It looks for the inventory properties
                             (<span class="literal">inventoryItems</span>, <span class="literal">inventoryLocks</span>
                             and <span class="literal">inventoryGoldPieces</span>) in that entity.
                  </p>
                  <p>Only changes made to the entity&#8217;s properties (on the base) will
                             be written to the database. <span class="literal">InventoryMgr</span> member
                             variables will not persist, and should be treated as temporary. One
                             such variable is <span class="literal">_currentItemIndex</span>, which is not
                             considered a persistent property and is initialised to
                             <span class="literal">NOITEM</span> (-1) every time a new inventory is
                             instantiated.
                  </p>
                  <p>Adding and removing items to/from the inventory is just a matter
                             of appending and popping items into/from the
                             <span class="literal">inventoryItems</span> array, taking care of respecting
                             locking rules, if any, and internal consistency constraints, like
                             resetting the selected item, if it is the one being removed from
                             inventory.
                  </p>
                  <div class="itemizedlist">
                     <ul type="disc">
                        <li>
                           <p><em class="emphasis">In
                                             <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/Inventory.py</span>:</em></p><pre class="programlisting">NOLOCK = -1 
NOITEM = -1
...
def __init__( self, entity ):
    self._entity = weakref.proxy( entity )
    self._curItemIndex = NOITEM
    ...
    
def addItem( self, itemType ... ):
    ...
    if itemSerial is None:
        itemSerial = self._genItemSerial()
    entry = { "itemType": itemType, "serial": itemSerial, "lockHandle": NOLOCK }
    self._entity.inventoryItems.append( entry )
    ...
    return itemSerial

def removeItem( self, itemSerial ):
    index = self._itemSerial2Index( itemSerial ) # throws is serial not found
    entry = self._retrieveIfNotLocked( index )   # throws if item is locked
    try:
        item = inventory[ itemIndex ]
        inventory.pop( itemIndex )
    except IndexError:
        errorMsg = 'removeItem: invalid item index (idx=%d)'
        raise IndexError, errorMsg % itemIndex

    if self._curItemIndex == index:
        self._curItemIndex = -1
    elif self._curItemIndex &gt; index:
        self._curItemIndex -= 1
    ...
    return entry[ "itemType" ]</pre></li>
                     </ul>
                  </div>
                  <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
                     <h3 class="title">Note</h3>
                     <p>Instead of a straight reference, a <span class="literal">weakref</span>
                                  to the entity is kept to avoid creating a cyclic reference that will
                                  prevent the entity from being eventually deleted.
                     </p>
                  </div>
               </div>
               <div class="sect2" lang="en">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e417"></a>2.4.2.&nbsp;Serial Numbers
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>Note that in the sample implementation items are not referenced
                             by their index inside the <span class="literal">inventoryItems</span> array.
                             Instead, they are assigned a serial number when added to the
                             inventory, and are referenced by that serial throughout all their life
                             inside it.
                  </p>
                  <p>The reason for this is to allow simultaneously changes to the
                             inventory from multiple sources (<em class="emphasis">e.g.</em>, game
                             client, web interface, mobile device). In this case, if direct indices
                             are used, references to items can become obsolete while a request is
                             still being processed.
                  </p>
                  <p>In the example, serial numbers are not attached to the item
                             itself, but to their existence in an inventory, that is, serial
                             numbers are guaranteed to be unique only within a single inventory.
                             Two inventories can contain items with serial numbers duplicated
                             between them.
                  </p>
                  <p>A more comprehensive items systems can use a global serial
                             number generator and have them assigned to items when they are first
                             created. This serial numbers can then be used throughout all game
                             subsystems to uniquely refer to items, to track duplicated items,
                             etc.
                  </p>
                  <p>When using serial numbers it is important to have a single
                             authoritative copy of the inventory generating the serials for each
                             item, otherwise serial numbers can become inconsistent between
                             instances of the same inventory. When adding an item to the
                             non-authoritative copy of the inventory, its assigned serial number
                             must be provided along with the item.
                  </p>
                  <div class="itemizedlist">
                     <ul type="disc">
                        <li>
                           <p><em class="emphasis">In
                                             <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/Inventory.py</span>:</em></p><pre class="programlisting">def addItem( self, itemType, itemSerial = None ):
    ...
    entry = { "itemType": itemType, "serial": itemSerial, "lockHandle": NOLOCK }
    self._entity.inventoryItems.append( entry )
    ...
    return itemSerial</pre></li>
                     </ul>
                  </div>
               </div>
            </div>
            <div class="sect1" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Dropping_And_Picking_Items_Up"></a>2.5.&nbsp;Dropping and picking items up
                        </h2>
                     </div>
                  </div>
               </div>
               <p>As mentioned above, the items can usually be represented as a
                        property of an <em class="emphasis">entity</em> (or an entry into an array
                        property). However, there is one case where this is not sufficient, and
                        the item needs to be an <em class="emphasis">entity</em>.
               </p>
               <p>This is the case of an item that has been dropped on the ground.
                        The reason for this is that if you walk away from an item that you
                        dropped, other people still need to see it.
               </p>
               <p>If the item was just a property of a player, then when the player
                        left the <em class="emphasis">area of interest</em> (which is usually about
                        500m), the property would disappear as well, and so would the dropped
                        item.
               </p>
               <p>On the other hand, if the dropped item itself is an entity, then
                        other players will see it, as long as it is in their <em class="emphasis">area of
                           interest</em>.
               </p>
               <p>Making a dropped item an entity means that you can write
                        interaction scripts just like any other entity in the world. You can
                        target it, shoot it, pick it up, etc...
               </p>
               <p>The process of dropping and picking items up should be something
                        similar to the steps described below.
               </p>
               <div class="sect2" lang="en">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="xref_Dropping_An_Item_On_The_Ground"></a>2.5.1.&nbsp;Dropping an item on the ground
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>Initially, the item is in the player&#8217;s inventory, expressed as
                             an entry in the <em class="emphasis">inventoryItems</em> property, the
                             <span class="literal">itemType</span> field in the entry holds the
                             <em class="emphasis">item type ID</em>.
                  </p>
                  <p>A game would follow the steps described below for an item
                             drop:
                  </p>
                  <div class="orderedlist">
                     <ol type="1">
                        <li>
                           <p>Player uses the user interface to drop an item.</p>
                        </li>
                        <li>
                           <p>Because the item may be unavailable in the server
                                          (<em class="emphasis">e.g.</em>, in case it has just been locked in the
                                          inventory from a web interface to the trading system), the client
                                          Avatar makes the drop item requests to the base. If the player can
                                          drop the item, the base removes the item from the inventory and
                                          notifies the cell about the dropped item:
                           </p>
                           <div class="itemizedlist">
                              <ul type="disc">
                                 <li>
                                    <p><em class="emphasis">In </em><em class="emphasis"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class PlayerAvatar:
    ...
    def dropOnline( self ):
        ...
        self.base.dropRequest( itemSerial )</pre></li>
                                 <li>
                                    <p><em class="emphasis">In
                                                          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/Avatar.py</span>:</em></p><pre class="programlisting">def dropRequest( self, itemSerial ):
    ...
    itemType = self.inventoryMgr.removeItem( itemIndex )
    self.cell.dropNotify( True, itemType )
    ...</pre></li>
                              </ul>
                           </div>
                        </li>
                        <li>
                           <p>The cell creates a <span class="literal">DroppedItem</span> entity
                                          that matches the item dropped by the player:
                           </p>
                           <div class="itemizedlist">
                              <ul type="disc">
                                 <li>
                                    <p><em class="emphasis">In
                                                          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</span>:</em></p><pre class="programlisting">def dropNotify( self, success, itemType ):
    ...
    BigWorld.createEntity( "DroppedItem", ... )
    ...
    self.rightHand = ItemBase.ItemBase.NONE_TYPE</pre></li>
                              </ul>
                           </div>
                        </li>
                        <li>
                           <p>The server informs all clients within the <em class="emphasis">area of
                                             interest</em> that a <span class="literal">DroppedItem</span> has been
                                          created (via Python's function
                                          <span class="literal">Bigworld.createEntity</span>).
                           </p>
                        </li>
                        <li>
                           <p>The confirmation to the Avatar for his drop request comes
                                          from the <span class="literal">DroppedItem</span> itself. The client then
                                          plays the drop animation and removes the item from player&#8217;s right
                                          hand (for simplicity, the code that synchronizes the drop
                                          animations, the item model being removed from the avatar&#8217;s right
                                          hand and reappearing on the ground is not shown here):
                           </p>
                           <div class="itemizedlist">
                              <ul type="disc">
                                 <li>
                                    <p><em class="emphasis">In
                                                          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/DroppedItem.py</span>:</em></p><pre class="programlisting">def enterWorld( self ):
    ...
    dropper = BigWorld.entities[ self.dropperID ]
    dropper.dropNotify( self ) 
    ...</pre></li>
                                 <li>
                                    <p><em class="emphasis">In
                                                          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class Avatar:
    ...
    def dropNotify( self, droppedItem ):
        ...
        self._dropProcedure( droppedItem )

    def _dropProcedure( self, droppedItem ):
        ...
        droppedItem.dropComplete()
        ...</pre></li>
                              </ul>
                           </div>
                        </li>
                        <li>
                           <p>All clients now draw the correct model for the
                                          <span class="literal">DroppedItem</span> entity on the ground:
                           </p>
                           <div class="itemizedlist">
                              <ul type="disc">
                                 <li>
                                    <p><em class="emphasis">In
                                                          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/DroppedItem.py</span>:</em></p><pre class="programlisting">class DroppedItem( BigWorld.Entity ):
    ...
    def dropComplete( self ):
        ...
        self._showModel()

    def _showModel ( self ): 
        ...
        self.model = self.item.model</pre></li>
                              </ul>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
               <div class="sect2" lang="en">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e602"></a>2.5.2.&nbsp;Picking an item up from the ground
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>Initially, the item is a <span class="literal">DroppedItem</span> entity
                             lying on the ground, as described in <a href="ch02.html#xref_Dropping_An_Item_On_The_Ground" title="2.5.1.&nbsp;Dropping an item on the ground">Dropping an item on the ground</a>.
                  </p>
                  <p>A game would follow the steps described below for picking up an
                             item:
                  </p>
                  <div class="orderedlist">
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In
                                                <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class PlayerAvatar:
    ...
    def pickExecute( self, droppedItem ):
        ...
        self.cell.pickUpRequest( droppedItem.id )
        ...</pre></li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In
                                                <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</span>:</em></p><pre class="programlisting">def pickUpRequest( self, sourceID, droppedItemID ):
    ...
    item = BigWorld.entities[ droppedItemID ]
    item.pickUpRequest( self.id )
    ...</pre></li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In </em><em class="emphasis"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/DroppedItem.py</span>:</em></p><pre class="programlisting">def pickUpRequest( self, whomID ):
    ...
    if self.pickerID == 0:
        picker = BigWorld.entities[ whomID ]
        picker.base.pickUpResponse( True, self.id, self.classType )
        self.addTimer( 5, 0, DroppedItem.DESTROY_TIMER )
        self.pickerID = whomID
    ...</pre></li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In
                                                <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/Avatar.py</span>:</em></p><pre class="programlisting">def pickUpResponse( self, success, droppedItemID, itemType ):
    if success:
        itemsSerial = self.inventoryMgr.addItem( itemType )
        self.cell.pickUpResponse( True, droppedItemID, itemType, itemsSerial )
    ...</pre></li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In
                                                <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</span>:</em></p><pre class="programlisting">def pickUpResponse( self, success, droppedItemID, itemType, itemSerial ):
    if success:
        # sucess:notify all clients this entity base
        self.client.pickUpResponse( True, droppedItemID, itemSerial )
        self.otherClients.pickUpNotify( droppedItemID )
        self.rightHand = itemType
    ...</pre></li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In
                                                <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class Avatar:
    ...
    def pickUpNotify( self, droppedItemID ):
        ...
        droppedItem = BigWorld.entities[ droppedItemID ]
        self._pickUpProcedure( droppedItem )
        ...

class PlayerAvatar
    ...
    def pickUpResponse( self, success, droppedItemID, itemSerial ):
        ...
        droppedItem = BigWorld.entities[ droppedItemId ]
        self._pickUpProcedure( droppedItem, itemSerial )
        ...</pre></li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In
                                                <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>:</em></p><pre class="programlisting">class PlayerAvatar:
    ...
    def pickUpFinish( self, droppedItem ):
        ...
        itemType  = droppedItem.classType
        self.inventoryMgr.addItem( itemType, itemSerial )
        self.inventoryMgr.selectItem( itemSerial )
        ...</pre></li>
                        </ul>
                     </div>
                     <div class="itemizedlist">
                        <ul type="bullet">
                           <li style="list-style-type: disc">
                              <p><em class="emphasis">In
                                                <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/DroppedItem.py</span>:</em></p><pre class="programlisting">def pickUpRequest( self, whomID ):
    ...
    self.addTimer( 5, 0, DroppedItem.DESTROY_TIMER )

def onTimer( self, timerId, userId ):
    ...
    if ( userId == DroppedItem.DESTROY_TIMER ):
        self.destroy()</pre></li>
                        </ul>
                     </div>
                     <ol type="1">
                        <li>
                           <p>Client requests to pick item up.</p>
                        </li>
                        <li>
                           <p>The item locks itself as being picked up by the requesting
                                          Avatar. Further requests for pickup will be denied by the server.
                                          The item also notifies the requester base about the pickup so that
                                          the item is added to the player inventory. Finally, the item sets
                                          a timer to remove itself from the world.
                           </p>
                        </li>
                        <li>
                           <p>The cell notifies all clients about the pick up and updates
                                          the avatar&#8217;s right hand property.
                           </p>
                        </li>
                        <li>
                           <p>All clients are notified that the Avatar is picking up the
                                          item. A picking item up animation is started on the Avatar&#8217;s
                                          model. Note that, although other clients will see the item model
                                          in the player hands as a consequence of
                                          <span class="literal">rightHand</span> being set in the server, the
                                          <span class="literal">PlayerAvatar</span> will not have its
                                          <span class="literal">rightHand</span> property updated and must explicitly
                                          equip the item (remember that <span class="literal">rightHand</span> is
                                          flagged <span class="literal">OTHER_CLIENTS</span>).
                           </p>
                        </li>
                        <li>
                           <p>The Player adds the picked item into his inventory and
                                          selects it.
                           </p>
                        </li>
                        <li>
                           <p>On the base, the timer goes out and the
                                          <span class="literal">DroppedItem</span> entity destroys itself.
                           </p>
                        </li>
                        <li>
                           <p>The item has been added to the player inventory in both the
                                          client and the server. All clients draw the item in player&#8217;s right
                                          hand. The dropped item has been removed from the server.
                           </p>
                        </li>
                     </ol>
                  </div>
               </div>
            </div>
            <div class="sect1" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Locking_Inventory_Items"></a>2.6.&nbsp;Locking inventory items
                        </h2>
                     </div>
                  </div>
               </div>
               <p>If the game design calls for some sort of asynchronous
                        transactions to be carried out with inventory items, it will be
                        necessary to implement locking of items inside the inventory.
               </p>
               <p>During asynchronous transactions, like those taking place over a
                        mobile device or web interface, a player may offer one or more items for
                        trading. A second player may, at his own time, inspect the items being
                        offered and in turn reply the offer with one or more of his items. When
                        the first player inspects and accepts the items in the reply offer, the
                        transaction can be carried out.
               </p>
               <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
                  <h3 class="title">Note</h3>
                  <p>Although this is not a requirement for asynchronous
                             transactions, locking also offers a way to reference a set of items
                             (and maybe also some amount of currency) using a convenient single
                             handle.
                  </p>
               </div>
               <p>From first offer to final acceptance, a finite amount of time will
                        have passed, from a couple of seconds to several hours or even days.
                        Problems will occur if the items initially offered are no longer
                        available when both parties accept the transaction (if, for example, one
                        of the players drops, consumes or trades with a third player any of the
                        offered items).
               </p>
               <p>One approach to avoid the problem is to lock the items inside the
                        inventory once they have been committed to a trade offer. Locked items
                        should not be available for dropping, offering on a second trade nor
                        equipping (thus consuming). The player should be free to unlock the
                        items at any time. Unlocking an item should invalidate the trade
                        associated with it.
               </p>
               <p>In the sample implementation, items are flagged as locked by
                        assigning a valid lock handle to the <span class="literal">lockHandle</span> field
                        in the item&#8217;s entry in the <span class="literal">inventoryItems</span> array. Some
                        amount of gold pieces can also be locked together with the set of items.
                        The gold information is stored in the <span class="literal">inventoryLocks</span>
                        array. Locking items and gold pieces yields a lock handle. This lock
                        handle can than be used to reference the locked lot, either to unlock it
                        or to trade it for gold, other items or a combination of both.
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><em class="emphasis">In </em><em class="emphasis"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/Inventory.py</span>:</em></p><pre class="programlisting">NOLOCK = -1
...
def itemsLock( self, itemsSerials, goldPieces ):
    lockHandle = self._getNextLockHandle()
    self.itemsRelock( lockHandle, itemsSerials, goldPieces )
    return lockHandle

def itemsRelock( self, lockHandle, itemsSerials, goldPieces ):
    ...
    itemsIndexes = []
    for serial in itemsSerials:
        index = self._itemSerial2Index( serial )
        if self._entity.inventoryItems[ index ][ "lockHandle" ] != NOLOCK:
            errorMsg = 'Item item already locked (idx=%d)' 
            raise LockError, errorMsg % index
        itemsIndexes.append( index )

    for index in itemsIndexes:
        self._entity.inventoryItems[ index ][ "lockHandle" ] = lockHandle

    lockedEntry = { "lockHandle": lockHandle, "goldPieces": goldPieces }
    self._entity.inventoryLockedItems.append( lockedEntry )
...
def itemsUnlock( self, lockHandle ):
    index = self._getLockedItemsIndex( lockHandle )
    lockedEntry = self._entity.inventoryLockedItems[ index ]
    self._entity.inventoryLockedItems.pop( index )
    for entry in self._entity.inventoryItems:
        if entry[ "lockHandle" ] == lockHandle:
            entry[ "lockHandle" ] = NOLOCK</pre></li>
                  </ul>
               </div>
            </div>
         </div>
         <div class="navfooter">
            <hr class="navheaderline">
            <table width="95%" align="center" summary="Navigation footer">
               <tr>
                  <td width="38%" align="left"><a accesskey="p" href="ch01.html">Prev</a>&nbsp;
                  </td>
                  <td width="20%" align="center">&nbsp;</td>
                  <td width="37%" align="right">&nbsp;<a accesskey="n" href="ch03.html">Next</a></td>
               </tr>
               <tr>
                  <td width="40%" align="left" valign="top">Chapter&nbsp;1.&nbsp;Introduction&nbsp;</td>
                  <td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
                  <td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;3.&nbsp;Trading</td>
               </tr>
               <tr>
                  <td colspan="3">Copyright 1999-2008 BigWorld Pty. Ltd. All rights reserved. Proprietary commercial in confidence.
                     		   
                  </td>
               </tr>
            </table>
         </div>
      </div>
   </body>
</html>