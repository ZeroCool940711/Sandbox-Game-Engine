<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   
      <title>Chapter&nbsp;3.&nbsp;BigWorld Python Scripting Layer</title>
      <link rel="stylesheet" href="../css/bigworld.css" type="text/css">
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0">
      <link rel="start" href="index.html" title="How To Implement Web Integration">
      <link rel="up" href="index.html" title="How To Implement Web Integration">
      <link rel="prev" href="ch02.html" title="Chapter&nbsp;2.&nbsp;Use Cases">
      <link rel="next" href="ch04.html" title="Chapter&nbsp;4.&nbsp;PHP Presentation Layer"><script type="text/javascript" src="../css/bigworld.js"></script></head>
   <body onLoad="loader();">
      <div id="bigworld-header"><img src="bigworld_logo.gif" id="bwLogo" alt="bw logo"></div>
      <div id="content">
         <div class="navheader">
            <table width="95%" align="center" summary="Navigation header">
               <tr>
                  <th colspan="3" align="center">Chapter&nbsp;3.&nbsp;BigWorld Python Scripting Layer</th>
               </tr>
               <tr>
                  <td width="20%" align="left"><a accesskey="p" href="ch02.html">Prev</a>&nbsp;
                  </td>
                  <th width="55%" align="center">&nbsp;</th>
                  <td width="20%" align="right">&nbsp;<a accesskey="n" href="ch04.html">Next</a></td>
               </tr>
            </table>
            <hr class="navheaderline">
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title"><a name="d0e167"></a>Chapter&nbsp;3.&nbsp;BigWorld Python Scripting Layer
                     </h2>
                  </div>
               </div>
            </div>
            <div class="toc">
               <p><b>Table of Contents</b></p>
               <dl>
                  <dt><span class="section"><a href="ch03.html#d0e210">3.1. Item and inventory system</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#xref_Retrieving_Real_Time_Player_Data">3.2. Retrieving real-time player data</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#xref_Auction_House_Data_Types_Persistence_And_Aliases">3.3. Auction house data types, persistence and aliases</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#d0e393">3.4. Auction life cycle and logic</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#d0e606">3.5. Web method conventions</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#d0e636">3.6. Callbacks</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#xref_The_Auction_House_Abstraction">3.7. The Auction House abstraction</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#xref_Searching_And_Search_Criteria">3.8. Searching and search criteria</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#d0e905">3.9. <code class="classname">Avatar</code> entity</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#d0e1076">3.10. <code class="classname">AuctionHouse</code> entity</a></span></dt>
                  <dt><span class="section"><a href="ch03.html#d0e1240">3.11. <code class="classname">TradingSupervisor</code> entity</a></span></dt>
               </dl>
            </div>
            <p>There are three entity types that are involved in an auction
                   transaction:
            </p>
            <div class="itemizedlist">
               <ul type="disc">
                  <li>
                     <p>The player <code class="classname">Avatar</code>.
                     </p>
                  </li>
                  <li>
                     <p>The <code class="classname">AuctionHouse</code> entity.
                     </p>
                  </li>
                  <li>
                     <p>The <code class="classname">TradingSupervisor</code>.
                     </p>
                  </li>
               </ul>
            </div>
            <p>For details on how to implement safe atomic trading transactions
                   between two entities instantaneously, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">How To Implement Items
                      And Trading</a>.
            </p>
            <p>The Auction House example code can be traced by following the
                   <code class="classname">AuctionHouseCommon</code> debug output &#8212; if the
                   <code class="varname">AuctionHouseCommon.DEBUG</code> module attribute is set to
                   <span class="literal">True</span>, then those statements are output to the BaseApp
                   console. You can set this by editing the
                   <code class="filename">fantasydemo/res/scripts/common/AuctionHouseCommon.py</code>
                   Python module file.
            </p>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e210"></a>3.1.&nbsp;Item and inventory system
                        </h2>
                     </div>
                  </div>
               </div>
               <p>In FantasyDemo, items have a numerical item type and an
                        entity-wide serial number (<em class="emphasis">i.e.</em> the serial number
                        is specific to that entity), and can be locked under a lock handle. For
                        details on how items are implemented in FantasyDemo, see the document
                        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">How To Implement
                           Items And Trading</a>.
               </p>
               <p>In FantasyDemo, when an item is locked, it is un-equipped on the
                        cell if the player cell entity exists and it has that item equipped, and
                        it cannot be used by the client entity until unlocked. Gold pieces can
                        also be locked in conjunction with a set of items.
               </p>
               <p>The example code for the Auction House system is loosely tied to
                        this scheme. Items are passed loosely as Python tuples, and appropriate
                        callbacks and hooks are used that can be replaced. With relatively minor
                        modifications, developers can use the example code to provide their own
                        inventory system, and use the item locking hook to do any
                        pre-transactional checks and actions.
               </p>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Retrieving_Real_Time_Player_Data"></a>3.2.&nbsp;Retrieving real-time player data
                        </h2>
                     </div>
                  </div>
               </div>
               <p>In FantasyDemo, there are two scenarios when a player log on to
                        the web interface: either they have a cell entity, they are running
                        around the world, or they are not instantiated on any cell, and only the
                        Base entity exists on the server.
               </p>
               <p>In FantasyDemo, the cell data that we expose to the web interface
                        consists of:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p>The player's name.</p>
                     </li>
                     <li>
                        <p>The player's health and maximum health.</p>
                     </li>
                     <li>
                        <p>The frags, or the number of kills made by the player.</p>
                     </li>
                     <li>
                        <p>Position vector and direction vector of the player.</p>
                     </li>
                  </ul>
               </div>
               <p>When there is no cell entity present, the values of the player
                        name health, maximum health, and frags exist in a dictionary on the base
                        called <span class="literal">cellData</span>. However, when there is a cell entity
                        present, the values are required to be queried from the cell &#8212; via the
                        <code class="methodname">Avatar.getPlayerInfoBaseRequest()</code> cell method
                        and the <code class="methodname">Avatar.onPlayerInfo()</code> callback method
                        on the base.
               </p>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Auction_House_Data_Types_Persistence_And_Aliases"></a>3.3.&nbsp;Auction house data types, persistence and aliases
                        </h2>
                     </div>
                  </div>
               </div>
               <p>There are some data type aliases specific to the Auction House
                        system which are defined in
                        <code class="filename">fantasydemo/res/scripts/entity_defs/alias.xml</code>:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><span class="literal">AUCTIONID</span></p>
                     </li>
                     <li>
                        <p><span class="literal">AUCTIONEXPIRY</span></p>
                     </li>
                     <li>
                        <p><span class="literal">AUCTIONBIDDER</span></p>
                     </li>
                     <li>
                        <p><span class="literal">AUCTIONBIDDERS</span></p>
                     </li>
                     <li>
                        <p><span class="literal">AUCTION</span></p>
                     </li>
                     <li>
                        <p><span class="literal">AUCTIONMAPPING</span></p>
                     </li>
                     <li>
                        <p><span class="literal">AUCTIONS</span></p>
                     </li>
                     <li>
                        <p><span class="literal">AUCTIONINFO</span></p>
                     </li>
                  </ul>
               </div>
               <p>For details on the entity definitions alias file and advanced
                        persistence of user-defined data types, see the document the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Server Programming
                           Guide</a> 's section the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Alias of Data Types</a>.
               </p>
               <p>Notice that the <code class="code">AUCTIONID</code> data type is aliased to a
                        <code class="code">STRING</code>. In the example code, the <code class="code">AUCTIONID</code> is
                        comprised of the following string format:
               </p><pre class="programlisting"><em class="replaceable"><code>&lt;player entity database ID&gt;</code></em>/<em class="replaceable"><code>&lt;BigWorld game time&gt;</code></em></pre><p>For example:</p><pre class="programlisting">432/456.23</pre><p><code class="classname">IncrementalAuction</code> objects are defined in
                        Python in the <code class="classname">AuctionHouseCommon</code> module, and are
                        database-persistent. The corresponding <span class="literal">AUCTION</span> data
                        type is aliased to a class-customised <span class="literal">FIXED_DICT</span>
                        type; the Python scripts for streaming and de-streaming
                        <code class="classname">Auction</code> objects to and from the database are in
                        the <code class="classname">AuctionDataTypes</code> module located in
                        <code class="filename">fantasydemo/res/common</code>, in the class
                        <code class="classname">AuctionDataType</code>.
               </p>
               <p>Items in <code class="classname">IncrementalAuction</code> are represented
                        as a 3-tuple, as displayed below:
               </p><pre class="programlisting">( lockHandle, itemType, itemSerial )</pre><p>There also exists a collections data type for holding a map of
                        auction IDs to auction objects. This is the type of the auctions base
                        property on the <code class="classname">AuctionHouse</code> entity that holds
                        all auctions specific to that auction house.
               </p>
               <p>The <span class="literal">AUCTIONS</span> data type manifests itself as a
                        dictionary from auction IDs to <code class="classname">IncrementalAuction</code>
                        objects to the Python scripts. The corresponding
                        <span class="literal">AUCTIONS</span> entity data type is aliased to a
                        class-customised <span class="literal">FIXED_DICT</span> implemented by a class in
                        the <code class="classname">AuctionDataTypes</code> module, in the class
                        <span class="literal"><code class="classname">AuctionsDataType</code></span>. It consists
                        of an array of <span class="literal">AUCTIONMAPPING</span>, which is aliased to an
                        non-customised <span class="literal">FIXED_DICT</span> data type with auction ID
                        and auction object properties. These alias definitions are present in
                        <code class="filename">fantasydemo/res/scripts/entity_defs/alias.xml</code>.
               </p>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e393"></a>3.4.&nbsp;Auction life cycle and logic
                        </h2>
                     </div>
                  </div>
               </div>
               <p>The life cycle of an auction follows the steps described
                        below:
               </p>
               <div class="orderedlist">
                  <ol type="1">
                     <li>
                        <p>Auctions are created by player <code class="classname">Avatar</code>
                                     entities by passing to
                                     <code class="methodname">Avatar.webCreateAuction()</code> the serial number
                                     of the item that they wish to sell along with the auction
                                     parameters, such as expiry, the start bid price, and the optional
                                     buyout price.
                        </p>
                        <p>The player <code class="classname">Avatar</code> entity locks the item
                                     and receives a lock handle.
                        </p>
                     </li>
                     <li>
                        <p>The player <code class="classname">Avatar</code> entity makes a
                                     request to the <code class="classname">AuctionHouse</code> entity via
                                     <code class="methodname">AuctionHouse.createAuction()</code> to create an
                                     auction with the item's type, serial and lock handle in a 3-tuple,
                                     and the auction parameters.
                        </p>
                        <p>The <code class="classname">Avatar</code> entity also supplies itself
                                     as a mailbox so that it can be called back on when the auction has
                                     been registered, or if there was an error &#8212; in case of error, the
                                     <code class="classname">Avatar</code> entity can unlock the item.
                        </p>
                     </li>
                     <li>
                        <p>The <code class="classname">AuctionHouse</code> entity registers the
                                     new auction, and makes it available for searching by other players
                                     by adding it to its <code class="varname">AuctionHouse.auctions</code>
                                     collection member property.
                        </p>
                        <p>It also sets the auction's expiry time to after the specified
                                     expiry period after the current
                                     <code class="methodname">BigWorld.time()</code>, then writes itself to the
                                     database.
                        </p>
                     </li>
                     <li>
                        <p>Other players can search for auctions by creating criteria
                                     (for details, see <a href="ch03.html#xref_Searching_And_Search_Criteria" title="3.8.&nbsp;Searching and search criteria">Searching and search criteria</a>) and applying them
                                     to <code class="methodname">AuctionHouse.webSearchAuctions()</code>, which
                                     returns an array of auction IDs, rather than auction descriptors
                                     (which are returned by
                                     <code class="methodname">AuctionHouse.webGetAuctionInfo()</code>).
                        </p>
                        <p>This is to support implementations of paging through search
                                     results on the web interface.
                        </p>
                     </li>
                     <li>
                        <p>The bidder <code class="classname">Avatar</code> entity locks the
                                     maximum bid amount once a bidder player has selected an auction and
                                     has bid on it through the web interface (via
                                     <code class="methodname">Avatar.webBidOnAuction()</code>, by supplying the
                                     auction ID and the maximum bid amount). If this fails due to
                                     insufficient funds:
                        </p>
                        <div class="itemizedlist">
                           <ul type="disc">
                              <li>
                                 <p>Control is returned to the web scripting layer.</p>
                              </li>
                              <li>
                                 <p>The bidding player is notified of failure due to
                                                  insufficient funds.
                                 </p>
                              </li>
                              <li>
                                 <p>No further action or change is taken.</p>
                              </li>
                           </ul>
                        </div>
                     </li>
                     <li>
                        <p>If the bid is successful, the lock handle is passed to the
                                     <code class="classname">AuctionHouse</code> entity through the
                                     <code class="methodname">AuctionHouse.bidOnAuction()</code> method to
                                     register the bid with the auction ID, bidder player mailbox, and the
                                     bidder's maximum bid amount lock handle.
                        </p>
                     </li>
                     <li>
                        <p>If the auction has no current bidder, then the bidder entity
                                     becomes the new highest bidder, and the bidding price is incremented
                                     once. Otherwise, in the case of a bidder bidding against an existing
                                     highest bidder, the auction bidding is done incrementally up to the
                                     minimum of the maximum bids of the two competing bidders.
                        </p>
                     </li>
                     <li>
                        <p>If the bid is successful, then this bidder becomes the new
                                     highest bidder, and the bid price may increment up to the amount of
                                     the maximum bid before this bidder becomes outbid.
                        </p>
                        <p>If this bidder outbids another bidder, then that bidder's
                                     entity is found, and has the method
                                     <code class="methodname">Avatar.onAuctionOutbid()</code> called on it to
                                     notify that <code class="classname">Avatar</code> entity that it has been
                                     outbid, which unlocks their maximum bid's lock handle, effectively
                                     returning the gold back to the outbid bidder player.
                        </p>
                        <p>Otherwise, if the bid has failed, then the contesting bidder
                                     has <code class="methodname">Avatar.onAuctionOutbid()</code> called on its
                                     entity, which unlocks the lock handle to return the gold back to the
                                     contesting bidder player.
                        </p>
                     </li>
                     <li>
                        <p>Auctions are checked periodically with a BigWorld timer that
                                     is set through <code class="methodname">Base.addTimer()</code> every
                                     <code class="varname">AuctionHouse.AUCTION_CHECK_PERIOD</code> (a Python
                                     module-level property) seconds.
                        </p>
                        <p>When an auction expires:</p>
                        <div class="orderedlist">
                           <ol type="A">
                              <li>
                                 <p>If, at the time of expiry, it does not have a bidder
                                                  registered:
                                 </p>
                                 <div class="itemizedlist">
                                    <ul type="disc">
                                       <li>
                                          <p>The auction is considered expired and is
                                                               removed.
                                          </p>
                                       </li>
                                       <li>
                                          <p>The seller entity has
                                                               <code class="methodname">Avatar.onAuctionExpired()</code> called
                                                               back on.
                                          </p>
                                       </li>
                                       <li>
                                          <p>The item is unlocked.</p>
                                       </li>
                                    </ul>
                                 </div>
                              </li>
                              <li>
                                 <p>If it has a bidder at the time of expiry:</p>
                                 <div class="itemizedlist">
                                    <ul type="disc">
                                       <li>
                                          <p>The auction is won by the current bidder.</p>
                                       </li>
                                       <li>
                                          <p>The item locked by the seller must be exchanged by the
                                                               amount of gold pieces that the auction has been won at. This
                                                               can be lower than the maximum bid amount entered by the
                                                               highest bidder, and so there is a mechanism to relock a
                                                               lower amount of gold in order to complete the auction
                                                               transaction.
                                          </p>
                                          <p>The <code class="methodname">Avatar.lockAuctionGold()</code>
                                                               accomplishes this by being passed from the
                                                               <code class="classname">AuctionHouse</code> entity:
                                          </p>
                                          <div class="itemizedlist">
                                             <ul type="circle">
                                                <li>
                                                   <p>The auction ID.</p>
                                                </li>
                                                <li>
                                                   <p>The actual amount of gold pieces that the auction
                                                                            was won at.
                                                   </p>
                                                </li>
                                                <li>
                                                   <p>The pre-existing lock handle for the maximum bid
                                                                            amount, in gold pieces.
                                                   </p>
                                                </li>
                                             </ul>
                                          </div>
                                       </li>
                                       <li>
                                          <p>This causes the old lock on the maximum bid amount to
                                                               be unlocked, and since the actual amount that the auction
                                                               expired at is always less than or equal to the maximum bid
                                                               amount, this is guaranteed to succeed.
                                          </p>
                                          <p>This auction bid amount at expiry is relocked, and is
                                                               passed back to the <code class="classname">AuctionHouse</code>
                                                               entity through its
                                                               <code class="methodname">AuctionHouse.completeAuction()</code>
                                                               method, along with this player's mailbox and the auction
                                                               ID.
                                          </p>
                                       </li>
                                       <li>
                                          <p>The <code class="classname">AuctionHouse</code> entity locates
                                                               the seller entity and the bidder entity for exchanging
                                                               locked items.
                                          </p>
                                          <p>The actual exchange is carried out by re-using
                                                               functionality from the FantasyDemo
                                                               <code class="classname">TradingSupervisor</code> entity, which
                                                               handles atomic exchanges between two
                                                               <code class="classname">Avatar</code> entities and locks on items
                                                               held by the respective entities (for details on how the
                                                               <code class="classname">TradingSupervisor</code> exchanges items,
                                                               see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">How To
                                                                  Implement Items And Trading</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Trading</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Trading
                                                                  Supervisor</a>).
                                          </p>
                                       </li>
                                       <li>
                                          <p>The auction is removed.</p>
                                       </li>
                                    </ul>
                                 </div>
                              </li>
                           </ol>
                        </div>
                     </li>
                  </ol>
               </div>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e606"></a>3.5.&nbsp;Web method conventions
                        </h2>
                     </div>
                  </div>
               </div>
               <p>The convention used in the base entity scripts for implementing
                        web methods is to prefix each method by the string
                        <span class="literal">web</span> (for example,
                        <code class="methodname">webGetPlayerInfo()</code>). Please note that this is
                        only a convention used in our example code, and it is not a
                        requirement.
               </p>
               <p>Many of the web return-value methods also have return values for
                        returning the status of the operation back to the web scripting
                        layer:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><em class="parameter"><code>success</code></em>::<span class="type">BOOL</span> &#8212; Whether
                                     the operation succeeded.
                        </p>
                     </li>
                     <li>
                        <p><em class="parameter"><code>errMsg</code></em>::<span class="type">STRING</span> &#8212; Error
                                     message string, describing the reason for the failure.
                        </p>
                     </li>
                  </ul>
               </div>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e636"></a>3.6.&nbsp;Callbacks
                        </h2>
                     </div>
                  </div>
               </div>
               <p>There are some callback methods that are invoked by the
                        <code class="classname">AuctionHouse</code> entity to the
                        <code class="classname">Avatar</code> entity in response to
                        <code class="classname">AuctionHouse</code> requests, for creating auctions,
                        bidding on, and buying out auctions.
               </p>
               <p>In the <code class="classname">Avatar</code> entity scripts, there is a
                        Python property set at <code class="methodname">__init__()</code> time called
                        <code class="varname">tradingCallbacks</code>. This is a map of callback names to
                        maps of unique identifiers (depending on what kind of call it is) to
                        callbacks implemented by <code class="classname">functools.partial</code> instances and
                        arguments. This is partly to avoid sending unnecessary context across to
                        the <code class="classname">AuctionHouse</code> entity by preserving it in the
                        memory space of the <code class="classname">Avatar</code> entity and have that
                        context restored when the <code class="classname">AuctionHouse</code> calls
                        back. The <code class="classname">Avatar</code> entity de-multiplexes on these
                        callbacks based on a unique key for that set of transactions.
               </p>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_The_Auction_House_Abstraction"></a>3.7.&nbsp;The Auction House abstraction
                        </h2>
                     </div>
                  </div>
               </div>
               <p>In the <span class="package">AuctionHouseCommon</span> module, there are
                        some non-BigWorld-specific helper classes that are intended to be
                        sub-classed and functionality to be overwritten. These classes cover the
                        underlying logic of auctions and auction houses, but are not tied to any
                        persistence mechanism. There is a sample of an
                        <code class="classname">InMemoryAuctionHouse</code>, which maintains lists of
                        auctions in memory. Different auction types can be added. Different
                        buyers and seller objects can be used, as long as they adhere to the
                        protocol.
               </p>
               <p>The abstraction consists of:</p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="classname">AbstractAuctionHouse</code></p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p>Handles requests for searching auctions.</p>
                              </li>
                              <li>
                                 <p>Auction administration and persistence.</p>
                              </li>
                           </ul>
                        </div>
                     </li>
                     <li>
                        <p><code class="classname">Auction</code></p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p>Handles the auction mechanics of bidding.</p>
                              </li>
                              <li>
                                 <p>Holds a reference to the seller interface instance.</p>
                              </li>
                              <li>
                                 <p>Holds a reference to the item object.</p>
                              </li>
                              <li>
                                 <p>Holds a reference to the bidder interface instance, if one
                                                  exists.
                                 </p>
                              </li>
                              <li>
                                 <p>Holds a reference to the auction house object.</p>
                              </li>
                              <li>
                                 <p>Holds the auction data, such as expiry, bidding price,
                                                  etc.
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </li>
                     <li>
                        <p><code class="classname">Seller</code></p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p>Auction seller interface.</p>
                              </li>
                              <li>
                                 <p>Hook for client code to receive auction house events for
                                                  sellers.
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </li>
                     <li>
                        <p><code class="classname">Bidder</code></p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p>Auction bidder interface.</p>
                              </li>
                              <li>
                                 <p>Hook for client code to receive auction house events for
                                                  bidders.
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </li>
                     <li>
                        <p><code class="classname">AuctionSearchCriteria</code></p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p>Definition of the protocol for search criteria to be used
                                                  when filtering auctions for a search query.
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </li>
                  </ul>
               </div>
               <p>Some generic sub-classes are present for these
                        abstractions:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="classname">AuctionHouse</code></p>
                        <p>Entity that is a BigWorld implementation of
                                     <code class="interfacename">AbstractAuctionHouse</code>, using the
                                     BigWorld persistence engine.
                        </p>
                     </li>
                     <li>
                        <p><code class="classname">FantasyDemoSeller</code></p>
                        <p>Implementation of the <code class="classname">Seller</code> interface
                                     &#8212; this sub-class holds the database ID of the seller
                                     <code class="classname">Avatar</code> entity.
                        </p>
                     </li>
                     <li>
                        <p><code class="classname">FantasyDemoBidder</code></p>
                        <p>Implementation of the <code class="classname">Bidder</code> interface
                                     &#8212; this sub-class holds the database ID of the bidder
                                     <code class="classname">Avatar</code> entity, as well as the lock handle for
                                     the bidder's maximum bid.
                        </p>
                     </li>
                  </ul>
               </div>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Searching_And_Search_Criteria"></a>3.8.&nbsp;Searching and search criteria
                        </h2>
                     </div>
                  </div>
               </div>
               <p>In order to support arbitrary Boolean operations on auctions,
                        search criteria objects are created to filter matching auctions. They
                        are supported on the BigWorld server side by Python objects of type
                        <code class="classname">AuctionSearchCriteria</code>, and passed to the web
                        scripting layer as Python pickled strings of those criteria objects. The
                        web scripting layer constructs instances of these criteria objects, and
                        can store instances of them as Python pickled strings &#8212; they pass them
                        back to the <code class="classname">AuctionHouse</code> entity when retrieving
                        auction search results.
               </p>
               <p>The <code class="interfacename">AuctionSearchCriteria</code> class has
                        one method to be overridden by sub-classes: the
                        <code class="methodname">filter()</code> method:
               </p><pre class="programlisting">class SomeSearchCriteria( AuctionHouseCommon.AuctionSearchCriteria ):
   def filter( self, auction ):
      """
      Return True if the given auction satisfies this criteria, otherwise False. 
      """

      # test the auction and return either True or False
      return ...</pre><p>There are a few criteria types already defined. The definitions
                        for these classes can be found in:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="filename">fantasydemo/res/scripts/common/AuctionHouseCommon.py</code></p>
                     </li>
                     <li>
                        <p><code class="filename">fantasydemo/res/scripts/base/AuctionHouse.py</code></p>
                     </li>
                  </ul>
               </div>
               <p>The web return-value method declarations can be found in the
                        entity definitions file
                        <code class="filename">fantasydemo/res/scripts/entity_defs/AuctionHouse.def</code>.
               </p>
               <p>It is fairly easy to add new filtering criteria by implementing
                        the interface presented in
                        <code class="interfacename">AuctionSearchCriteria</code> for other item and
                        inventory subsystems:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><span class="literal">ItemTypeCriteria</span></p>
                        <p>Search for auctions with an item type in the list of given
                                     item types. This is specific to FantasyDemo, but a similar criteria
                                     for matching items in other item and inventory systems could also be
                                     written.
                        </p>
                        <p>Created by the base return-value method
                                     <code class="methodname">webCreateItemTypeCriteria()</code>.
                        </p>
                     </li>
                     <li>
                        <p><span class="literal">BidRangeSearchCriteria</span></p>
                        <p>Search for auctions that satisfy a given bid range.</p>
                        <p>Created by the base return-value method
                                     <code class="methodname">webCreateBidRangeCriteria()</code>, taking as
                                     arguments the minimum and maximum in the bid range (either argument
                                     is optional, but not both).
                        </p>
                     </li>
                     <li>
                        <p><span class="literal">BidderCriteria</span></p>
                        <p>Search for auctions of the bidder identified by the specified
                                     database ID.
                        </p>
                        <p>Created by the base return-value method
                                     <code class="methodname">webCreateBidderCriteria()</code>.
                        </p>
                     </li>
                     <li>
                        <p><span class="literal">SellerCriteria</span></p>
                        <p>Search for auctions of the seller identified by the specified
                                     database ID.
                        </p>
                        <p>Created by the base return-value method
                                     <code class="methodname">webCreateSellerCriteria()</code>.
                        </p>
                     </li>
                     <li>
                        <p><span class="literal">AndSearchCriteria</span>,
                                     <span class="literal">OrSearchCriteria</span></p>
                        <p>Composite criteria classes available for chaining criteria
                                     together in arbitrary ways.
                        </p>
                        <p>These criteria can be accessed through the
                                     <code class="classname">AuctionHouse</code> base return-value methods
                                     <code class="methodname">webCombineAnd</code>() and
                                     <code class="methodname">webCombineOr()</code>, and providing each with two
                                     pickled criteria objects to be combined using the given Boolean
                                     operation.
                        </p>
                        <p>Other pickled instances of
                                     <code class="classname">OrSearchCriteria</code> and
                                     <code class="classname">AndSearchCriteria</code> can also be
                                     supplied.
                        </p>
                     </li>
                  </ul>
               </div>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e905"></a>3.9.&nbsp;<code class="classname">Avatar</code> entity
                        </h2>
                     </div>
                  </div>
               </div>
               <p>The web interface scripts deal with the Avatar entity (the
                        player's entity) when doing player-specific actions, such as querying
                        player inventory and statistics, or bidding using a certain item in the
                        player's inventory.
               </p>
               <p>The <code class="classname">Avatar</code> base entity implements
                        return-value methods meant to be accessible from the web for returning
                        inventory information, querying player data, and executing requests for
                        bidding on other players' auctions. These are:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="methodname">Avatar.webGetPlayerInfo()</code></p>
                        <p>Retrieves information about the player, such as:</p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p>Database ID.</p>
                              </li>
                              <li>
                                 <p>Player name.</p>
                              </li>
                              <li>
                                 <p>Online status.</p>
                              </li>
                              <li>
                                 <p>Position in the world, if they are online.</p>
                              </li>
                              <li>
                                 <p>Direction facing in the world, if they are
                                                    online.
                                 </p>
                              </li>
                              <li>
                                 <p>Health.</p>
                              </li>
                              <li>
                                 <p>Maximum health.</p>
                              </li>
                              <li>
                                 <p>Number of frags.</p>
                              </li>
                           </ul>
                        </div>
                        <p>If the player is online, then the information is
                                     collected from the cell entity, via the cell method
                                     <code class="methodname">Avatar.getPlayerInfoBaseRequest()</code>, which
                                     returns the information via the base method
                                     <code class="methodname">Avatar.onPlayerInfo()</code>.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.webGetGoldAndInventory()</code></p>
                        <p>Retrieves the available gold pieces and the state of the
                                     inventory. The inventory items are returned as a list of
                                     dictionaries with information about the type, serial number and lock
                                     state of each item in the player's inventory.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.webCreateAuction()</code></p>
                        <p>Locks an item in the inventory identified by serial number,
                                     and creates an auction on the <span class="literal">AuctionHouse</span>
                                     singleton entity with the given auction parameters
                                     (<em class="emphasis">e.g.</em>, expiry, starting bid, optional buyout
                                     amount).
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.webBidOnAuction()</code></p>
                        <p>Lodges a maximum bid on, or to buyout, an auction with the
                                     given auction ID.
                        </p>
                     </li>
                  </ul>
               </div>
               <p>There are callbacks used to notify the player
                        <span class="literal">Avatar</span> entity about auction house events:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="methodname">Avatar.onCreateAuction()</code></p>
                        <p>Called in response to creating a new auction by the
                                     player.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.onBidOnAuction()</code></p>
                        <p>Called in response to bidding on another player's
                                     auction.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.onBuyoutAuction()</code></p>
                        <p>Called in response to buying out another player's
                                     auction.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.onAuctionWon()</code></p>
                        <p>Called when an auction has been won by this player.</p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.onAuctionOutbid()</code></p>
                        <p>Called when an auction has been outbid on by another
                                     player.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.onAuctionExpired()</code></p>
                        <p>Called when an auction created by this player has expired
                                     without any other player bidding on it.
                        </p>
                     </li>
                  </ul>
               </div>
               <p>In addition, the <code class="methodname">Avatar.lockAuctionGold()</code>
                        method is used by the <code class="classname">AuctionHouse</code> entity for
                        auction resolution. It relocks a lower bid amount of gold pieces for an
                        auction at the bid price that the auction was won at. Also supplied is
                        an existing lock handle for the maximum bid amount committed to by a
                        bidder; the difference between the maximum bid and the bid amount at
                        time of auction expiry is returned to the player this way.
                        <code class="methodname">AuctionHouse.completeAuction()</code> is called back
                        from <code class="methodname">Avatar.lockAuctionGold()</code> when the new lock
                        has been created.
               </p>
               <p>There are also two methods used for querying character statistics,
                        some of which exist on the cell, from the base:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="methodname">Avatar.getPlayerInfoBaseRequest()</code></p>
                        <p>Cell method called by the base to request character statistics
                                     from the cell.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.onPlayerInfo()</code></p>
                        <p>Base method called back by the cell to supply character
                                     statistics from the cell.
                        </p>
                     </li>
                  </ul>
               </div>
               <p>The actual locked item swapping mechanism uses the methods:</p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="methodname">Avatar.tradeCommitActive()</code></p>
                     </li>
                     <li>
                        <p><code class="methodname">Avatar.tradeCommitPassive()</code></p>
                     </li>
                  </ul>
               </div>
               <p>For details on how the swapping works via these methods, see the
                        document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">How To Implement
                           Items And Trading</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Trading</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Trading
                           Supervisor</a>).
               </p>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e1076"></a>3.10.&nbsp;<code class="classname">AuctionHouse</code> entity
                        </h2>
                     </div>
                  </div>
               </div>
               <p><code class="classname">AuctionHouse</code> is a subclass of
                        <code class="classname">BigWorld.Base</code> and
                        <code class="classname">AuctionHouseCommon.AbstractAuctionHouse</code>, and is
                        responsible for:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p>Holding auctions.</p>
                     </li>
                     <li>
                        <p>Bidding on auctions.</p>
                     </li>
                     <li>
                        <p>Checking auction expiries.</p>
                     </li>
                     <li>
                        <p>Responding to requests from <code class="classname">Avatar</code>
                                       entities for creating auctions.
                        </p>
                     </li>
                     <li>
                        <p>Responding to requests for searching through
                                       auctions.
                        </p>
                     </li>
                  </ul>
               </div>
               <p>This is a base-only singleton entity &#8212; uniqueness is controlled
                        through looking up global bases at <code class="methodname">__init__()</code>
                        time and self-destructing if a global base called
                        <code class="code">AuctionHouse</code> already exists. On BaseApp start-up,
                        <code class="methodname">AuctionHouse.wakeup</code> is called to load the
                        <code class="classname">AuctionHouse</code> entity if it does not already exist
                        (for details, see <code class="methodname">FantasyDemo.onBaseAppReady()</code>
                        in the FantasyDemo personality script
                        <code class="filename">fantasydemo/res/scripts/base/FantasyDemo.py</code>).
               </p>
               <p>The entity definitions file for this entity can be located at
                        <code class="filename">fantasydemo/res/scripts/entity_defs/AuctionHouse.def</code>.
               </p>
               <p>The base script for the <code class="classname">AuctionHouse</code> entity
                        can be located at
                        <code class="filename">fantasydemo/res/scripts/base/AuctionHouse.py</code>.
               </p>
               <p>The <code class="classname">AuctionHouse</code> base entity contains the
                        base property auctions which is an instance of the <code class="code">AUCTIONS</code>
                        collection data type (for details on how the different data types used
                        in the auction house system interact, see <a href="ch03.html#xref_Auction_House_Data_Types_Persistence_And_Aliases" title="3.3.&nbsp;Auction house data types, persistence and aliases">Auction
                           House data types, persistence and aliases</a>) .
               </p>
               <p>The <code class="classname">AuctionHouseCommon</code> module is imported
                        by <code class="classname">AuctionDataTypes</code> in order to support database
                        persistence of auction house data (for details, see <a href="ch03.html#xref_Auction_House_Data_Types_Persistence_And_Aliases" title="3.3.&nbsp;Auction house data types, persistence and aliases">Auction
                           House data types, persistence and aliases</a> and <a href="ch03.html#xref_The_Auction_House_Abstraction" title="3.7.&nbsp;The Auction House abstraction">The Auction House
                           Abstraction</a>).
               </p>
               <p>The <code class="classname">AuctionHouse</code> entity exposes the
                        following methods to the web interface scripting layer:
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p><code class="methodname">AuctionHouse.webGetTime()</code></p>
                        <p>Retrieves the <code class="methodname">BigWorld.time</code> value to
                                     the web scripting layer.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webSearchAuctions()</code></p>
                        <p>Searches for auctions that match the given criteria object,
                                     and returns only the auction IDs.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webGetAuctionInfo()</code></p>
                        <p>Returns information about the given auction IDs in the form of
                                     a dictionary of properties.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webCombineAnd()</code></p>
                        <p>Combines two criteria objects together using the
                                     <span class="literal">AND</span> Boolean function.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webCombineOr()</code></p>
                        <p>Combines two criteria objects together using the
                                     <span class="literal">OR</span> Boolean function.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webCreateItemTypeCriteria()</code></p>
                        <p>Creates a criteria that matches auctions based on item
                                     types.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webCreateBidRangeCriteria()</code></p>
                        <p>Creates a criteria that matches auctions base on the bid
                                     price. Ranges can be open (<em class="emphasis">i.e.</em>, either the top
                                     or the bottom limits can be omitted).
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webCreateSellerCriteria()</code></p>
                        <p>Creates a criteria that matches auctions based on the seller's
                                     database ID.
                        </p>
                     </li>
                     <li>
                        <p><code class="methodname">AuctionHouse.webCreateBidderCriteria()</code></p>
                        <p>Creates a criteria that matches auctions based on the bidder's
                                     database ID.
                        </p>
                     </li>
                  </ul>
               </div>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e1240"></a>3.11.&nbsp;<code class="classname">TradingSupervisor</code> entity
                        </h2>
                     </div>
                  </div>
               </div>
               <p>This entity oversees and facilitates in-game trading and atomic
                        swap transactions. For details on this entity's design and
                        implementation, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">How To Implement
                           Items And Trading</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Trading</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="/cgi-bin/olink?sysid=" class="olink">Trading
                           Supervisor</a>.
               </p>
            </div>
         </div>
         <div class="navfooter">
            <hr class="navheaderline">
            <table width="95%" align="center" summary="Navigation footer">
               <tr>
                  <td width="38%" align="left"><a accesskey="p" href="ch02.html">Prev</a>&nbsp;
                  </td>
                  <td width="20%" align="center">&nbsp;</td>
                  <td width="37%" align="right">&nbsp;<a accesskey="n" href="ch04.html">Next</a></td>
               </tr>
               <tr>
                  <td width="40%" align="left" valign="top">Chapter&nbsp;2.&nbsp;Use Cases&nbsp;</td>
                  <td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
                  <td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;4.&nbsp;PHP Presentation Layer</td>
               </tr>
               <tr>
                  <td colspan="3">Copyright 1999-2008 BigWorld Pty. Ltd. All rights reserved. Proprietary commercial in confidence.
                     		   
                  </td>
               </tr>
            </table>
         </div>
      </div>
   </body>
</html>