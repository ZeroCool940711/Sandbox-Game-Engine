<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   
      <title>Chapter&nbsp;6.&nbsp;Methods</title>
      <link rel="stylesheet" type="text/css" href="../css/bigworld.css">
      <meta name="generator" content="DocBook XSL Stylesheets V1.76.1">
      <link rel="home" href="index.html" title="Server Programming Guide">
      <link rel="up" href="pt01.html" title="Part&nbsp;I.&nbsp;Server Scripting Guide">
      <link rel="prev" href="ch05.html" title="Chapter&nbsp;5.&nbsp;Properties">
      <link rel="next" href="ch07.html" title="Chapter&nbsp;7.&nbsp;Inheritance in BigWorld">
   </head>
   <body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
      <div id="bigworld-header"><img src="http://try.bigworldtech.com/bigworld/image.php?img=bigworld_logo.gif&amp;svn=$HeadURL: http://patchsvn/svn/evaluation/official/IndiePackage/2.1/current/bigworld/doc/html/server_programming_guide/ch06.html $" alt="bw logo"></div>
      <div id="content">
         <div class="navheader">
            <table width="95%" align="center" summary="Navigation header">
               <tr>
                  <th colspan="3" align="center">Chapter&nbsp;6.&nbsp;Methods</th>
               </tr>
               <tr>
                  <td width="20%" align="left"><a accesskey="p" href="ch05.html">Prev</a>&nbsp;
                  </td>
                  <th width="55%" align="center">Part&nbsp;I.&nbsp;Server Scripting Guide</th>
                  <td width="20%" align="right">&nbsp;<a accesskey="n" href="ch07.html">Next</a></td>
               </tr>
            </table>
            <hr class="navheaderline">
         </div>
         <div class="chapter" title="Chapter&nbsp;6.&nbsp;Methods">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title"><a name="xref_Methods"></a>Chapter&nbsp;6.&nbsp;Methods
                     </h2>
                  </div>
               </div>
            </div>
            <div class="toc">
               <p><b>Table of Contents</b></p>
               <dl>
                  <dt><span class="section"><a href="ch06.html#d0e4710">6.1. Basic Method Specification</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_Two_Way_Calls">6.2. Two-way calls</a></span></dt>
                  <dd>
                     <dl>
                        <dt><span class="section"><a href="ch06.html#xref_twisted_deferred_objects">6.2.1. Twisted Deferred Objects</a></span></dt>
                        <dt><span class="section"><a href="ch06.html#xref_Two_Way_Errors">6.2.2. Error objects</a></span></dt>
                     </dl>
                  </dd>
                  <dt><span class="section"><a href="ch06.html#d0e5189">6.3. Service Methods</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_Intra_Entity_Communication">6.4. Intra-Entity Communication</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_Send_Latest_Only_Method">6.5. Bandwidth Optimisation: Send Latest Only</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_Method_Is_Reliable">6.6. Bandwidth Optimisation: Is Reliable</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_Auxiliary_Data">6.7. Sending Auxiliary Data to the Client Via Proxy</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_SPG_ExposedMethods">6.8. Exposed Methods <span class="symbol">&#8208;</span>
                               Client-to-Server Communication</a></span></dt>
                  <dd>
                     <dl>
                        <dt><span class="section"><a href="ch06.html#d0e5655">6.8.1. Security Considerations of Exposed Methods</a></span></dt>
                     </dl>
                  </dd>
                  <dt><span class="section"><a href="ch06.html#xref_ServerClientBandwidthMethodCalls">6.9. Server to Client bandwidth usage of Method calls</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_Implicit_set_property_name_Methods">6.10. Client callbacks on property changes</a></span></dt>
                  <dd>
                     <dl>
                        <dt><span class="section"><a href="ch06.html#d0e5724">6.10.1. Implicit
                                       <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                                       Methods</a></span></dt>
                        <dt><span class="section"><a href="ch06.html#d0e5807">6.10.2. Implicit
                                       <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                                       Methods</a></span></dt>
                        <dt><span class="section"><a href="ch06.html#d0e5859">6.10.3. Implicit
                                       <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                                       Methods</a></span></dt>
                     </dl>
                  </dd>
                  <dt><span class="section"><a href="ch06.html#d0e5902">6.11. LOD on Methods</a></span></dt>
                  <dt><span class="section"><a href="ch06.html#xref_Inter_Entity_Communication">6.12. Inter-Entity Communication</a></span></dt>
                  <dd>
                     <dl>
                        <dt><span class="section"><a href="ch06.html#d0e5991">6.12.1. Entity IDs</a></span></dt>
                        <dt><span class="section"><a href="ch06.html#d0e6154">6.12.2. Retrieving Services</a></span></dt>
                     </dl>
                  </dd>
                  <dt><span class="section"><a href="ch06.html#xref_Mailboxes">6.13. Mailboxes</a></span></dt>
                  <dd>
                     <dl>
                        <dt><span class="section"><a href="ch06.html#xref_Mailboxes_Special">6.13.1. Special Mailboxes</a></span></dt>
                     </dl>
                  </dd>
                  <dt><span class="section"><a href="ch06.html#d0e6520">6.14. Method Execution Context</a></span></dt>
               </dl>
            </div>
            <p>Methods allow events to be propagated, both between different
                 execution contexts of an entity (<em class="emphasis">i.e.</em>, cell, base,
                 client), as well as between different entities. BigWorld separates entity
                 methods into categories based on the execution context within which they
                 will be executed.
            </p>
            <p>In general, methods should not be used for propagating states. The use
                 of properties is recommended for this purpose. For example, a player holding
                 a gun should be a property, while a player shooting should be a
                 method.
            </p>
            <p>The categories of methods are:</p>
            <div class="altrow">
               <table border="0">
                  <colgroup>
                     <col width="20%" class="col1">
                     <col width="13%" class="col2">
                     <col width="67%" class="col3">
                  </colgroup>
                  <thead>
                     <tr>
                        <th align="left">Category</th>
                        <th align="left">Runs on</th>
                        <th align="left">Common uses</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr>
                        <td align="left"><code class="property">&lt;BaseMethods&gt;</code></td>
                        <td align="left">BaseApp</td>
                        <td align="left">
                           <p>Updates properties on the
                                          base.
                           </p>
                           <p>Serves as a root point to propagate messages to
                                          related things.
                           </p>
                        </td>
                     </tr>
                     <tr>
                        <td align="left"><code class="property">&lt;CellMethods&gt;</code></td>
                        <td align="left">CellApp</td>
                        <td align="left">
                           <p>Notifies the cell of changes in response
                                          to player interaction.
                           </p>
                           <p>Allows communication between
                                          nearby entities.
                           </p>
                        </td>
                     </tr>
                     <tr>
                        <td align="left"><code class="property">&lt;ClientMethods&gt;</code></td>
                        <td align="left">Clients</td>
                        <td align="left">
                           <p>Notifies the client of events, so that
                                          the player can see them. Implicit
                                          <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                                          methods need not be declared.<sup>[<a name="d0e4608" href="#ftn.d0e4608" class="footnote">a</a>]</sup>.
                           </p>
                        </td>
                     </tr>
                  </tbody>
                  <tbody class="footnotes">
                     <tr>
                        <td colspan="3">
                           <div class="footnote">
                              <p><sup>[<a id="ftn.d0e4608" href="#d0e4608" class="para">a</a>] </sup>For details, see <a class="xref" href="ch06.html#xref_Implicit_set_property_name_Methods" title="6.10.&nbsp;Client callbacks on property changes">Client callbacks on property changes</a></p>
                           </div>
                        </td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <p><span class="citetitle">Method categories.</span></p>
            <p>The grammar for method declaration is described below:</p><pre class="programlisting">&lt;[ClientMethods|CellMethods|BaseMethods]&gt;

   &lt;<em class="replaceable"><code>method_name</code></em>&gt;
      &lt;<em class="emphasis">Exposed</em>/&gt;

      &lt;<em class="emphasis">Args</em>&gt;
         &lt;<em class="replaceable"><code>arg1_name</code></em>&gt; <em class="replaceable"><code>data_type</code></em> &lt;/<em class="replaceable"><code>arg1_name</code></em>&gt;
         &lt;<em class="replaceable"><code>arg2_name</code></em>&gt; <em class="replaceable"><code>data_type</code></em> &lt;/<em class="replaceable"><code>arg2_name</code></em>&gt;
      &lt;/Args&gt;

      &lt;<em class="emphasis">ReturnValues</em>&gt;
         &lt;<em class="replaceable"><code>ret1_name</code></em>&gt; <em class="replaceable"><code>data_type</code></em> &lt;/<em class="replaceable"><code>ret2_name</code></em>&gt;
         &lt;<em class="replaceable"><code>ret2_name</code></em>&gt; <em class="replaceable"><code>data_type</code></em> &lt;/<em class="replaceable"><code>ret2_name</code></em>&gt;
      &lt;/ReturnValues&gt;

      &lt;!-- Only send one call to clients if called repeatedly --&gt;
      &lt;<em class="emphasis">SendLatestOnly</em>&gt; [true|<em class="emphasis">false</em>] &lt;/SendLatestOnly&gt; <a class="co" name="co_send_latest_method" href="ch06.html#co_send_latest_method_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>

      &lt;!-- Send the call reliably --&gt;
      &lt;<em class="emphasis">IsReliable</em>&gt; [<em class="emphasis">true</em>|false] &lt;/IsReliable&gt; <a class="co" name="co_method_is_reliable" href="ch06.html#co_method_is_reliable_desc"><img src="../images/callouts/2.png" alt="2" border="0"></a>
   &lt;/<em class="replaceable"><code>method_name</code></em>&gt;

&lt;/[ClientMethods|CellMethods|BaseMethods]&gt;</pre><div class="calloutlist">
               <table border="0" summary="Callout list">
                  <tr>
                     <td width="5%" valign="top" align="left">
                        <p><a name="co_send_latest_method_desc"></a><a href="#co_send_latest_method"><img src="../images/callouts/1.png" alt="1" border="0"></a> 
                        </p>
                     </td>
                     <td valign="top" align="left">
                        <p>For details, see <a class="xref" href="ch06.html#xref_Send_Latest_Only_Method" title="6.5.&nbsp;Bandwidth Optimisation: Send Latest Only">Bandwidth Optimisation: Send Latest Only</a>.
                        </p>
                     </td>
                  </tr>
                  <tr>
                     <td width="5%" valign="top" align="left">
                        <p><a name="co_method_is_reliable_desc"></a><a href="#co_method_is_reliable"><img src="../images/callouts/2.png" alt="2" border="0"></a> 
                        </p>
                     </td>
                     <td valign="top" align="left">
                        <p>For details, see <a class="xref" href="ch06.html#xref_Method_Is_Reliable" title="6.6.&nbsp;Bandwidth Optimisation: Is Reliable">Bandwidth Optimisation: Is Reliable</a>.
                        </p>
                     </td>
                  </tr>
               </table>
            </div>
            <p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
                    <span class="symbol">&#8208;</span> Method declaration
                    syntax</span></p>
            <div class="section" title="6.1.&nbsp;Basic Method Specification">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e4710"></a>6.1.&nbsp;Basic Method Specification
                        </h2>
                     </div>
                  </div>
               </div>
               <p>All methods in all categories have some fundamental common
                      characteristics. They are declared in the relevant section in the file
                      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>,
                      with an XML tag per method.
               </p>
               <p>The method's arguments and return values (if any) are also defined
                      in the file, and its types are specified in the same way as property
                      types. For more details, see <a class="xref" href="ch05.html#xref_Property_Types" title="5.1.&nbsp;Property Types">Property Types</a>.
               </p>
               <p>In order to declare a method called <code class="methodname">yell</code> on
                      the cell, which receives a string argument named
                      <em class="parameter"><code>phrase</code></em>, we would have the lines below:
               </p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">CellMethods</em>&gt;
    &lt;<em class="emphasis">yell</em>&gt;
      &lt;Args&gt;
        &lt;<em class="emphasis">phrase</em>&gt; <em class="emphasis">STRING</em> &lt;/phrase&gt; &lt;!-- phrase to exclaim --&gt;
      &lt;/Args&gt;
    &lt;/yell&gt;
  &lt;/CellMethods&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
                         <span class="symbol">&#8208;</span> Declaration of cell method
                         <code class="methodname">yell</code></span></p>
               <p>Once the method is declared, it also needs to be declared in the
                      appropriate Python implementation file. Each context of execution (cell,
                      base, and client) has a folder containing scripts for each entity.
               </p>
               <p>In our example, the method was added to the section
                      <code class="property">&lt;CellMethods&gt;</code>, and therefore will be executed
                      on the cell entity.
               </p>
               <p>The cell script for this entity, named
                      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>,
                      will need to define the <code class="methodname">yell</code> method, as
                      illustrated below:
               </p><pre class="programlisting">import BigWorld
...
class <em class="emphasis"><em class="replaceable"><code>&lt;entity&gt;</code></em></em>(BigWorld.Entity):

  def <em class="emphasis">__init__</em>(self):
    BigWorld.Entity.__init__(self)

  def <em class="emphasis">yell</em>(self, phrase):
    # insert code to implement yell here
    return</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
                         <span class="symbol">&#8208;</span> Definition of cell method
                         <code class="methodname">yell</code></span></p>
            </div>
            <div class="section" title="6.2.&nbsp;Two-way calls">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Two_Way_Calls"></a>6.2.&nbsp;Two-way calls
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Remote two-way method calls can be used to get return values from
                      Python calls between processes. Return values for entity methods are
                      declared in the same format as the method arguments in the entity
                      definition file, except that they are listed under the
                      <code class="code">ReturnValues</code> tag instead of <code class="code">Args</code>. For example,
                      the <code class="methodname">webCreateAuction</code> Base method for an Avatar
                      has the following definition:
               </p><pre class="programlisting">&lt;<em class="emphasis">webCreateAuction</em>&gt;
  &lt;Args&gt;
    &lt;<em class="emphasis">itemSerial</em>&gt;  <em class="emphasis">ITEMSERIAL</em>  &lt;/itemSerial&gt;
    &lt;<em class="emphasis">expiry</em>&gt;      <em class="emphasis">UINT32</em>      &lt;/expiry&gt;
    &lt;<em class="emphasis">startBid</em>&gt;    <em class="emphasis">GOLDPIECES</em>  &lt;/startBid&gt;
    &lt;<em class="emphasis">buyout</em>&gt;      <em class="emphasis">GOLDPIECES</em>  &lt;/buyout&gt;
  &lt;/Args&gt;
  &lt;ReturnValues&gt;
    &lt;<em class="emphasis">auctionID</em>&gt;   <em class="emphasis">AUCTIONID</em>   &lt;/auctionID&gt;
  &lt;ReturnValues&gt;
&lt;/webCreateAuction&gt;</pre><p>This method takes a number of arguments containing the details of
                      the item being listed for auction, and returns the unique auction ID.
                      However, this method makes a remote call to an entity that is potentially
                      on another process, which prevents us from receiving a return value in the
                      usual way. Instead, this method will return a Twisted Deferred object,
                      that will send the return values as an argument to a callback method once
                      they are received. This entire process is explained in <a class="xref" href="ch06.html#xref_twisted_deferred_objects" title="6.2.1.&nbsp;Twisted Deferred Objects">Twisted Deferred Objects</a>.
               </p>
               <div class="section" title="6.2.1.&nbsp;Twisted Deferred Objects">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="xref_twisted_deferred_objects"></a>6.2.1.&nbsp;Twisted Deferred Objects
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>To obtain the return value of a two-way method, Twisted Deferred
                           objects are used. When a method is called, a Deferred object is
                           returned. Two types of callback methods can then be added to this
                           object: a callback for successful calls, and an errback for when an an
                           error has occured. When the method has been executed, it will call one
                           of the two callback methods, depending on the success of the call. It is
                           also possible to chain more than one callback for both success and
                           failure.
                  </p>
                  <p>For a more detailed explanation about how
                           <code class="classname">Deferred</code> objects are used, see the Twisted
                           documentation at <a class="ulink" href="http://twistedmatrix.com/documents/current/core/howto/defer.html" target="_top">http://twistedmatrix.com/documents/current/core/howto/defer.html</a>.
                  </p>
                  <p>As an example, we will implement
                           <code class="methodname">remoteTakeDamage</code>, a Base method for an Avatar
                           that causes it to lose some health, and returns its remaining health.
                           This method will call <code class="methodname">takeDamage</code>, one of the
                           Avatar's Cell methods.
                  </p>
                  <p><code class="methodname">takeDamage</code> will take the damage amount as
                           its argument, and return two values: the entity's remaining health, and
                           its maximum health. These values will be printed, and the remaining
                           health amount will be returned from
                           <code class="methodname">remoteTakeDamage</code> as the Deferred object's its
                           final value.
                  </p>
                  <p>Since the Base entity and Cell entity for the Avatar are on
                           different processes, the call will use Deferred objects to effectively
                           achieve an asynchronous two-way call. The methods will have the
                           following definitions in the entity definition file, Avatar.def:
                  </p><pre class="programlisting">...
    &lt;BaseMethods&gt;
        &lt;<em class="emphasis">remoteTakeDamage</em>&gt;
            &lt;Args&gt;
                &lt;<em class="emphasis">damage</em>&gt;        INT32   &lt;/damage&gt;
            &lt;/Args&gt;
            &lt;ReturnValues&gt;
                &lt;<em class="emphasis">health</em>&gt;        INT32   &lt;/health&gt;
            &lt;/ReturnValues&gt;
        &lt;/remoteTakeDamage&gt;
        ...
    &lt;/BaseMethods&gt;

    &lt;CellMethods&gt;
        &lt;<em class="emphasis">takeDamage</em>&gt;
            &lt;Args&gt;
                &lt;<em class="emphasis">damage</em>&gt;        INT32   &lt;/damage&gt;
            &lt;/Args&gt;
            &lt;ReturnValues&gt;
                &lt;<em class="emphasis">health</em>&gt;        INT32   &lt;/health&gt;
                &lt;<em class="emphasis">maxHealth</em>&gt;     INT32   &lt;/maxHealth&gt;
            &lt;/ReturnValues&gt;
        &lt;/takeDamage&gt;
        ...
    &lt;/BaseMethods&gt;</pre><p><code class="methodname">remoteTakeDamage</code> has the following
                           implementation in
                           <code class="filename">fantasydemo/res/scripts/base/Avatar.py</code>:
                  </p><pre class="programlisting"># base/Avatar.py

from twisted.internet import defer
...

def remoteTakeDamage( self, damage )
    deferred = self.cell.<em class="emphasis">takeDamage</em>( damage )
    deferred.<em class="emphasis">addCallback</em>( partial( self.onDamageTaken, damage ) )
    return deferred

def onDamageTaken( self, damage, healthArgs ):
    health, maxHealth = healthArgs[ 0 ], healthArgs[ 1 ]
    print "Avatar 's' took %d damage, reducing its health to %d/%d" % \
        (self.basePlayerName, damage, health, maxHealth)
    return (health,)</pre><p>Since the call to <code class="methodname">takeDamage</code> is
                           asynchronous, we will not receive the return value immediately. Instead,
                           a Deferred object will be returned, referred to by
                           <code class="varname">deferred</code>. Once a result is available, it will be
                           stored in the Deferred object, taking the form of a tuple containing the
                           return values. Since we are unable to receive and use the values
                           immediately, we can specify a method to be called using the values as an
                           argument, once they become available.
                  </p>
                  <p>The <code class="methodname">addCallback</code> method is used to specify
                           a method that will be called once this result is available. This method
                           will be given the result tuple as its argument. In our example, once the
                           result is available in the Deferred object, it will be sent as the final
                           argument to the <code class="methodname">onDamageTaken</code> method. If
                           additional callback methods are specified using
                           <code class="methodname">addCallback</code>, they will be called in turn. The
                           result from each one will be stored as the new result in the Deferred
                           object, and sent as the argument for the next callback method in the
                           list. This is called a 'callback chain'.
                  </p>
                  <p>When there are no remaining callback methods in the chain, the
                           final result will be stored in the Deferred object. At this point, any
                           additional callbacks that are added will be called immediately, since
                           there is already a result available.
                  </p>
                  <p>Finally, the result of <code class="methodname">onDamageTaken</code> will
                           be stored in the Deferred object, and sent to the caller of
                           <code class="methodname">remoteTakeDamage</code>.
                  </p>
                  <p>Methods can also be specified to be called if a remote method call
                           fails. This is done using the <code class="methodname">addErrback</code>
                           method, for example:
                  </p><pre class="programlisting">deferred.addErrback( <em class="replaceable"><code>onError</code></em> )</pre><p>If an error object is returned from the call, it will be used as
                           the argument to
                           <code class="methodname"><em class="replaceable"><code>onError</code></em></code>.
                  </p>
                  <p>Errbacks can be chained in the same way as callbacks, by using
                           multiple calls to <code class="methodname">addErrback</code>. The
                           <code class="methodname">addCallbacks</code> method adds both a callback and an
                           errback to a deferred object, but it has slightly different behaviour
                           than adding the two separately using
                           <code class="methodname">addCallback</code> and
                           <code class="methodname">addErrback</code>.
                           <code class="methodname">addCallbacks</code> adds both methods at the same
                           level in the call chain, whereas adding them separately will put each
                           method on its own level. This is explained in detail in the Twisted
                           documentation, at <a class="ulink" href="http://twistedmatrix.com/documents/current/core/howto/defer.html" target="_top">http://twistedmatrix.com/documents/current/core/howto/defer.html</a>.
                  </p>
                  <p>The implementation of <code class="methodname">takeDamage</code>, in
                           <code class="filename">cell/Avatar.py</code>, is as follows:
                  </p><pre class="programlisting"># cell/Avatar.py

import CustomErrors
from twisted.internet import defer
...

def takeDamage( self, damage ):
    if (damage &lt; 0):
        # Goes to errback which 
        return <em class="emphasis">defer.fail</em>( CustomErrors.InvalidFieldError(
                "Avatar can not take negative damage" ) )

    self.health = self.health - damage

    if (self.health &lt; 0):
        self.health = 0

    # Goes to onDamageTaken callback
    return (self.health, self.maxHealth)</pre><p>Methods that are called in this way must return either a tuple
                           containing the return values, or a Deferred object. If a tuple is
                           returned from <code class="methodname">takeDamage</code>, its values will be
                           stored in <code class="varname">deferred</code>, in the
                           <code class="methodname">remoteTakeDamage</code> method, and sent as arguments
                           into its callback method, <code class="methodname">onDamageTaken</code>, as
                           described above. However, if a Deferred object is returned, its result
                           tuple and any callbacks specified for it will be propagated to
                           <code class="methodname">remoteTakeDamage</code>'s <code class="varname">deferred</code>
                           object, and the <code class="methodname">onDamageTaken</code> callback will be
                           added to the end of the chain.
                  </p>
                  <p>For examples of remote methods that create Deferred objects, add
                           callbacks and errbacks to them and return them, refer to the web
                           interface Base methods in FantasyDemo's <code class="classname">Avatar</code>
                           and <code class="classname">AuctionHouse</code> entities, located at
                           <code class="filename">fantasydemo/res/scripts/base</code>.
                  </p>
                  <p>In our implementation of <code class="methodname">takeDamage</code>, an
                           error results in a <code class="classname">CustomErrors.InvalidFieldError</code>
                           object (a custom error derived from <code class="classname">Exception</code>) to
                           be returned using <code class="methodname">defer.fail</code>. This method
                           creates a special error object: a Deferred object that has already had
                           an errback called. Using this method is a simple way of returning an
                           error to the original caller. Once the error object is received by the
                           original caller, it will be used as the argument for the first errback
                           method, if there is one. Instead of calling
                           <code class="methodname">defer.fail</code>, an exception can be raised:
                  </p><pre class="programlisting">raise CustomErrors.InvalidFieldError( "Avatar can not take negative damage" ) )</pre><p>This will have the same result as returning the error object using
                           <code class="methodname">defer.fail</code>, and will also send the call stack
                           for the error to MessageLogger.
                  </p>
                  <p>In this example, we use <code class="classname">CustomErrors</code>
                           objects. These custom errors are derived from
                           <code class="classname">BWError</code>, and are the recommended way to send
                           errors in two-way calls. For details about custom errors, refer to <a class="xref" href="ch06.html#xref_Two_Way_Errors" title="6.2.2.&nbsp;Error objects">Error objects</a>.
                  </p>
               </div>
               <div class="section" title="6.2.2.&nbsp;Error objects">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="xref_Two_Way_Errors"></a>6.2.2.&nbsp;Error objects
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>If a two-way call fails, it will send an error object to the
                           Deferred object, and invoke the first errback method, if there is one
                           specified. This object is an instance of an
                           <code class="classname">Exception</code>.
                  </p>
                  <p>A number of error types deriving from our custom exception class
                           <code class="classname">BWError</code> are defined in
                           <code class="filename">bigworld/res/scripts/server_common/BWTwoWay.py</code>.
                           These can be extended to suit the errors that could come about in the
                           game scripts. Two subclasses of <code class="classname">BWError</code> are
                           defined: <code class="classname">BWStandardError</code>, which is primarily used
                           as a base class for errors arising in the server binaries, and
                           <code class="classname">BWCustomError</code>, which is used to as a base class
                           for errors occuring in the game scripts.
                  </p>
                  <div class="section" title="6.2.2.1.&nbsp;BWStandardError">
                     <div class="titlepage">
                        <div>
                           <div>
                              <h4 class="title"><a name="xref_BWStandardError"></a>6.2.2.1.&nbsp;BWStandardError
                              </h4>
                           </div>
                        </div>
                     </div>
                     <p>Error objects originating in the server binaries are derived
                                from the <code class="classname">BWStandardError</code> type, and are declared
                                in
                                <code class="filename">bigworld/res/scripts/server_common/BWTwoWay.py</code>.
                                These error types are as follows:
                     </p>
                     <div class="itemizedlist">
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              <p><code class="classname">BWAuthenticateError</code></p>
                              <p>A player can not be authenticated with the credentials
                                               they provided.
                              </p>
                           </li>
                           <li class="listitem">
                              <p><code class="classname">BWInternalError</code></p>
                              <p>The server experienced an error that was caused
                                               internally.
                              </p>
                           </li>
                           <li class="listitem">
                              <p><code class="classname">BWInvalidArgsError</code></p>
                              <p>A method is called with invalid arguments.</p>
                           </li>
                           <li class="listitem">
                              <p><code class="classname">BWMercuryError</code></p>
                              <p>No response was received for a request.</p>
                           </li>
                           <li class="listitem">
                              <p><code class="classname">BWNoSuchCellEntityError</code></p>
                              <p>A cell entity can not be found.</p>
                           </li>
                           <li class="listitem">
                              <p><code class="classname">BWNoSuchEntityError</code></p>
                              <p>An entity can not be found.</p>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <div class="section" title="6.2.2.2.&nbsp;BWCustomError">
                     <div class="titlepage">
                        <div>
                           <div>
                              <h4 class="title"><a name="d0e5153"></a>6.2.2.2.&nbsp;BWCustomError
                              </h4>
                           </div>
                        </div>
                     </div>
                     <p>New error types should be implemented to allow errors to be as
                                helpful as possible. <code class="classname">BWCustomError</code> should be
                                used as the base class for a range of error classes specific to the
                                game scripts. For example, FantasyDemo defines a number of custom
                                error classes for its two-way calls specific to its auction house
                                implementation, such as <code class="classname">InsufficientGoldError</code>
                                and <code class="classname">InvalidItemError</code>. For a description of each
                                of the custom error types used in FantasyDemo, refer to the <a href="../server_web_integration/index.html" class="olink">Server Web Integration Guide</a>'s section<a href="../server_web_integration/ch10.html#xref_PHP_Error_Handling" class="olink">PHP Error handling</a>.
                     </p>
                     <p>Custom errors are declared in
                                <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/server_common/CustomErrors.py</code>.
                                The above implementation of <code class="methodname">remoteTakeDamage</code>
                                shows how a custom error can be returned as the deferred object
                                instead of the return values:
                     </p><pre class="programlisting">return defer.fail( CustomErrors.<em class="replaceable"><code>&lt;Error Type&gt;</code></em>( <em class="replaceable"><code>&lt;Args&gt;</code></em> ) )</pre></div>
               </div>
            </div>
            <div class="section" title="6.3.&nbsp;Service Methods">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e5189"></a>6.3.&nbsp;Service Methods
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Methods for services are defined in the much same way as base, cell
                      and client methods. However, there are some slight differences, since,
                      unlike the other categories, services are not entities. Service methods
                      are declared in the file
                      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/service_defs/<em class="replaceable"><code>&lt;service&gt;</code></em>.def</code>,
                      with an XML tag per method.
               </p>
               <p>Service methods fall under the <code class="code">Methods</code> tag, instead of
                      under a specific category such as <code class="code">BaseMethods</code> or
                      <code class="code">CellMethods</code>.
               </p>
               <p>In order to declare a method called <code class="methodname">addNote</code>
                      on the service, which receives a string argument named
                      <em class="parameter"><code>newNote</code></em>, we would have the lines below:
               </p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">Methods</em>&gt;
    &lt;<em class="emphasis">addNote</em>&gt;
      &lt;Args&gt;
        &lt;<em class="emphasis">newNote</em>&gt; <em class="emphasis">STRING</em> &lt;/newNote&gt;
      &lt;/Args&gt;
      &lt;ReturnValues&gt;
        &lt;<em class="emphasis">noteID</em>&gt; <em class="emphasis">NOTE_ID</em> &lt;/newNote&gt;
      &lt;/ReturnValues&gt;
    &lt;/addNote&gt;
  &lt;/CellMethods&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/service_defs/<em class="replaceable"><code>&lt;service&gt;</code></em>.def</code>
                         <span class="symbol">&#8208;</span> Declaration of service method
                         <code class="methodname">addNote</code></span></p>
               <p>Once the method is declared, it also needs to be implemented in the
                      service Python implementation file. The service execution context has a
                      directory containing the scripts for each service.
               </p>
               <p>The script for this entity, named
                      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/service/<em class="replaceable"><code>&lt;service&gt;</code></em>.py</code>,
                      will need to define the <code class="methodname">addNote</code> method, as
                      illustrated below:
               </p><pre class="programlisting">import BigWorld
...
class <em class="emphasis"><em class="replaceable"><code>&lt;service&gt;</code></em></em>( BigWorld.Service ):

  def <em class="emphasis">addNote</em>( self, description ):
    # insert code to implement addNote here
    return</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/service/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
                         <span class="symbol">&#8208;</span> Definition of service method
                         <code class="methodname">addNote</code></span></p>
            </div>
            <div class="section" title="6.4.&nbsp;Intra-Entity Communication">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Intra_Entity_Communication"></a>6.4.&nbsp;Intra-Entity Communication
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Different execution contexts of an entity communicate with each
                      other by calling methods on the other execution contexts. These are
                      exposed as special properties of the entity.
               </p>
               <p>As a quick reference, the available objects are described
                      below:
               </p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><em class="emphasis"><span class="literal">allClients</span> <span class="symbol">&#8208;</span> Available on: Cell</em></p>
                        <p><em class="emphasis">When/how to use:</em> To call a
                                   client method on all client instances of this entity.
                        </p>
                        <p><em class="emphasis">Example:
                                      </em><span class="literal">self.allClients.someMethod()</span></p>
                     </li>
                     <li class="listitem">
                        <p><em class="emphasis"><span class="literal">base</span> <span class="symbol">&#8208;</span> Available on: Cell,
                                      Client</em></p>
                        <p><em class="emphasis">When/how to use:</em> To call a base
                                   method of this entity. Calls to this object are executed on the base
                                   script. The client cannot directly call methods on the base of other
                                   entities.
                        </p>
                        <p><em class="emphasis">Example:</em>
                                   <span class="literal">self.base.someMethod()</span></p>
                     </li>
                     <li class="listitem">
                        <p><em class="emphasis"><span class="literal">cell</span> <span class="symbol">&#8208;</span> Available on: Base,
                                      Client</em></p>
                        <p><em class="emphasis">When/how to use:</em> To call a cell
                                   method of this entity. Calls to this object are executed on the cell
                                   script. All client instances can access their cell object (when the
                                   entity exists on the cell).
                        </p>
                        <p><em class="emphasis">Example:</em>
                                   <span class="literal">self.cell.someMethod()</span></p>
                     </li>
                     <li class="listitem">
                        <p><em class="emphasis"><span class="literal">otherClients</span> <span class="symbol">&#8208;</span> Available on: Cell</em></p>
                        <p><em class="emphasis">When/how to use:</em> To call a
                                   client method on all client instances of this entity, except on its
                                   own.
                        </p>
                        <p><em class="emphasis">Example:</em>
                                   <span class="literal">self.otherClients.someMethod()</span></p>
                     </li>
                     <li class="listitem">
                        <p><em class="emphasis"><span class="literal">ownClient</span> <span class="symbol">&#8208;</span> Available on: Cell,
                                      Base</em></p>
                        <p><em class="emphasis">When/how to use:</em> To call a
                                   client method only on this entity's client. This object calls the
                                   method only on the entity on the client application that is 'playing'
                                   as this entity, not on other client applications that can see this
                                   entity.
                        </p>
                        <p><em class="emphasis">Example:</em>
                                   <span class="literal">self.ownClient.someMethod()</span></p>
                     </li>
                  </ul>
               </div>
               <p>The methods of a nearby entity can be called from the client
                      directly on the cell part of that entity.
               </p>
               <p>BigWorld automatically exposes these objects to the relevant script
                      classes.
               </p>
               <p>What this means is that it is possible for any script that is part
                      of an entity (cell, base or client part) to call other scripts that are
                      part of the same entity. The definition file
                      (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>)
                      describes which methods are exposed to different execution
                      contexts.
               </p>
            </div>
            <div class="section" title="6.5.&nbsp;Bandwidth Optimisation: Send Latest Only">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Send_Latest_Only_Method"></a>6.5.&nbsp;Bandwidth Optimisation: Send Latest Only
                        </h2>
                     </div>
                  </div>
               </div>
               <p>When a method is called on <code class="property">Entity.otherClients</code>
                      (or <code class="property">Entity.allClients</code>), an event object is created
                      and added to the event history. This event history is used when updating
                      client applications that have this entity in their AoI. When this entity
                      is considered<sup>[<a name="d0e5423" href="#ftn.d0e5423" class="footnote">7</a>]</sup>, any events that have been added since the last time this
                      entity was considered are sent to the client. There is the potential for
                      multiple calls of a single method to be sent in a single update.
               </p>
               <p>If the <span class="literal">SendLatestOnly</span> flag is set on a client
                      method, only the latest call is kept in the event history. This avoids
                      sending multiple calls. This can save bandwidth being sent to the client
                      and can save some memory on CellApps if a method is called frequently and
                      only the latest call is needed.
               </p>
               <p>This value is <span class="literal">false</span> by default.
               </p>
               <p>Properties with the <span class="literal">OTHER_CLIENTS</span> flag also have
                      this flag. See <a class="xref" href="ch05.html#xref_Send_Latest_Only" title="5.8.&nbsp;Bandwidth Optimisation: Send Latest Only">Bandwidth Optimisation: Send Latest Only</a>.
               </p>
            </div>
            <div class="section" title="6.6.&nbsp;Bandwidth Optimisation: Is Reliable">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Method_Is_Reliable"></a>6.6.&nbsp;Bandwidth Optimisation: Is Reliable
                        </h2>
                     </div>
                  </div>
               </div>
               <p>When a method is called on <code class="property">Entity.otherClients</code>
                      (or <code class="property">Entity.allClients</code>), a message is sent to the
                      appropriate client applications that have this entity in their
                      AoI<sup>[<a name="d0e5457" href="#ftn.d0e5457" class="footnote">8</a>]</sup>. By default, these messages are sent reliably. If the
                      <span class="literal">IsReliable</span> flag is set to <span class="literal">false</span> on a
                      client method, this message will be sent unreliably.
               </p>
               <p>Properties with the <span class="literal">OTHER_CLIENTS</span> flag also have
                      this flag. See <a class="xref" href="ch05.html#xref_Prop_Is_Reliable" title="5.9.&nbsp;Bandwidth Optimisation: Is Reliable">Bandwidth Optimisation: Is Reliable</a>.
               </p>
            </div>
            <div class="section" title="6.7.&nbsp;Sending Auxiliary Data to the Client Via Proxy">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Auxiliary_Data"></a>6.7.&nbsp;Sending Auxiliary Data to the Client Via Proxy
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Auxiliary data can be streamed to the client via the proxy, without
                      affecting the normal game traffic. This data is opportunistically streamed
                      to the client when bandwidth is available.
               </p>
               <p>The bandwidth used by auxiliary data streaming can be controlled
                      using the <code class="filename">bw.xml</code> options in
                      <span class="literal">&lt;baseApp/downloadStreaming&gt;</span>. For details of this
                      option group refer to the <a href="../server_operations_guide/index.html" class="olink">Server Operations Guide</a>
                      section <a href="../server_operations_guide/ch02.html#xref_BaseApp_Configuration_Options" class="olink">BaseApp Configuration Options</a>.
               </p>
               <p>All data types in this streamed data are user-defined, since
                      BigWorld does not have any internal uses for it.
               </p>
               <p>Data is added to a proxy via method
                      <code class="methodname">streamStringToClient</code>:
               </p><pre class="programlisting">id = Proxy.streamStringToClient( id, data )</pre><p>or via method <code class="methodname">streamFileToClient</code>:
               </p><pre class="programlisting">id = Proxy.streamFileToClient( id, resource )</pre><p>Where the parameters are:</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><em class="emphasis"><em class="parameter"><code>id</code></em></em></p>
                        <p>16-bit ID of the data. If <span class="literal">-1</span> is received,
                                   then the next ID in sequence that is not currently in use is selected.
                                   The caller of this method is responsible for the management of this
                                   parameter. The same ID value used by the method is returned to the
                                   caller.
                        </p>
                     </li>
                     <li class="listitem">
                        <p><em class="emphasis"><em class="parameter"><code>data</code></em></em></p>
                        <p>Data to be sent to the attached client. Must be in string
                                   format.
                        </p>
                     </li>
                     <li class="listitem">
                        <p><em class="emphasis"><em class="parameter"><code>resource</code></em></em></p>
                        <p>The string name of the resource to be sent to the client.</p>
                     </li>
                  </ul>
               </div>
               <p>Once the client has received the entire data string, the callback
                      <code class="classname">BWPersonality</code>.<code class="methodname">onStreamComplete</code>
                      is called on the client.
               </p>
            </div>
            <div class="section" title="6.8.&nbsp;Exposed Methods &#8208; Client-to-Server Communication">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_SPG_ExposedMethods"></a>6.8.&nbsp;Exposed Methods <span class="symbol">&#8208;</span>
                               Client-to-Server Communication
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Because MMOGs operate over the Internet, and in order to stop
                      players cheating, server methods (those on the cell or the base) are not
                      automatically allowed to be called by the client.
               </p>
               <p>In order to make a server method callable from the client (so that
                      the world can provide interactivity), its declaration has to include the
                      tag <code class="property">&lt;Exposed/&gt;</code>, as illustrated below:
               </p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">CellMethods</em>&gt;
    &lt;<em class="emphasis">yell</em>&gt;
      &lt;<em class="emphasis">Exposed</em>/&gt;
      &lt;Args&gt;
        &lt;phrase&gt; STRING &lt;/phrase&gt; &lt;!-- phrase to exclaim --&gt;
      &lt;/Args&gt;
    &lt;/yell&gt;
  &lt;/CellMethods&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
                         <span class="symbol">&#8208;</span> Declaration of the exposed
                         method</span></p>
               <p>The tag <code class="property">&lt;Exposed/&gt;</code> accomplishes two
                      things:
               </p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p>It makes the method available to clients.</p>
                     </li>
                     <li class="listitem">
                        <p>On the cell, it acts as an additional argument tag that is
                                   automatically filled in with the entity ID of the client calling
                                   it.
                        </p>
                     </li>
                  </ul>
               </div>
               <p>Client instances actually call the method with one argument fewer
                      than the number received by the cell entity, which prevents
                      'entity-faking' outside the safe server environment. The entity ID needs
                      to be passed as an argument when calling exposed methods from the server
                      components.
               </p>
               <p>The definition of the method on the cell must be extended to take
                      this parameter, as illustrated below:
               </p><pre class="programlisting">import BigWorld
class EntityName(BigWorld.Entity):

  def __init__(self):
    BigWorld.Entity.init(self)

  def <em class="emphasis">yell</em>(self, sourceEntityID, phrase):
    # insert code to implement yell here
    # if desired, check that self.id == sourceEntityID before proceeding
    return</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
                         <span class="symbol">&#8208;</span> Definition of cell method
                         <code class="methodname">yell</code></span></p>
               <p>On the client, the method <code class="methodname">yell</code> can be
                      called with the code below:
               </p><pre class="programlisting">self.cell.yell( "BigWorld message test" )</pre><p><span class="citetitle">Example of a client calling a cell method <em class="emphasis"><code class="methodname">yell</code></em></span></p>
               <p>If the cell method <code class="methodname">yell</code> implements the
                      check of <code class="varname">sourceEntityID</code> against
                      <code class="varname">self</code>.<code class="varname">id</code>, only its client will be
                      able to call it. Others clients will not be able to execute it.
               </p>
               <p>There might be occasions where the method might run with a different
                      <code class="varname">sourceEntityID</code>. For example, for a method called
                      <code class="methodname">shakeHand</code>, it is a good idea to check that the
                      source entity is within a couple of metres away from the
                      <code class="varname">self</code> entity before proceeding (and maybe that neither
                      is dead).
               </p>
               <div class="section" title="6.8.1.&nbsp;Security Considerations of Exposed Methods">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e5655"></a>6.8.1.&nbsp;Security Considerations of Exposed Methods
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>Script writers should be aware that the arguments of any exposed
                           method need to be heavily scrutinised on the server side before being
                           operated on.
                  </p>
                  <p>The underlying C++ code that handles the passing of arguments
                           ensures that the method will be invoked on the server side only
                           if:
                  </p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" type="disc">
                        <li class="listitem">
                           <p>The right number of arguments is being passed.</p>
                        </li>
                        <li class="listitem">
                           <p>The arguments have the expected type.</p>
                        </li>
                     </ul>
                  </div>
                  <p>Beyond that, however, the underlying architecture cannot provide
                           any further constraints on the values that clients may pass to method
                           calls on the server.
                  </p>
                  <p>For example, integers may take any valid 32-bit value, strings and
                           arrays may be of any length, &#8230;. It is up to the script writer to ensure
                           that the arguments to an exposed method have values that make sense in
                           the context of that method.
                  </p>
                  <p>You should carefully inspect the value of any arguments to an
                           exposed method before using them.
                  </p>
                  <p>It is never safe to trust arbitrary Python objects from the client
                           as passed in through <code class="code">PYTHON</code> parameters to exposed method
                           invocations. A <span class="literal">WARNING</span> log message is emitted at
                           startup by any component that parses the entity definitions if an
                           exposed method has parameter of type <code class="code">PYTHON</code>. The safer
                           alternative is to use some other data type that is more concretely
                           defined, for example the <code class="code">FIXED_DICT</code> data type, and validate
                           each known element.
                  </p>
               </div>
            </div>
            <div class="section" title="6.9.&nbsp;Server to Client bandwidth usage of Method calls">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_ServerClientBandwidthMethodCalls"></a>6.9.&nbsp;Server to Client bandwidth usage of Method calls
                        </h2>
                     </div>
                  </div>
               </div>
               <p>The arguments of a method call made from the server to the client are
                  	optimised in the same way property updates are optimised.
               </p>
               <p>See
                  	<a class="xref" href="ch05.html#xref_ServerClientBandwidthPropertyUpdates" title="5.2.&nbsp;Server to Client bandwidth usage of Property updates">Server to Client bandwidth usage of Property updates</a>.
               </p>
            </div>
            <div class="section" title="6.10.&nbsp;Client callbacks on property changes">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Implicit_set_property_name_Methods"></a>6.10.&nbsp;Client callbacks on property changes
                        </h2>
                     </div>
                  </div>
               </div>
               <p>When the server changes a property on the client a callback method
                      is called on the entity to allow the client to take appropriate
                      action.
               </p>
               <p><code class="code">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code> is
                      called when a property of an entity is replaced with a new value. That is,
                      a value in the entity's <code class="code">__dict__</code> is replaced.
               </p>
               <p>If an existing property is modified, either
                      <code class="code">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code> or
                      <code class="code">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code> is
                      called.
               </p>
               <div class="section" title="6.10.1.&nbsp;Implicit set_<property_name&gt; Methods">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e5724"></a>6.10.1.&nbsp;Implicit
                                    <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                                    Methods
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>When the server updates a property with distribution flag
                           <sup>[<a name="d0e5734" href="#ftn.d0e5734" class="footnote">9</a>]</sup> <span class="literal">ALL_CLIENTS</span>,
                           <span class="literal">OTHER_CLIENTS</span> or <span class="literal">OWN_CLIENT</span>, an
                           implicit method called
                           <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                           is called on the client.
                  </p>
                  <p>This method should not need be declared in the section
                           <code class="property">&lt;ClientMethods&gt;</code> of the definition file as it
                           is automatically provided by BigWorld.
                  </p>
                  <p>All implicitly defined
                           <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                           methods have one argument which receives the old value of the property
                           when the method is called. For example:
                  </p><pre class="programlisting">class Seat( BigWorld.Entity ):
    ...
  def <em class="emphasis">set_seatType</em>( self, <em class="emphasis">oldValue</em> ):
    ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Seat.py</code>
                              <span class="symbol">&#8208;</span> Example of an implicit
                              <code class="methodname">set_seatType</code> for the
                              <code class="classname">Seat</code> entity.</span></p>
                  <p>Note that if an existing property is modified instead of being
                           replaced and the appropriate
                           <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                           or
                           <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                           method does not exist, this method is called with the
                           <code class="code">oldValue</code> argument as <code class="code">None</code>.
                  </p>
               </div>
               <div class="section" title="6.10.2.&nbsp;Implicit setNested_<property_name&gt; Methods">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e5807"></a>6.10.2.&nbsp;Implicit
                                    <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                                    Methods
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>If a nested property of an existing property is modified, the
                           <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                           is called. This includes modifying a single element of an
                           <code class="code">ARRAY</code> or <code class="code">FIXED_DICT</code>. The method accepts two
                           arguments. The first represents the path to the change and the second is
                           the value that has been replaced.
                  </p>
                  <p>For example:</p><pre class="programlisting">class Seat( BigWorld.Entity ):
    ...
  def <em class="emphasis">setNested_myFixedDict</em>( self, <em class="emphasis">path</em>, <em class="emphasis">oldValue</em> ):
    ...</pre><p>The first argument represents the path to the changed property.
                           For example, if the change was:
                  </p><pre class="programlisting">self.myFixedDict.rightHandItem.weight = 10</pre><p>The value of path would be:</p><pre class="programlisting">["rightHandItem", "weight"]</pre><p>If you had a property that was <code class="code">ARRAY &lt;of&gt; ARRAY
                              &lt;of&gt; INT32 &lt;/of&gt; &lt;/of&gt;.</code></p><pre class="programlisting">self.myArray[ 5 ][ 3 ] = 8</pre><p>would result with the value of path being:</p><pre class="programlisting">(5, 3)</pre></div>
               <div class="section" title="6.10.3.&nbsp;Implicit setSlice_<property_name&gt; Methods">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e5859"></a>6.10.3.&nbsp;Implicit
                                    <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                                    Methods
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>If a slice of an array is modified, the
                           <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
                           is called. This includes appending and deleting from an array. The
                           method accepts two arguments. The first represents the path to the
                           changed slice and the second is the slice that has been replaced. The
                           last value in the path is a tuple containing two integers. These
                           represent the range of the new values. To create a slice containing the
                           new values, use <code class="code">myModifiedArray[ path[-1][0] : path[-1][1]
                              ]</code>.
                  </p>
                  <p>For example, if <code class="code">self.myArray</code> is an existing array
                           with 5 elements:
                  </p><pre class="programlisting">self.myArray.append( 10 )</pre><p>would result in <code class="methodname">setSlice_myArray</code> being
                           called with:
                  </p><pre class="programlisting">path = [(5,6)]
oldValues = [ ]
newValues = self.myArray[ path[-1][0] : path[-1][1] ]</pre><p>If the array is part of a <code class="code">FIXED_DICT</code> and the array
                           has 5 elements with the last value 21.
                  </p><pre class="programlisting">del self.myFixedDict.myArray[-1]</pre><p>would result in:</p><pre class="programlisting">path = ["myArray", (4,4)]
oldValues = [21]</pre></div>
            </div>
            <div class="section" title="6.11.&nbsp;LOD on Methods">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e5902"></a>6.11.&nbsp;LOD on Methods
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Like properties, some methods need to be broadcast only to nearby
                      entities.
               </p>
               <p>For example, even though an entity may be visible at an AoI distance
                      (say, 500 metres), it seems unlikely that players will be able to tell the
                      difference between a smiling and a non-smiling entity.
               </p>
               <p>To reflect his, the smile method's level of detail, can be declared
                      as illustrated below:
               </p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;ClientMethods&gt;
    ...
    &lt;<em class="emphasis">smile</em>&gt;
      ...
      &lt;<em class="emphasis">DetailDistance</em>&gt; <em class="emphasis">30</em> &lt;/DetailDistance&gt;
    &lt;/smile&gt;
    ...
  &lt;/ClientMethods&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
                         <span class="symbol">&#8208;</span> Declaration of client method
                         <code class="methodname">smile</code></span></p>
               <p>The specification of the LOD for a method is far simpler than it is
                      for a property. This is because a non-broadcast property change might have
                      to be sent later if the LOD increases, while a non-broadcast method in the
                      same scenario will not have to.
               </p>
               <p>Consequently, the method just needs to declare a tag
                      <code class="property">&lt;DetailDistance&gt;</code> inline, and when it is called
                      on exposed objects <code class="varname">allClients</code> or
                      <code class="varname">otherClients</code>, it is broadcast only to clients within
                      the specified distance around the entity.
               </p>
            </div>
            <div class="section" title="6.12.&nbsp;Inter-Entity Communication">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Inter_Entity_Communication"></a>6.12.&nbsp;Inter-Entity Communication
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Once the entities have methods assigned to them, it becomes useful
                      to be able to call methods on other entities.
               </p>
               <p>If you have an object <code class="varname">ent</code> as a Python script
                      representation of another entity, then you can call
                      <code class="varname">ent</code>.<code class="methodname">someMethod</code>() to call that
                      method on <code class="varname">ent</code>. This assumes that
                      <code class="methodname">someMethod</code>() runs on the same execution context
                      you are in. For example, if you are on the cell, then
                      <code class="varname">ent</code>.<code class="methodname">someMethod</code>() must be
                      defined and provided by the entity type of <code class="varname">ent</code>.
               </p>
               <p>If you are on the cell, you can call a method on the base, with the
                      code below:
               </p><pre class="programlisting">ent.base.otherMethod()</pre><p>This means that once you are able to obtain an entity object, there
                      is a plethora of options for invoking methods on different execution
                      contexts of different entity instances. For more details, see <a class="xref" href="ch06.html#xref_Intra_Entity_Communication" title="6.4.&nbsp;Intra-Entity Communication">Intra-Entity Communication</a>.
               </p>
               <p>But to achieve this, first it is necessary to retrieve the object
                      for another entity. The mechanism for that is described in the next
                      sub-section
               </p>
               <div class="section" title="6.12.1.&nbsp;Entity IDs">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e5991"></a>6.12.1.&nbsp;Entity IDs
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>In order to uniquely identify every object in the game universe,
                           BigWorld assigns a unique number to every entity. This is referred to as
                           the entity ID.
                  </p>
                  <p>In the <code class="classname">BigWorld</code> Python module (which is
                           imported at the start of most scripts), there is an object which maps
                           entity IDs to the corresponding entity object. This object has the same
                           interface as a Python dictionary, and is called
                           <code class="classname">BigWorld</code>.<code class="varname">entities</code>.
                  </p>
                  <p>Given an entity id <code class="varname">entityID</code>, its entity object
                           can be retrieved with the code below:
                  </p><pre class="programlisting">ent = BigWorld.entities[ entityID ]</pre><p><span class="citetitle">Retrieval of entity object using its
                              ID</span></p>
                  <p>One should be very careful with entity IDs, and always check for
                           the existence of the corresponding entity before assuming that it is
                           safe to use it.
                           <code class="classname">BigWorld</code>.<code class="varname">entities</code> throws an
                           exception if the entity looked up does not exist.
                  </p>
                  <p>Each execution context has a version of the
                           <code class="classname">BigWorld</code>.<code class="varname">entities</code> object with
                           different entities in it.
                  </p>
                  <p><code class="classname">BigWorld</code>.<code class="varname">entities</code>
                           contains the entities that are relevant to the execution context in
                           which it is located, as listed below:
                  </p>
                  <div class="altrow">
                     <table border="0">
                        <colgroup>
                           <col width="18%" class="col1">
                           <col width="82%" class="col2">
                        </colgroup>
                        <thead>
                           <tr>
                              <th align="left">Execution context</th>
                              <th align="left">Entities listed in
                                                 <code class="classname">BigWorld</code>.<code class="varname">entities</code></th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr>
                              <td align="left">Cell</td>
                              <td align="left">Real and ghosted entities located on all
                                                 cells managed by this cell's CellApp.
                              </td>
                           </tr>
                           <tr>
                              <td align="left">Base</td>
                              <td align="left">Entities located on this base's BaseApp
                                                 <sup>[<a name="d0e6067" href="#ftn.d0e6067" class="footnote">a</a>]</sup>.
                              </td>
                           </tr>
                           <tr>
                              <td align="left">Client</td>
                              <td align="left">Entities in the client's AoI.</td>
                           </tr>
                        </tbody>
                        <tbody class="footnotes">
                           <tr>
                              <td colspan="2">
                                 <div class="footnote">
                                    <p><sup>[<a id="ftn.d0e6067" href="#d0e6067" class="para">a</a>] </sup>For sending messages to bases on other BaseApps, see
                                                           <a class="xref" href="ch06.html#xref_Mailboxes" title="6.13.&nbsp;Mailboxes">Mailboxes</a></p>
                                 </div>
                              </td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
                  <p><span class="citetitle">Entities listed in
                              <code class="classname">BigWorld</code>.<code class="varname">entities</code> per
                              execution context.</span></p>
                  <p>Entity IDs can be obtained in various ways:</p>
                  <div class="orderedlist">
                     <ol class="orderedlist" type="1">
                        <li class="listitem">
                           <p>From exposed methods (client sends entity ID as
                                        argument).
                           </p>
                        </li>
                        <li class="listitem">
                           <p>From the entity object's <code class="varname">id</code>
                                        property.
                           </p>
                           <p>You can pass the object's ID from one execution context to
                                        another (<em class="emphasis">e.g.</em>, from the client to the cell), so
                                        that the other context can obtain the corresponding object. You can
                                        also use this property to obtain the ID of a newly created
                                        entity.
                           </p>
                        </li>
                        <li class="listitem">
                           <p>From various utility methods that one can use to find entity
                                        references.
                           </p>
                           <p>One of these methods is
                                        <code class="methodname">entitiesInRange</code>.<sup>[<a name="d0e6110" href="#ftn.d0e6110" class="footnote">10</a>]</sup>This method is defined for every cell entity, and
                                        returns all entity objects located within a certain distance from
                                        the calling entity. The resulting output can be queried again for
                                        more specific search results.
                           </p>
                           <p>For example, to find all the <code class="classname">Guard</code>
                                        entities within 100 metres of the current entity, you could have the
                                        code below:
                           </p><pre class="programlisting">def findGuards():
  output = []
  for entity in <em class="emphasis">self</em>.<em class="emphasis">entitiesInRange</em>( 100 ):
    if entity.__class__.__name__ == "Guard":
      output += [entity]
  return output</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
                                           <span class="symbol">&#8208;</span> Obtaining ID of surrounding
                                           entities</span></p>
                           <p>Care should be taken when using this approach for entity
                                        discovery as it is a linear search, and hence does not scale well.
                                        Specifically to be avoided are searches over large entity sets that
                                        could be obtained from a search of large distances, or from using
                                        the complete set of entities in
                                        <code class="classname">BigWorld</code>.<code class="varname">entities</code>. For a
                                        small distance however, one would not expect large numbers of
                                        objects (although this depends on the game).
                           </p>
                        </li>
                     </ol>
                  </div>
               </div>
               <div class="section" title="6.12.2.&nbsp;Retrieving Services">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="d0e6154"></a>6.12.2.&nbsp;Retrieving Services
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>While an entity is identified by its <code class="varname">entityID</code>,
                           a service is identified simply by its name, regardless of how many
                           ServiceApps are offering it. Each Service instance is referred to as a
                           service fragment.
                  </p>
                  <p>In the <code class="classname">BigWorld</code> Python module, there is an
                           object which maps the name of a service to the corresponding service
                           fragment on one of the ServiceApps that offer it. This object is called
                           <code class="classname">BigWorld.services</code> and, like
                           <code class="classname">BigWorld.entities</code>, it has the same interface as a
                           Python dictionary.
                  </p>
                  <p>The service
                           <code class="varname"><em class="replaceable"><code>serviceName</code></em></code> can be
                           retrieved using the code below:
                  </p><pre class="programlisting">serviceMailbox = BigWorld.services[ <em class="replaceable"><code>serviceName</code></em> ]</pre><p><span class="citetitle">Retrieval of service using its name</span></p>
                  <p>A service retrieved in this way will be a mailbox to the
                           corresponding service fragment. For details about mailboxes, refer to
                           <a class="xref" href="ch06.html#xref_Mailboxes" title="6.13.&nbsp;Mailboxes">Mailboxes</a>. Once this mailbox is retrieved, the
                           service's methods can be invoked. For example:
                  </p><pre class="programlisting">BigWorld.services[ 'ExampleService' ].myTest( u"This is a test" )</pre></div>
            </div>
            <div class="section" title="6.13.&nbsp;Mailboxes">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="xref_Mailboxes"></a>6.13.&nbsp;Mailboxes
                        </h2>
                     </div>
                  </div>
               </div>
               <p>Mailboxes are used to communicate with entities that are remote,
                      <em class="emphasis">i.e.</em>, not on the current process.
               </p>
               <p>Entities can only access other entities that are running in the same
                      execution context<sup>[<a name="d0e6203" href="#ftn.d0e6203" class="footnote">11</a>]</sup>However, it is often useful to be able to send a message to
                      entities in other execution contexts. For example, an entity may wish to
                      send a message to all members of a chat channel, but the channel might not
                      have all its members located on the same BaseApp as the executing
                      entity.
               </p>
               <p>Mailboxes are used to implement the following properties of an
                      entity:
               </p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><code class="varname">self</code>.<code class="varname">cell</code></p>
                     </li>
                     <li class="listitem">
                        <p><code class="varname">self</code>.<code class="varname">base</code></p>
                     </li>
                     <li class="listitem">
                        <p><code class="varname">self</code>.<code class="varname">ownClient</code></p>
                     </li>
                  </ul>
               </div>
               <p>There are also a special set of mailboxes available for use from the
                      cell which reference other entities in relation to the current entity.
                      These mailboxes are discussed in <a class="xref" href="ch06.html#xref_Mailboxes_Special" title="6.13.1.&nbsp;Special Mailboxes">Special Mailboxes</a>.
               </p>
               <p>These afore mentioned properties (<code class="varname">cell</code>,
                      <code class="varname">base</code>, <code class="varname">ownClient</code>) allow you to
                      reference objects located on different processes, and can be sent like any
                      other value, using method calls, and the <span class="literal">MAILBOX</span> data
                      type.
               </p>
               <p>You can use the <span class="literal">MAILBOX</span> like a normal entity
                      reference, and call methods declared in the entity's definition file on
                      other entities on other processes.
               </p>
               <p>Considering that an entity <em class="emphasis">B</em> (referenced in the
                      following example as <code class="varname">anotherEntity</code>) has a method
                      <code class="methodname">heyThere</code> which takes one argument of type
                      <span class="literal">MAILBOX</span>, an entity <em class="emphasis">A</em> can pass its
                      base mailbox to entity <em class="emphasis">B</em> from the cell, as in the
                      example below:
               </p><pre class="programlisting">anotherEntity.heyThere( <em class="emphasis">self.base</em> )</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;original_entity&gt;</code></em>.py</code>
                         <span class="symbol">&#8208;</span> Passing base mailbox from
                         cell</span></p>
               <p>On the receiving entity <em class="emphasis">B</em> (referenced in the
                      example as <code class="varname">anotherEntity</code>), the calling entities (entity
                      <em class="emphasis">A</em>) base mailbox (as received via the method argument)
                      can be used to call a method <code class="methodname">someMethod</code> on entity
                      <em class="emphasis">A</em>. For example:
               </p><pre class="programlisting">def heyThere( self, <em class="emphasis">originalEntity</em> ):
  <em class="emphasis">originalEntity</em>.<em class="emphasis">someMethod</em>()</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;another_entity&gt;</code></em>.py</code>
                         <span class="symbol">&#8208;</span> Receiving base
                         mailbox</span></p>
               <p>It is also possible to store mailboxes in a class as properties.
                      However this is only useful for base entity mailboxes, since they will not
                      change address as the entity moves around the space.
               </p>
               <p>Cell entity mailboxes should not be stored, because they can change
                      as the entity moves between cells. It is possible to pass cell entity
                      mailboxes to another entity for once-off use, since they are guaranteed to
                      be usable for the time it takes to call a method and have it respond
                      (<em class="emphasis">i.e.</em>, up to approximately 1 second).
               </p>
               <p>Using mailboxes, it is also possible to call methods within a
                      different execution context to that of the mailbox being called. For
                      example, using a base mailbox of an entity (<code class="varname">baseMB</code> in
                      the following code), it is possible to call a cell method of the base
                      entity as follows:
               </p><pre class="programlisting">baseMB.cell.cellMethod()</pre><p><span class="citetitle">Calling a cell method of another entity through its base
                         mailbox</span></p>
               <p>The call is sent to the base entity first, which then calls the cell
                      method from where the base entity resides. Though it is more convenient
                      than calling a base method that in turn calls the cell method, it still
                      takes two hops to call the cell entity.
               </p>
               <p>Available usages are:</p>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><span class="literal">baseMB.cell</span></p>
                     </li>
                     <li class="listitem">
                        <p><span class="literal">baseMB.ownClient</span></p>
                     </li>
                     <li class="listitem">
                        <p><span class="literal">cellMB.base</span></p>
                     </li>
                     <li class="listitem">
                        <p><span class="literal">cellMB.ownClient</span></p>
                     </li>
                  </ul>
               </div>
               <p>These are in fact instances of MailBoxes, and can be passed as
                      method arguments. However, the same restriction applies to
                      <span class="literal">cellMB.base</span> and <span class="literal">cellMB.client</span> as to
                      cell mailboxes <span class="symbol">&#8208;</span> they can change as an
                      entity moves around, and therefore should not be stored for later
                      use.
               </p>
               <p>Note that both <span class="literal">baseMB.ownClient</span> and
                      <span class="literal">cellMB.ownClient</span> refer to their own client only. There
                      are no shortcut calls to <span class="literal">otherClients</span> and
                      <span class="literal">allClients</span>.
               </p>
               <p>A convenient way to obtain other entities' mailboxes is by using the
                      methods
                      <code class="classname">BigWorld</code>.<code class="methodname">lookUpBaseByDBID</code>
                      and
                      <code class="classname">BigWorld</code>.<code class="methodname">lookUpBaseByName</code>
                      on the BaseApp. For more details, see the <a href="../..//api_python/baseapp/index.html" class="olink">BaseApp Python API</a>'s entry <em class="emphasis">Main&nbsp;Page
                         <span class="symbol">&#8594;</span> BigWorld (Module) <span class="symbol">&#8594;</span> Member Functions</em>.
               </p>
               <div class="section" title="6.13.1.&nbsp;Special Mailboxes">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="xref_Mailboxes_Special"></a>6.13.1.&nbsp;Special Mailboxes
                           </h3>
                        </div>
                     </div>
                  </div>
                  <p>On top of the previously discussed mailboxes, the CellApp also
                           offers a special set of mailboxes which can be used to communicate with
                           entities within the AoI of the reference entity.
                  </p>
                  <p>The available mailboxes are:</p>
                  <div class="itemizedlist">
                     <ul class="itemizedlist" type="disc">
                        <li class="listitem">
                           <p><code class="varname"><em class="replaceable"><code>entity</code></em></code>.<code class="varname">allClients</code></p>
                        </li>
                        <li class="listitem">
                           <p><code class="varname"><em class="replaceable"><code>entity</code></em></code>.<code class="varname">otherClients</code></p>
                        </li>
                        <li class="listitem">
                           <p><code class="varname"><em class="replaceable"><code>entity</code></em></code>.<code class="varname">clientEntity(
                                           <em class="replaceable"><code>EntityID</code></em> )</code></p>
                        </li>
                     </ul>
                  </div>
                  <p>The <code class="varname">allClients</code> mailbox will call a method on
                           all client entities that exist in the AoI of the reference entity as
                           well as on the reference entity's <code class="varname">ownClient</code>.
                  </p>
                  <p>The following diagram illustrates a call to the allClients mailbox
                           on Entity A such as <code class="code">A.allClients.chat()</code>. This results in
                           the <code class="methodname">chat()</code> method being called on Entity A on
                           ClientApps A, B and C.
                  </p>
                  <div class="informalfigure">
                     <div class="mediaobject" align="center"><img src="images/allClients.png" align="middle"></div>
                  </div>
                  <p>The <code class="varname">otherClients</code> mailbox, is almost identical
                           to the <code class="varname">allClients</code> mailbox, except that the method
                           being called will not be executed on the reference entity's
                           <code class="varname">ownClient</code>. This is useful for situations where the
                           reference entity's client was the initiator of the action.
                  </p>
                  <p>The following diagram illustrates a call to the otherClients
                           mailbox on Entity A such as <code class="code">A.otherClients.jump()</code>. This
                           results in the <code class="methodname">jump()</code> method being called on
                           Entity A on ClientApps B and C.
                  </p>
                  <div class="informalfigure">
                     <div class="mediaobject" align="center"><img src="images/otherClients.png" align="middle"></div>
                  </div>
                  <p>The most complicated mailbox is <code class="varname">clientEntity(
                              <em class="replaceable"><code>EntityID</code></em> )</code>. This mailbox is used to
                           call a method on an entity that is represented on the reference entity's
                           ClientApp. This is useful for causing a behaviour that is specific to a
                           single Client to only be seen by the interested client, such as a quest
                           giver talking to the player.
                  </p>
                  <p>The following diagram illustrates a call to the clientEntity
                           mailbox on Entity B providing the EntityID of C such as
                           <code class="code">B.clientEntity( C.id ).wave()</code>. This results in the
                           <code class="methodname">wave()</code> method being called on Entity C on
                           ClientApp B.
                  </p>
                  <div class="informalfigure">
                     <div class="mediaobject" align="center"><img src="images/clientEntity.png" align="middle"></div>
                  </div>
               </div>
            </div>
            <div class="section" title="6.14.&nbsp;Method Execution Context">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="d0e6520"></a>6.14.&nbsp;Method Execution Context
                        </h2>
                     </div>
                  </div>
               </div>
               <p>All entity method calls across physical machines are asynchronous.
                      For example, if you execute <span class="literal">self.cell.cellMethod()</span> or
                      <span class="literal">self.client.clientMethod()</span> on a base entity, the call
                      returns immediately without any value. The actual method execution takes
                      place on the machine where the cell or client part of the entity
                      resides.
               </p>
               <p>To inform the calling entity of the execution result you will have
                      to call a function from within the method.
               </p>
               <p>The example below describes the client entity of class
                      <span class="literal">Avatar</span> initiating a sequence of actions to open a door,
                      executing the following steps:
               </p>
               <div class="orderedlist">
                  <ol class="orderedlist" type="1">
                     <li class="listitem">
                        <p>The client method <span class="literal">openDoor</span> of class
                                   <span class="literal">Avatar</span> calls its cell method
                                   <span class="literal">openDoor</span>.
                        </p>
                     </li>
                     <li class="listitem">
                        <p>That method then calls the cell method <span class="literal">unlock</span>
                                   of class <span class="literal">Door</span>, passing <span class="literal">self</span> as
                                   an argument. This way, <span class="literal">Door</span> receives a mailbox of
                                   the cell entity <span class="literal">Avatar</span>, which is later used (with
                                   exposed object client) to call the appropriate cell method on
                                   <span class="literal">Avatar</span>.
                        </p>
                     </li>
                     <li class="listitem">
                        <p>That method then checks the keycard, and using the cell mailbox
                                   (<span class="literal">sourceEntity</span>), makes a call directly to the
                                   appropriate client method of class <span class="literal">Avatar</span> (in this
                                   example, we assume it was successful).
                        </p>
                     </li>
                  </ol>
               </div>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><em class="emphasis">The client entity of the
                                      <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def openDoor( self, doorID ):
    # Call the cell method to open the door
    self.cell.openDoor( doorID )
  ...
  def doorOpenFailed( self, doorID, keycard ):
    # Animation shows the Avatar scratching his head
  ...
  def doorOpenSucceeded( self, doorID, keycard ):
    # Animation shows the door with corresponding doorID opening
  ...</pre><p><span class="citetitle"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>
                                      <span class="symbol">&#8208;</span> Definition of
                                      <span class="literal">door</span> methods</span></p>
                     </li>
                  </ul>
               </div>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><em class="emphasis">The cell entity of the
                                      <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def openDoor( self, doorID ):
    # locate the door
    door = self.locateTheDoor( doorID )
    keycard = self.getKeycardFromInventory()
    door.unlock( self, keycard )
   ...</pre><p><span class="citetitle"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</span>
                                      <span class="symbol">&#8208;</span> Definition of
                                      <span class="literal">methodopenDoor</span></span></p>
                     </li>
                  </ul>
               </div>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><em class="emphasis">The cell entity of the
                                      <span class="literal">Door</span> class:</em></p><pre class="programlisting">class Door( BigWorld.Entity ):
  ...
  def unlock( self, sourceEntity, keycard ):
  # check source is close enough
  # check keycard is good
  if not self.isGoodKeycard( keycard ):
    sourceEntity.client.doorOpenFailed( self.id, keycard )
  else:
    self.isOpen = True
    sourceEntity.client.doorOpenSucceeded( self.id, keycard )
  ...</pre><p><span class="citetitle"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Door.py</span>
                                      <span class="symbol">&#8208;</span> Definition of
                                      <span class="literal">methodunlock</span></span></p>
                     </li>
                  </ul>
               </div>
               <p>The same callback technique is used to return values from a called
                      method.
               </p>
               <p>The example below describes the client entity of class
                      <span class="literal">Avatar</span> initiating a sequence of actions to inquire
                      about an item's description based on its inventory index, executing the
                      following steps:
               </p>
               <div class="orderedlist">
                  <ol class="orderedlist" type="1">
                     <li class="listitem">
                        <p>The client method <span class="literal">investigateInventory</span> of
                                   class <span class="literal">Avatar</span> calls its base method
                                   <span class="literal">itemDescriptionRequest</span>.
                        </p>
                     </li>
                     <li class="listitem">
                        <p>That method then calls its client method
                                   <span class="literal">itemDescriptionReply</span>.
                        </p>
                     </li>
                     <li class="listitem">
                        <p>That method then displays the item's description.</p>
                     </li>
                  </ol>
               </div>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><em class="emphasis">The client entity of the
                                      <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def investigateInventory( self, indexInInventory ):
    # first get the details from the server
    self.base.itemDescriptionRequest( indexInInventory )
    # maybe have a timeout in case server doesn't reply
  ...
  def itemDescriptionReply( self, indexInInventory, desc ):
    # call the callback
    if desc == []:
      GUI.addAlert( "No such item" + str(indexInInventory) )
      return
    GUI.displayItemWindow( indexInInventory, desc )
  ...</pre><p><span class="citetitle">Example
                                      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>
                                      <span class="symbol">&#8208;</span> Definition of inventory
                                      methods</span></p>
                     </li>
                  </ul>
               </div>
               <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                     <li class="listitem">
                        <p><em class="emphasis">The base entity of the
                                      <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def itemDescriptionRequest( self, indexInInventory ):
    try:
      desc = self.generateDescription( indexInInventory )
    except:
      desc = []    # in case no such index
    self.client.itemDescriptionReply( indexInInventory, desc )
  ...</pre><p><span class="citetitle">Example
                                      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</code>
                                      <span class="symbol">&#8208;</span> Definition of
                                      <code class="methodname">itemDescriptionRequest</code></span></p>
                     </li>
                  </ul>
               </div>
               <p>For those entities residing in the same process, the method calls
                      take place synchronously. However, since there is no guarantee that the
                      calling entities and the called ones will always be in the same process,
                      it is better to adopt the callback solution.
               </p>
               <p>A special case is an entity method that is not defined in the
                      entity's definition file
                      (<span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</span>
                      <span class="symbol">&#8208;</span> For details, see <a class="xref" href="ch02.html#xref_The_Definition_File" title="2.2.&nbsp;The Entity Definition File">The Entity Definition File</a>). In this case, the method is always
                      executed synchronously, and is only executed in the process of the caller.
                      For example, a method call on a ghosted entity normally will be delegated
                      to the real one. However, if this method is not defined in the entity's
                      definition file, it will be treated as a usual Python method, and run
                      locally.
               </p>
               <p>This mechanism does save a bit of network traffic between server
                      components, and can return a result immediately to the caller, but it is
                      also limited in that it can only access the read-only ghosted properties.
                      Trying to access non-ghosted properties or to write read-only properties
                      would result in unexpected errors. Unless carefully planned, one should
                      not take advantage of this feature.
               </p>
            </div>
            <div class="footnotes"><br><hr width="100" align="left">
               <div class="footnote">
                  <p><sup>[<a id="ftn.d0e5423" href="#d0e5423" class="para">7</a>] </sup>For more details on how the AoI priority queue works, see <a class="xref" href="ch20.html#xref_Player_AoI_Updates" title="20.3.&nbsp;Player AoI Updates">Player AoI Updates</a>.
                  </p>
               </div>
               <div class="footnote">
                  <p><sup>[<a id="ftn.d0e5457" href="#d0e5457" class="para">8</a>] </sup>For more details on how the AoI priority queue works, see <a class="xref" href="ch20.html#xref_Player_AoI_Updates" title="20.3.&nbsp;Player AoI Updates">Player AoI Updates</a>.
                  </p>
               </div>
               <div class="footnote">
                  <p><sup>[<a id="ftn.d0e5734" href="#d0e5734" class="para">9</a>] </sup>For details on property's distribution flags, see <a class="xref" href="ch05.html#xref_Data_Distribution" title="5.4.&nbsp;Data Distribution">Data Distribution</a></p>
               </div>
               <div class="footnote">
                  <p><sup>[<a id="ftn.d0e6110" href="#d0e6110" class="para">10</a>] </sup>For other methods, please refer to the
                                   <code class="classname">BigWorld</code>.<code class="classname">Entity</code>
                                   class reference in the Base, Cell and Client Python API
                                   documentation.
                  </p>
               </div>
               <div class="footnote">
                  <p><sup>[<a id="ftn.d0e6203" href="#d0e6203" class="para">11</a>] </sup>For more details, see <a class="xref" href="ch06.html#xref_Inter_Entity_Communication" title="6.12.&nbsp;Inter-Entity Communication">Inter-Entity Communication</a></p>
               </div>
            </div>
         </div>
         <div class="navfooter">
            <hr class="navheaderline">
            <table width="95%" align="center" summary="Navigation footer">
               <tr>
                  <td width="38%" align="left"><a accesskey="p" href="ch05.html">Prev</a>&nbsp;
                  </td>
                  <td width="20%" align="center"><a accesskey="u" href="pt01.html">Up</a></td>
                  <td width="37%" align="right">&nbsp;<a accesskey="n" href="ch07.html">Next</a></td>
               </tr>
               <tr>
                  <td width="40%" align="left" valign="top">Chapter&nbsp;5.&nbsp;Properties&nbsp;</td>
                  <td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
                  <td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;7.&nbsp;Inheritance in BigWorld</td>
               </tr>
               <tr>
                  <td colspan="3">Copyright 1999-2012 BigWorld Pty. Ltd. All rights reserved. Proprietary commercial in confidence.
                     		   
                  </td>
               </tr>
            </table>
         </div>
      </div>
   </body>
</html>