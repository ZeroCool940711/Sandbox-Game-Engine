<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Server Web Integration Guide</title><link rel="stylesheet" type="text/css" href="../css/bigworld.css"><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div id="bigworld-header"><img src="http://try.bigworldtech.com/bigworld/image.php?img=bigworld_logo.gif&amp;svn=$HeadURL: http://patchsvn/svn/evaluation/official/IndiePackage/2.1/current/bigworld/doc/html/server_web_integration/server_web_integration.html $" alt="bw logo"></div><div id="content"><div class="book" title="Server Web Integration Guide"><div class="titlepage"><div><div><h1 class="title"><a name="Server_Web_Integration"></a>Server Web Integration Guide</h1></div><div><p class="releaseinfo">BigWorld Technology 2.1. Released 2012.</p></div><div><p class="copyright">Copyright &copy; 1999-2012 BigWorld Pty Ltd. All rights reserved. </p></div><div><div class="legalnotice" title="Legal Notice"><a name="d0e17"></a><p>This document is proprietary commercial in confidence and access
  is restricted to authorised users. This document is protected by
  copyright laws of Australia, other countries and international treaties.
  Unauthorised use, reproduction or distribution of this document, or any
  portion of this document, may result in the imposition of civil and
  criminal penalties as provided by law.</p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_Web_Integration_Reference">1. Overview</a></span></dt><dt><span class="part"><a href="#d0e39">I. Exposing the BigWorld Server as a Web Service</a></span></dt><dd><dl><dt><span class="chapter"><a href="#xref_TwistedWeb_Service">2. The TwistedWeb Service</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e126">2.1. An example</a></span></dt><dt><span class="section"><a href="#xref_DB_Queries">2.2. Queries to <span class="literal">/db/</span></a></span></dt><dt><span class="section"><a href="#d0e204">2.3. Queries to <span class="literal">/entities_by_id/</span></a></span></dt><dt><span class="section"><a href="#d0e247">2.4. Queries to <span class="literal">/entities_by_name/</span></a></span></dt><dt><span class="section"><a href="#d0e260">2.5. Queries to <span class="literal">/global_entities/</span></a></span></dt><dt><span class="section"><a href="#d0e284">2.6. Implementation details</a></span></dt><dt><span class="section"><a href="#xref_TwistedWebErrorHandling">2.7. TwistedWeb Error handling</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Remote_Methods_With_Return_Values">3. Remote Methods, Arguments and Return Values</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e369">3.1. Method calls</a></span></dt><dt><span class="section"><a href="#d0e385">3.2. Arguments</a></span></dt><dt><span class="section"><a href="#d0e437">3.3. Return Values</a></span></dt><dt><span class="section"><a href="#d0e457">3.4. One way calls</a></span></dt><dt><span class="section"><a href="#d0e464">3.5. Errors</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Keep_Alive_Messages">4. Keep-alive Messages</a></span></dt></dl></dd><dt><span class="part"><a href="#d0e529">II. Using the Web Service from Apache</a></span></dt><dd><dl><dt><span class="chapter"><a href="#xref_Default_Implementation">5. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e556">5.1. Security</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d0e565">6. Configuring Apache</a></span></dt><dt><span class="chapter"><a href="#xref_PHP">7. PHP</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e643">7.1. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e646">7.1.1. Installing PHP</a></span></dt><dt><span class="section"><a href="#d0e663">7.1.2. Testing</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e683">7.2. BigWorld.php</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_BigWorld_php_Error_Handling">7.2.1. BigWorld.php Error handling</a></span></dt><dt><span class="section"><a href="#d0e886">7.2.2. Locating the ServiceApp</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e907">7.3. RemoteEntity Session Storage</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#d0e935">III. Web Integration Example</a></span></dt><dd><dl><dt><span class="chapter"><a href="#xref_Auction_House_Implementation">8. Overview</a></span></dt><dt><span class="chapter"><a href="#d0e1022">9. Use Cases</a></span></dt><dt><span class="chapter"><a href="#d0e1047">10. PHP Presentation Layer</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1055">10.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e1075">10.2. Required packages</a></span></dt><dt><span class="section"><a href="#d0e1091">10.3. Constants in <code class="filename">Constants.php</code></a></span></dt><dt><span class="section"><a href="#d0e1111">10.4. XHTML-MP helper functions</a></span></dt><dt><span class="section"><a href="#d0e1223">10.5. Debugging PHP example scripts</a></span></dt><dt><span class="section"><a href="#d0e1283">10.6. <code class="classname">XHTMLMPPage</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1326">10.7. <code class="classname">AuthenticatedXHTMLMPPage</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1369">10.8. <code class="classname">BWAuthenticator</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1407">10.9. <code class="filename">Login.php</code></a></span></dt><dt><span class="section"><a href="#d0e1435">10.10. <code class="filename">Characters.php</code></a></span></dt><dt><span class="section"><a href="#d0e1477">10.11. <code class="filename">News.php</code></a></span></dt><dt><span class="section"><a href="#d0e1493">10.12. <code class="filename">Character.php</code></a></span></dt><dt><span class="section"><a href="#d0e1509">10.13. <code class="filename">Inventory.php</code></a></span></dt><dt><span class="section"><a href="#d0e1553">10.14. <code class="filename">PlayerAuctions.php</code></a></span></dt><dt><span class="section"><a href="#d0e1572">10.15. <code class="filename">SearchAuctions.php</code></a></span></dt><dt><span class="section"><a href="#xref_PHP_Error_Handling">10.16. PHP Error handling</a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter" title="Chapter&nbsp;1.&nbsp;Overview"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Web_Integration_Reference"></a>Chapter&nbsp;1.&nbsp;Overview</h2></div></div></div><p>This document describes how a web interface can be constructed that
  accesses script-level BigWorld functionality. Web browsers, smart phones and
  other web-aware devices can then be used to access game functionality. It
  also demonstrates how to provide a lower level web service interface to the
  game server that can be used by other services.</p><p>This document is broken up into three parts:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Exposing the BigWorld server as a web service: this section
      explains the core elements of BigWorld that are used as the basis for
      web integration. Web integration is usually implemented using a Service
      running on ServiceApps. Twisted.Web is used to provide a HTTP interface
      for making script calls on the server.</p></li><li class="listitem"><p>Using the web service from Apache: this section describes using
      PHP to implement a website that interfaces with the BigWorld
      server.</p></li><li class="listitem"><p>Web integration example: this section details the implementation
      of an Auction House in FantasyDemo. It is intended to be used to
      demonstrate a website integrated with BigWorld.</p></li></ol></div><p>Note that while Apache and PHP are used for the implementation of
  these examples, it is possible to use other languages or servers to
  implement web integration.</p></div><div class="part" title="Part&nbsp;I.&nbsp;Exposing the BigWorld Server as a Web Service"><div class="titlepage"><div><div><h1 class="title"><a name="d0e39"></a>Part&nbsp;I.&nbsp;Exposing the BigWorld Server as a Web Service</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_TwistedWeb_Service">2. The TwistedWeb Service</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e126">2.1. An example</a></span></dt><dt><span class="section"><a href="#xref_DB_Queries">2.2. Queries to <span class="literal">/db/</span></a></span></dt><dt><span class="section"><a href="#d0e204">2.3. Queries to <span class="literal">/entities_by_id/</span></a></span></dt><dt><span class="section"><a href="#d0e247">2.4. Queries to <span class="literal">/entities_by_name/</span></a></span></dt><dt><span class="section"><a href="#d0e260">2.5. Queries to <span class="literal">/global_entities/</span></a></span></dt><dt><span class="section"><a href="#d0e284">2.6. Implementation details</a></span></dt><dt><span class="section"><a href="#xref_TwistedWebErrorHandling">2.7. TwistedWeb Error handling</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Remote_Methods_With_Return_Values">3. Remote Methods, Arguments and Return Values</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e369">3.1. Method calls</a></span></dt><dt><span class="section"><a href="#d0e385">3.2. Arguments</a></span></dt><dt><span class="section"><a href="#d0e437">3.3. Return Values</a></span></dt><dt><span class="section"><a href="#d0e457">3.4. One way calls</a></span></dt><dt><span class="section"><a href="#d0e464">3.5. Errors</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Keep_Alive_Messages">4. Keep-alive Messages</a></span></dt></dl></div><div class="chapter" title="Chapter&nbsp;2.&nbsp;The TwistedWeb Service"><div class="titlepage"><div><div><h2 class="title"><a name="xref_TwistedWeb_Service"></a>Chapter&nbsp;2.&nbsp;The TwistedWeb Service</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e126">2.1. An example</a></span></dt><dt><span class="section"><a href="#xref_DB_Queries">2.2. Queries to <span class="literal">/db/</span></a></span></dt><dt><span class="section"><a href="#d0e204">2.3. Queries to <span class="literal">/entities_by_id/</span></a></span></dt><dt><span class="section"><a href="#d0e247">2.4. Queries to <span class="literal">/entities_by_name/</span></a></span></dt><dt><span class="section"><a href="#d0e260">2.5. Queries to <span class="literal">/global_entities/</span></a></span></dt><dt><span class="section"><a href="#d0e284">2.6. Implementation details</a></span></dt><dt><span class="section"><a href="#xref_TwistedWebErrorHandling">2.7. TwistedWeb Error handling</a></span></dt></dl></div><p>It is often useful to create a Web Service interface to a BigWorld
  server. This allows other standard services to be used to access game
  functionality via standard HTTP requests.</p><p>One way to expose a web service interface is to use the TwistedWeb
  Service provided. This uses the Twisted Python framework and its Twisted.Web
  module to map HTTP requests to script calls on game entities. Any of an
  entity's methods can be called on it in this way.</p><p>See <a class="ulink" href="http://twistedmatrix.com/documents/current/web" target="_top">http://twistedmatrix.com/documents/current/web</a>
  for more detailed information on Twisted.Web.</p><p>A BigWorld Service is a scripted object like a Base-only entity. See
  <a href="../server_overview/server_overview.html#Server_Overview" class="olink">Server Overview</a>'s section <a href="../server_overview/server_overview.html#xref_Design_Introduction" class="olink"><i>Design Introduction</i></a> for more
  information.</p><p>BigWorld provides a standard TwistedWeb Service located at
  <code class="filename">bigworld/res/scripts/service/TwistedWeb.py</code>. This
  service listens for HTTP requests on port 8000. It supports four types of
  URL paths.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="literal">db/<em class="replaceable"><code>&lt;dbCommand&gt;</code></em>?<em class="replaceable"><code>&lt;arguments&gt;</code></em></span>
        - This is used to invoke a command on the database such as logging on
        a player's entity.</p></li><li class="listitem"><p><span class="literal">entities_by_id/<em class="replaceable"><code>&lt;entityType&gt;</code></em>/<em class="replaceable"><code>&lt;databaseID&gt;</code></em>/<em class="replaceable"><code>&lt;methodName&gt;</code></em>?<em class="replaceable"><code>&lt;arguments&gt;</code></em></span>
        - This calls a method on an entity.</p></li><li class="listitem"><p><span class="literal">entities_by_name/<em class="replaceable"><code>&lt;entityType&gt;</code></em>/<em class="replaceable"><code>&lt;entityName&gt;</code></em>/<em class="replaceable"><code>&lt;methodName&gt;</code></em>?<em class="replaceable"><code>&lt;arguments&gt;</code></em></span>
        - This calls a method on a named entity.</p></li><li class="listitem"><p><span class="literal">global_entities/<em class="replaceable"><code>&lt;globalName&gt;</code></em>/<em class="replaceable"><code>&lt;methodName&gt;</code></em>?<em class="replaceable"><code>&lt;arguments&gt;</code></em></span>
        - This calls a method on an entity in
        <code class="code">BigWorld.globalBases</code>.</p></li></ul></div><p>The responses to these requests are structured as JSON
  documents.</p><div class="section" title="2.1.&nbsp;An example"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e126"></a>2.1.&nbsp;An example</h2></div></div></div><p>For example, in FantasyDemo, the method <code class="code">webTestMethod</code>
    for the global entity <code class="code">AuctionHouse</code> is used to test the
    functionality of method calls using Twisted.Web.</p><p>In
    <code class="filename">fantasydemo/res/scripts/entity_defs/AuctionHouse.def</code>,
    the method is declared as:</p><pre class="programlisting">...
&lt;BaseMethods&gt;
  ...
  &lt;webTestMethod&gt;

    &lt;Args&gt;
      &lt;first_arg&gt; INT32 &lt;/first_arg&gt;
      &lt;second_arg&gt; STRING &lt;/second_arg&gt;
    &lt;/Args&gt;

    &lt;ReturnValues&gt;
      &lt;first_result&gt; INT32 &lt;/first_result&gt;
      &lt;second_result&gt; STRING &lt;/second_result&gt;
    &lt;/ReturnValues&gt;

  &lt;/webTestMethod&gt;
  ...</pre><p>And in fantasydemo/res/scripts/base/AuctionHouse.py as:</p><pre class="programlisting">class AuctionHouse( ... ):
    ...
    def webTestMethod( self, first_arg, second_arg ):
        return (2 * first_arg, second_arg.upper())</pre><p>An instance of AuctionHouse has been registered with
    <code class="code">BigWorld.globalBases</code> as <code class="code">'AuctionHouse'</code>.</p><p>Therefore, requesting:</p><pre class="programlisting"><span class="literal">http://<em class="replaceable"><code>machine_name</code></em>:8000/global_entities/AuctionHouse/webTestMethod?first_arg=5&amp;second_arg=Test</span></pre><p>
    returns the JSON object:</p><pre class="programlisting">{ "first_result": 10, "second_result": "TEST" }</pre></div><div class="section" title="2.2.&nbsp;Queries to /db/"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_DB_Queries"></a>2.2.&nbsp;Queries to <span class="literal">/db/</span></h2></div></div></div><p>There is currently only one command supported by the
    <span class="literal">/db/</span> path. This has the form:</p><pre class="programlisting">http://<em class="replaceable"><code>machine_name</code></em>:8000/db/logOn?username=<em class="replaceable"><code>username</code></em>&amp;password=<em class="replaceable"><code>password</code></em></pre><p>This attempts to log on the user. On success it returns the new
    entity's type and database id. For example,</p><pre class="programlisting">{ "type": "Account", "id": 2 }</pre><p>This information can then be used to make queries on this entity
    using the path starting with
    <span class="literal">/entities_by_id/<em class="replaceable"><code>&lt;entity_type&gt;</code></em>/<em class="replaceable"><code>&lt;database_id&gt;</code></em>/<em class="replaceable"><code>&lt;methodName&gt;</code></em></span>.</p></div><div class="section" title="2.3.&nbsp;Queries to /entities_by_id/"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e204"></a>2.3.&nbsp;Queries to <span class="literal">/entities_by_id/</span></h2></div></div></div><p>Queries of the form
    <span class="literal">/entities_by_id/<em class="replaceable"><code>&lt;entity_type&gt;</code></em>/<em class="replaceable"><code>&lt;database_id&gt;</code></em>/<em class="replaceable"><code>&lt;methodName&gt;</code></em>?<em class="replaceable"><code>&lt;args&gt;</code></em></span>
    can be used to call methods on a specific entity.</p><p>For example, requesting:</p><pre class="programlisting"><span class="literal">http://<em class="replaceable"><code>machine_name</code></em>:8000/entities_by_id/Account/2/webGetCharacterList</span></pre><p>might return:</p><pre class="programlisting">{ "characters": [{"type": "Avatar", "databaseID": 1, "realm": "fantasy", "charClass": "ranger", "name": "MyChar"}] }</pre><p>The details of one of the characters on this account can be
    retrieved using
    <span class="literal">http://<em class="replaceable"><code>machine_name</code></em>:8000/entities_by_id/Account/2/webChooseCharacter?name=MyChar&amp;type=Avatar</span>:</p><pre class="programlisting">{ "type": "Avatar", "id": 1 }</pre></div><div class="section" title="2.4.&nbsp;Queries to /entities_by_name/"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e247"></a>2.4.&nbsp;Queries to <span class="literal">/entities_by_name/</span></h2></div></div></div><p>These queries are similar to <span class="literal">entities_by_id</span>
    expect that the database string identifier is expected instead of the
    database id. The <span class="literal">entities_by_id</span> form is preferred as
    queries by name need to query the database each time while repeated
    queries via database id will likely hit a local cache of the entity's
    mailbox on the ServiceApp. See KeepAlive messages below.</p></div><div class="section" title="2.5.&nbsp;Queries to /global_entities/"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e260"></a>2.5.&nbsp;Queries to <span class="literal">/global_entities/</span></h2></div></div></div><p>These queries allow calling methods on a base entity that has been
    registered with <code class="code">BigWorld.globalBases</code>. The base entity must be
    registered with a single string as the key. These queries have the
    form:</p><pre class="programlisting"><span class="literal">http://<em class="replaceable"><code>machine_name</code></em>:8000/global_entities/<em class="replaceable"><code>&lt;global_key&gt;</code></em>/<em class="replaceable"><code>&lt;methodName&gt;</code></em>?<em class="replaceable"><code>&lt;args&gt;</code></em></span></pre></div><div class="section" title="2.6.&nbsp;Implementation details"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e284"></a>2.6.&nbsp;Implementation details</h2></div></div></div><p>The TwistedWeb service is defined in
    <code class="filename">bigworld/res/scripts/service_defs/TwistedWeb.def</code>, and
    its methods are implemented in
    <code class="filename">bigworld/res/scripts/service/TwistedWeb.py</code>. Here, the
    resource tree is built up using Twisted.Web's <code class="code">putChild</code>
    function, which takes as arguments the name of the path segment and the
    type of the resource that will be returned by a request for it:</p><pre class="programlisting">from TWResources.EntitiesResource import EntitiesByNameResource, EntitiesByIDResource
from TWResources.GlobalEntitiesResource import GlobalEntitiesResource
from TWResources.DBResource import DBResource

class TwistedWeb( BigWorld.Service ):
    def __init__( self ):
        root = resource.Resource()
        root.putChild( "entities_by_name", EntitiesByNameResource() )
        root.putChild( "entities_by_id", EntitiesByIDResource() )
        root.putChild( "global_entities", GlobalEntitiesResource() )
        root.putChild( "db", DBResource() )

        reactor.listenTCP( 8000, server.Site( root ) )
        reactor.startRunning()
  
    def onDestroy( self ):
        reactor.stop()</pre><p>The various resources used by the TwistedWeb service are implemented
    in the <span class="package">TWResources</span> package, which is located at
    <code class="filename">bigworld/res/scripts/service/TWResources</code>.</p><p>In order to make use of the TwistedWeb service, it must be given an
    entry in the
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/services.xml</code>
    file in your project directory:</p><pre class="programlisting">&lt;root&gt;
    ...
    &lt;TwistedWeb/&gt;
&lt;/root&gt;</pre><p>This file contains a list of all Services that will be initialised
    when a ServiceApp process is started.</p><p>See <a class="ulink" href="http://twistedmatrix.com/documents/current/web" target="_top">http://twistedmatrix.com</a>
    for more detailed information on the Twisted Python framework.</p></div><div class="section" title="2.7.&nbsp;TwistedWeb Error handling"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_TwistedWebErrorHandling"></a>2.7.&nbsp;TwistedWeb Error handling</h2></div></div></div><p>Two-way calls to the game server using the TwistedWeb service will
    always return a JSON object. If an error occurs, the object that is
    returned will have a specific error format. It will consist of two fields:
    a string named <code class="varname">excType</code> containing the error type, and
    an array of strings named <code class="varname">args</code> containing the
    arguments. The returned document also uses the HTTP error code 403
    (Forbidden).</p><p>For example, the sample <span class="literal">/db/</span> queries given in
    section <a class="xref" href="#xref_DB_Queries" title="2.2.&nbsp;Queries to /db/">Queries to <span class="literal">/db/</span></a> could fail in a number of ways.
    If the account does not exist on the server, the call will
    return:</p><pre class="programlisting">{ "excType": "BWAuthenticateError", "args": [ "No such user" ] }</pre><p>If the password is invalid, it will return:</p><pre class="programlisting">{ "excType": "BWAuthenticateError", "args": [ "Invalid password" ] }</pre><p>The
    regular format of error objects returned from TwistedWeb means that
    differentiating them from successful return objects only requires the
    caller to check for the existence of the <code class="varname">excType</code>
    key.</p><p>For details about the different types of errors that can be returned
    by a two-way call, refer to the<a href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>'s section<a href="../server_programming_guide/server_programming_guide.html#xref_BWStandardError" class="olink">BWStandardError</a>.</p></div></div><div class="chapter" title="Chapter&nbsp;3.&nbsp;Remote Methods, Arguments and Return Values"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Remote_Methods_With_Return_Values"></a>Chapter&nbsp;3.&nbsp;Remote Methods, Arguments and Return Values</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e369">3.1. Method calls</a></span></dt><dt><span class="section"><a href="#d0e385">3.2. Arguments</a></span></dt><dt><span class="section"><a href="#d0e437">3.3. Return Values</a></span></dt><dt><span class="section"><a href="#d0e457">3.4. One way calls</a></span></dt><dt><span class="section"><a href="#d0e464">3.5. Errors</a></span></dt></dl></div><p>The <span class="literal">TwistedWeb</span> service allows calls to one-way and
  two-way methods on game entities. These can be made using the request paths
  as described above.</p><p>This chapter gives more details about format of the arguments in the
  query string, the returned results and the supported types.</p><div class="section" title="3.1.&nbsp;Method calls"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e369"></a>3.1.&nbsp;Method calls</h2></div></div></div><p>Any method of a base entity can be called whether it is exposed to
    clients using the <span class="literal">&lt;Exposed/&gt;</span> tag or not. The
    method name is the last part of the URL before the parameter list (i.e.
    before any <span class="literal">?</span> character). Care must be taken to ensure
    that general access to call methods on the <span class="literal">TwistedWeb</span>
    service is not given.</p><p>To call a method on a cell entity, first call a method on a base
    entity that returns the result of a call on the cell entity.</p></div><div class="section" title="3.2.&nbsp;Arguments"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e385"></a>3.2.&nbsp;Arguments</h2></div></div></div><p>The arguments are passed as URL parameters. All arguments are named
    and so must be named in the entity's <code class="filename">.def</code> file.</p><p>Not all types are supported. Supported types include:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>All integer types - INT8, INT16, INT32, INT64, UINT8, UINT16,
        UINT32 and UINT64</p></li><li class="listitem"><p>All float types - FLOAT32 and FLOAT64</p></li><li class="listitem"><p>All string types - STRING, UNICODE_STRING and BLOB</p></li><li class="listitem"><p>VECTOR2, VECTOR3 and VECTOR4</p></li><li class="listitem"><p>Sequence types - ARRAY and TUPLE of these types except for other
        sequence types</p></li></ul></div><p>UNICODE_STRING parameters should be percent-encoded for UTF-8, such
    as:</p><pre class="programlisting">myString=Japanese%20translation%3A%20%E6%96%87%E5%AD%97%E5%8C%96%E3%81%91</pre><p>This string will result in the argument:</p><pre class="programlisting">Japanese translation: <span class="japanese">&#25991;&#23383;&#21270;&#12369;</span></pre><p>BLOB parameters should be passed as a hexidecimal representation,
    for example:</p><pre class="programlisting">myBLOB=aca3a6</pre><p>VECTOR2, VECTOR3 and VECTOR4 should be passed as a comma separated
    sequence of floats, for example:</p><pre class="programlisting">myVector=0.1,3.5,-6</pre><p>Sequences can be passed in two ways - either as repeated
    arguments:</p><pre class="programlisting">myArray=4&amp;myArray=53</pre><p>or as indexed arguments:</p><pre class="programlisting">myArray[0]=4&amp;myArray[1]=53</pre></div><div class="section" title="3.3.&nbsp;Return Values"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e437"></a>3.3.&nbsp;Return Values</h2></div></div></div><p>Return values are returned as a JSON document of name/value pairs.
    These are encoded using the Python <span class="literal">json</span> module. Any
    type that can be converted with this module can be used. Additionally
    <code class="code">Vector2</code>, <code class="code">Vector3</code>, <code class="code">Vector4</code> and
    <code class="code">PyArrayDataInstance</code> data types are converted to Python lists
    before this conversion.</p></div><div class="section" title="3.4.&nbsp;One way calls"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e457"></a>3.4.&nbsp;One way calls</h2></div></div></div><p>It is also possible to call one-way methods. On success, the
    following object is always returned.</p><pre class="programlisting">{"message": "One way call made"}</pre></div><div class="section" title="3.5.&nbsp;Errors"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e464"></a>3.5.&nbsp;Errors</h2></div></div></div><p>Errors are returned as a specially formatted JSON object with an
    "excType" attribute. Refer to <a class="xref" href="#xref_TwistedWebErrorHandling" title="2.7.&nbsp;TwistedWeb Error handling">TwistedWeb Error handling</a> for more information.</p></div></div><div class="chapter" title="Chapter&nbsp;4.&nbsp;Keep-alive Messages"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Keep_Alive_Messages"></a>Chapter&nbsp;4.&nbsp;Keep-alive Messages</h2></div></div></div><p>Mailboxes to entities residing on a BaseApp should exist for as long
  as they are needed by the web server. However, these same entities may be
  player entities controlled by the BigWorld client. These two different
  usages of the same entity must be reconciled when it comes to managing
  entity lifetimes &#8212; for example, if the client disconnects while the
  game's web interface is still using the player's base entity, this entity
  should not be destructed until the game's web interface has finished with
  it. Also, if the player is currently not logged in via the BigWorld client.
  If the player does not explicitly log out of the web server, we would want
  to clean up that mailbox reference after an inactivity period.</p><p>The solution to this problem is for the <span class="literal">TwistedWeb</span>
  service to periodically inform the base entity that it is still interested
  in it. The entity can then stay around even if the client has disconnected
  (destruction of the base entity is the normal course of action).</p><p>The <span class="literal">TwistedWeb</span> service keeps a cache of mailboxes.
  Only mailboxes to entities that have a
  <code class="methodname">webKeepAlivePing()</code> method are cached. Each time the
  service is queried that uses one of these mailboxes it is either added to
  this cache or marked with the time it was last queried.</p><p>The service will periodically check all mailboxes in this cache. If
  the mailbox has not been used for a long time, it is removed from the cache.
  If it is still active, the <code class="methodname">webKeepAlivePing()</code>
  method is called on it.</p><p>It is okay if the mailbox is removed from the cache too early. In this
  case, the database will be queried to retrieve the mailbox. This is
  important when running multiple <code class="code">TwistedWeb</code> service fragments on
  different ServiceApps. Besides a very minor performance impact on the
  database, it does not matter which ServiceApp is queried. Running the
  service on multiple ServiceApps is a way to achieve fault tolerance and also
  scaling beyond a single machine.</p><p>This functionality is implemented in
  <code class="filename">bigworld/res/scripts/service/TWResources/KeepAliveMailboxes.py</code>.
  The frequency of the pings is specified by the
  <code class="varname">CHECK_PERIOD</code> constant. The amount of time before a
  mailbox times out is specified by the <code class="varname">TIMEOUT_PERIOD</code>
  constant.</p><p>For game script, entities can make use of the
  <code class="classname">KeepAlive</code> class located in
  <code class="filename">fantasydemo/res/scripts/base/KeepAlive.py</code> to implement
  this functionality. It also has <code class="varname">CHECK_PERIOD</code> and
  <code class="varname">TIMEOUT_PERIOD</code> constants specifying how frequently to
  check for these entities timing out and how long before they time out. This
  timeout period should be slightly more than that of
  <code class="filename">KeepAliveMailboxes.py</code>.</p><p>When accessing this service from a website, keep-alive intervals can
  be used with HTTP session timeouts so that players have to re-login after a
  certain inactivity period to create a new HTTP session. Keep-alive intervals
  should be set to be equal to or longer than session durations.</p></div></div><div class="part" title="Part&nbsp;II.&nbsp;Using the Web Service from Apache"><div class="titlepage"><div><div><h1 class="title"><a name="d0e529"></a>Part&nbsp;II.&nbsp;Using the Web Service from Apache</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_Default_Implementation">5. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e556">5.1. Security</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d0e565">6. Configuring Apache</a></span></dt><dt><span class="chapter"><a href="#xref_PHP">7. PHP</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e643">7.1. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e646">7.1.1. Installing PHP</a></span></dt><dt><span class="section"><a href="#d0e663">7.1.2. Testing</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e683">7.2. BigWorld.php</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_BigWorld_php_Error_Handling">7.2.1. BigWorld.php Error handling</a></span></dt><dt><span class="section"><a href="#d0e886">7.2.2. Locating the ServiceApp</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e907">7.3. RemoteEntity Session Storage</a></span></dt></dl></dd></dl></div><div class="chapter" title="Chapter&nbsp;5.&nbsp;Overview"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Default_Implementation"></a>Chapter&nbsp;5.&nbsp;Overview</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e556">5.1. Security</a></span></dt></dl></div><p>This section describes a possible method for allowing BigWorld
  functionality to be integrated into a web server by making use of the web
  service interface described above. It uses a Linux-based Apache web server
  setup using PHP (related to the <em class="emphasis">LAMP architecture</em>) and
  interfaces to the BigWorld service via the <span class="literal">TwistedWeb</span>
  service. It assumes familiarity with concepts presented in the document
  <a href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>.</p><p>The following diagram shows the standard cluster model, shaded, on the
  left-hand side, as well as an example of a web integration implementation
  using an Apache server to provide a web service. For security, ServiceApps
  will usually not be connected to the internet. Web clients will access the
  service via the Apache web server, which will communicate with one of the
  ServiceApps configured to provide the Service. There will usually be
  multiple ServiceApps providing each Service, for the purposes of load
  balancing and fault tolerance.</p><div class="informalfigure"><div class="mediaobject"><img src="images/example_deployment_configuration.png"><span class="caption"><p>Example configuration of a web service</p></span></div></div><p>It should also be noted that while accessing the TwistedWeb service in
  this way is common, there are many other uses for the TwistedWeb service.
  Examples include custom administrative tools and statistic gathering
  scripts.</p><div class="section" title="5.1.&nbsp;Security"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e556"></a>5.1.&nbsp;Security</h2></div></div></div><p>Web security should be a part of all web applications. Therefore,
    when implementing a BigWorld-aware web application, care must be taken to
    ensure that users are not able to access privileged information or have
    unlimited privileged access to the game script interface.</p><p>From a low-level security point of view, Apache supports HTTPS
    transport that is transparent to modules used for PHP. For details on how
    to enable this feature, see the Apache documentation.</p><p>From a scripting point of view, much of what is relevant to other
    web applications with regards to security applies equally to
    BigWorld-aware web applications. Because the web integration module must
    be run inside the cluster, care must be taken when designing interfaces to
    the game. For example, the standard for web applications is to not expose
    the database backend to users by giving them access to executing raw shell
    commands or SQL statements. In the same way, do not give users
    inappropriate privileged access to the BigWorld backend by giving them the
    ability to run arbitrary script commands. The web integration module does
    not have the same concepts of Areas of Interest or client controlled
    entities, so extra care must be taken when accessing game state using this
    interface.</p></div></div><div class="chapter" title="Chapter&nbsp;6.&nbsp;Configuring Apache"><div class="titlepage"><div><div><h2 class="title"><a name="d0e565"></a>Chapter&nbsp;6.&nbsp;Configuring Apache</h2></div></div></div><p>The default web integration implementation uses at its core an Apache
  http server. The binary for the server is called
  <code class="filename">httpd</code>, and it is generally run as a
  daemon. The binary package and the installation instructions for it can be
  found at <a class="ulink" href="http://apache.org" target="_top">http://apache.org</a>.</p><p>Before the server can be accessed, Apache must be told where to find
  the appropriate server files. This involves putting a symbolic link to the
  appropriate directory in Apache's <span class="literal">DocumentRoot</span>, for
  example <code class="filename">/var/www/html/</code>. For example,
  in FantasyDemo, the path to the server files might be <code class="filename">/home/mf/fantasydemo/src/web/php/</code>, so in order
  for Apache to be able to find these files, a symbolic link to that path must
  be placed in <code class="filename">/var/www/html/</code>. To do
  this for FantasyDemo, run the following as root:</p><pre class="programlisting"># ln -s /home/mf/fantasydemo/src/web/php/ /var/www/html/fantasydemo</pre><p>The name of the link will be used as the URL segment after the server
  address, for example, if the link is called <span class="literal">fantasydemo</span>,
  as in the command above, then the URL for the server will be
  <span class="literal"><em class="replaceable"><code>&lt;machine
  address&gt;</code></em>/fantasydemo</span>.</p><p>Make sure that the Apache configuration directive
  <span class="literal">FollowSymlinks</span> is on for the directory containing the
  symlink, and that the web server user has full read access to the target
  directory, for example <code class="filename">/home/mf/fantasydemo/src/web/php</code>, and all
  individual directories in its absolute path. This is likely to require
  modification only at the top level: the server user's home directory. To
  grant read access, run the following as root:</p><pre class="programlisting"># chmod o+rx /home/<em class="replaceable"><code>&lt;server-user&gt;</code></em></pre><p>SELinux can prevent access to an Apache server if its setting is too
  strict. To modify the SELinux setting, run the following as root:</p><pre class="programlisting"># system-config-securitylevel</pre><p>From here, set the SELinux level to be no higher than
  <span class="literal">Permissive</span>. That is, the setting must not be
  <span class="literal">Enforcing</span>.</p><p>Restart the Apache server by running the following as root:</p><pre class="programlisting"># /etc/init.d/httpd restart</pre></div><div class="chapter" title="Chapter&nbsp;7.&nbsp;PHP"><div class="titlepage"><div><div><h2 class="title"><a name="xref_PHP"></a>Chapter&nbsp;7.&nbsp;PHP</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e643">7.1. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e646">7.1.1. Installing PHP</a></span></dt><dt><span class="section"><a href="#d0e663">7.1.2. Testing</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e683">7.2. BigWorld.php</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_BigWorld_php_Error_Handling">7.2.1. BigWorld.php Error handling</a></span></dt><dt><span class="section"><a href="#d0e886">7.2.2. Locating the ServiceApp</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e907">7.3. RemoteEntity Session Storage</a></span></dt></dl></div><p>As a functional example, a PHP module is provided to interface with a
  BigWorld server through script. PHP is a very popular open-source scripting
  language for web development.</p><p>This sample module is designed to be used under Linux with Apache and
  mod_php (the PHP module for Apache). The module also works with the PHP
  Linux command-line interpreter. While the BigWorld sample implementations
  use PHP, it is possible to implement a web integration system using any such
  scripting language or web server. As the <span class="literal">TwistedWeb</span>
  service services HTTP requests, any mechanism that can perform HTTP requests
  can integrate with the <span class="literal">TwistedWeb</span> sample.</p><div class="section" title="7.1.&nbsp;Installation"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e643"></a>7.1.&nbsp;Installation</h2></div></div></div><div class="section" title="7.1.1.&nbsp;Installing PHP"><div class="titlepage"><div><div><h3 class="title"><a name="d0e646"></a>7.1.1.&nbsp;Installing PHP</h3></div></div></div><p>You will need to be able to run PHP. It is possible to install it
      using <span class="command"><strong>yum</strong></span>:</p><pre class="programlisting"># yum install php</pre><p>You will also need to download and install PHP's libcurl module,
      which you can also do using <span class="command"><strong>yum</strong></span>:</p><pre class="programlisting"># yum install curl</pre></div><div class="section" title="7.1.2.&nbsp;Testing"><div class="titlepage"><div><div><h3 class="title"><a name="d0e663"></a>7.1.2.&nbsp;Testing</h3></div></div></div><p>The easiest way to test that PHP is supported is to create a PHP
      script as illustrated below and use a browser to view it:</p><pre class="programlisting">&lt;?php
  phpinfo();
?&gt;</pre><p><span class="citetitle">Testing PHP configuration changes</span></p><div class="informalfigure"><div class="mediaobject"><img src="images/example_phpinfo_output.png"><span class="caption"><p>Example <span class="literal">phpinfo</span>
          output</p></span></div></div></div></div><div class="section" title="7.2.&nbsp;BigWorld.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e683"></a>7.2.&nbsp;BigWorld.php</h2></div></div></div><p>To implement a website that can access the game server, the PHP
    script needs to make HTTP requests to the TwistedWeb service. To help
    achieve this, <code class="filename">BigWorld.php</code> implements a PHP class,
    called <code class="classname">RemoteEntity</code>, that represents a game entity
    on which you can call methods. This is analogous to a BigWorld server
    Entity mailbox.</p><p>A <code class="classname">RemoteEntity</code> is created using the start of
    the URL path as the argument to its constructor. The path does not include
    the machine name and port or the method to call and method arguments. For
    more information about Twisted.Web and instructions on how to request
    entity mailboxes using the TwistedWeb service, see <a class="xref" href="#xref_TwistedWeb_Service" title="Chapter&nbsp;2.&nbsp;The TwistedWeb Service"><i>The TwistedWeb Service</i></a>. For example, to obtain a
    <code class="classname">RemoteEntity</code> to FantasyDemo's
    <span class="literal">AuctionHouse</span> global base entity, you would call:</p><pre class="programlisting">$this-&gt;auctionHouse = new RemoteEntity( "global_entities/AuctionHouse" );</pre><p>The variable to which the <code class="classname">RemoteEntity</code> was
    assigned can subsequently be used like an Entity mailbox for the target
    entity.</p><p>When calling an entity's methods through a
    <code class="classname">RemoteEntity</code>, arguments are provided in the form of
    an array. In PHP, an array is an associated map of key/value pairs. The
    keys are argument names, and the values are the corresponding argument
    values. For example, consider the <span class="literal">AuctionHouse</span> entity's
    <code class="methodname">webCreateBidRangeCriteria()</code> method, which takes
    two arguments, representing the minimum and maximum bids for an item, and
    returns a criteria object. This method has the following definition in
    <code class="filename">AuctionHouse.def</code>:</p><pre class="programlisting">&lt;webCreateBidRangeCriteria&gt;
   &lt;Args&gt;
      &lt;minBid&gt;   GOLDPIECES   &lt;/minBid&gt;
      &lt;maxBid&gt;   GOLDPIECES   &lt;/maxBid&gt;
   &lt;/Args&gt;
   &lt;ReturnValues&gt;
      &lt;criteria&gt;   STRING   &lt;/criteria&gt;  &lt;!-- Search criteria object, pickled --&gt;
   &lt;/ReturnValues&gt;
&lt;/webCreateBidRangeCriteria&gt;</pre><p>To invoke this method from the <code class="classname">RemoteEntity</code>
    for the <span class="literal">AuctionHouse</span> entity, you will need to create a
    PHP array of the arguments. The following code illustrates how this would
    be performed:</p><pre class="programlisting">$res = $this-&gt;auctionHouse-&gt;webCreateBidRangeCriteria( array(
    "minBid" =&gt; $searchMinBid,
    "maxBid" =&gt; $searchMaxBid ) );</pre><p>where the values of <code class="varname">$searchMinBid</code> and
    <code class="varname">$searchMaxBid</code> are defined before the call. The return
    values will be stored in <code class="varname">$res</code>. In this example,
    <code class="varname">$res[ "criteria" ]</code> will contain the string describing
    the criteria.</p><p>The <code class="classname">RemoteEntity</code> instance converts this call
    into a HTTP request on an appropriate <span class="literal">TwistedWeb</span>
    service fragment. It adds the method name and any arguments. It then
    blocks waiting for the JSON response. On success, this response is
    converted into a PHP object.</p><p>In addition to calling entity methods on a
    <code class="classname">RemoteEntity</code> in order to access the entity on the
    game server, it is possible to access the same entities directly, by
    instead using a <code class="classname">RemoteEntity</code> to access the
    database, using the TwistedWeb service's <span class="literal">db</span> URL option,
    for example:</p><pre class="programlisting">$db = new RemoteEntity( "db" );</pre><p>Using this <code class="classname">RemoteEntity</code>, it is possible to
    invoke commands directly on the game server. For example, to directly log
    an account on to the game server, you could make the following
    call:</p><pre class="programlisting">$result = $db-&gt;logOn( array(
    "username" =&gt; $username,
    "password" =&gt; $pass ) );</pre><div class="section" title="7.2.1.&nbsp;BigWorld.php Error handling"><div class="titlepage"><div><div><h3 class="title"><a name="xref_BigWorld_php_Error_Handling"></a>7.2.1.&nbsp;BigWorld.php Error handling</h3></div></div></div><p>It is possible for remote method calls to fail for a number of
      reasons, including invalid arguments or methods, or the requested entity
      not existing. When a call on a RemoteEntity instance fails, the
      TwistedWeb service will return a specially-formatted error object
      instead of the expected JSON object. As described in <a class="xref" href="#xref_TwistedWebErrorHandling" title="2.7.&nbsp;TwistedWeb Error handling">TwistedWeb Error handling</a>, this JSON error object will
      have the format:</p><pre class="programlisting">{ "excType": "<em class="replaceable"><code>ErrorType</code></em>", "args": [ "<em class="replaceable"><code>Arg1</code></em>", "<em class="replaceable"><code>Arg2</code></em>" ... ] }</pre><p>If such an error object is encountered,
      <code class="filename">BigWorld.php</code> will raise it as a PHP exception. This
      exception type will use the <code class="varname">excType</code> field as the type
      name, and the first item in the <code class="varname">args</code> list as the
      exception's message:</p><pre class="programlisting">throw new $excType( $args );</pre><p>For example, a JSON object representing a BWInvalidArgsError
      object will be raised as a BWInvalidArgsError exception, whose message
      will be the first argument contained in the original JSON object.</p><p>Any error object encountered by BigWorld.php will have originated
      as one of two categories of exception objects:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Built-in BigWorld errors -
          <code class="classname">BWStandardError</code></p><p>These are defined in
          <code class="filename">bigworld/res/scripts/server_common/BWTwoWay.py</code>,
          and are explained in the <a href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>'s section<a href="../server_programming_guide/server_programming_guide.html#xref_BWStandardError" class="olink">BWStandardError</a>. They originate in the server
          binaries, and are propagated to the TwistedWeb service.</p><p>In order for them to be raised as exceptions, they are
          declared as PHP exception objects in
          <code class="filename">BWError.php</code>, sharing the class name of their
          python counterparts.</p></li><li class="listitem"><p>Custom errors - <code class="classname">BWCustomError</code></p><p>These are the error types specific to the game scripts, and
          are described in detail in <a class="xref" href="#xref_PHP_Error_Handling" title="10.16.&nbsp;PHP Error handling">PHP Error handling</a>. Like the classes derived from
          <code class="classname">BWStandardError</code>, these must be declared as
          php exception objects in order for them to be handled by normal
          exception-handling procedures. This is to be done in
          <code class="filename">CustomErrors.php</code>. For example, if there is a
          custom error called <code class="classname">MyCustomError</code> declared in
          <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/server_common/CustomErrors.py</code>,
          there should be a matching php object declared in
          <code class="filename">CustomErrors.php</code>:</p><pre class="programlisting">//CustomErrors.php

&lt;?php
require_once( "BWError.php" );
class BWCustomError extends BWFirstArgError {}

<em class="emphasis">class MyCustomError extends BWCustomError {}</em>
?&gt;</pre><p>If an error object is encountered by
          <code class="filename">BigWorld.php</code> that has not been declared as its
          own PHP exception type, it will be thrown instead as a
          <code class="classname">BWGenericError</code>, maintaining the
          <code class="varname">excType</code> field as part of its exception
          message:</p><pre class="programlisting">throw new BWGenericError( $excType, $args );</pre></li></ol></div><p>For details on handling these errors, refer to <a class="xref" href="#xref_PHP_Error_Handling" title="10.16.&nbsp;PHP Error handling">PHP Error handling</a>.</p></div><div class="section" title="7.2.2.&nbsp;Locating the ServiceApp"><div class="titlepage"><div><div><h3 class="title"><a name="d0e886"></a>7.2.2.&nbsp;Locating the ServiceApp</h3></div></div></div><p>The <code class="classname">Service</code> Singleton class in
      <code class="filename">BigWorld.php</code> contains a hard-coded list of possible
      ServiceApp locations. When a web client starts a new session, the
      <code class="classname">RemoteEntity</code> associated with the session is given
      the mailbox of a random ServiceApp that is currently online and
      providing a fragment of the desired service. You will need to modify
      this list to reflect the addresses of your ServiceApp machines:</p><pre class="programlisting">class Service
{
    private function __construct()
    {
        // *** EDIT THIS WITH YOUR ServiceApp ADDRESSES ***
        $this-&gt;urlList = array(
            "http://someMachine:8000",
            "http://localHost:8000",
            "http://someOtherMachine:8000"
        );
    }

    ...
}</pre><p>A web client will access a Service through the same ServiceApp for
      the duration of their session. If this ServiceApp fails during that
      time, the <code class="classname">RemoteEntity</code> will find a different
      ServiceApp providing the same service, and store its address for the
      remainder of the session.</p></div></div><div class="section" title="7.3.&nbsp;RemoteEntity Session Storage"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e907"></a>7.3.&nbsp;RemoteEntity Session Storage</h2></div></div></div><p>It is possible to store a mailbox to an entity for the duration of a
    HTTP session. For example, the <code class="classname">BWAuthenticator</code>
    class' <code class="methodname">authenticateUserPass()</code> method, mentioned
    in the previous section, is used not only to invoke the
    <code class="methodname">logOn</code> command on the game server, but also to
    hold onto the resulting entity for the duration of the session. By storing
    the URL of this entity in PHP session variables, whose values are
    persistent for the entirety of a HTTP session, this allows the web server
    to require authentication from a web client only once per session.</p><p>To store an entity reference:</p><pre class="programlisting">$_SESSION['mailbox'] = "entities_by_id/Avatar/37"; <em class="emphasis">// store details to create mailbox later.</em></pre><p>To later retrieve it:</p><pre class="programlisting">$mailbox = new RemoteEntity( $_SESSION['mailbox'] );</pre><p>For example, to log on and store the result:</p><pre class="programlisting">$db = new RemoteEntity( "db" );

try
{
  $result = $db-&gt;logOn( array( "username" =&gt; $username, "password" =&gt; $pass ) );
}
catch( BWAuthenticateError $e )
{
  // Handle error
  ...
  return;
}

$_SESSION[ "mailbox" ] = "entities_by_id/" . $result[ "type" ] . '/' . $result[ "id" ];</pre></div></div></div><div class="part" title="Part&nbsp;III.&nbsp;Web Integration Example"><div class="titlepage"><div><div><h1 class="title"><a name="d0e935"></a>Part&nbsp;III.&nbsp;Web Integration Example</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_Auction_House_Implementation">8. Overview</a></span></dt><dt><span class="chapter"><a href="#d0e1022">9. Use Cases</a></span></dt><dt><span class="chapter"><a href="#d0e1047">10. PHP Presentation Layer</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1055">10.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e1075">10.2. Required packages</a></span></dt><dt><span class="section"><a href="#d0e1091">10.3. Constants in <code class="filename">Constants.php</code></a></span></dt><dt><span class="section"><a href="#d0e1111">10.4. XHTML-MP helper functions</a></span></dt><dt><span class="section"><a href="#d0e1223">10.5. Debugging PHP example scripts</a></span></dt><dt><span class="section"><a href="#d0e1283">10.6. <code class="classname">XHTMLMPPage</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1326">10.7. <code class="classname">AuthenticatedXHTMLMPPage</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1369">10.8. <code class="classname">BWAuthenticator</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1407">10.9. <code class="filename">Login.php</code></a></span></dt><dt><span class="section"><a href="#d0e1435">10.10. <code class="filename">Characters.php</code></a></span></dt><dt><span class="section"><a href="#d0e1477">10.11. <code class="filename">News.php</code></a></span></dt><dt><span class="section"><a href="#d0e1493">10.12. <code class="filename">Character.php</code></a></span></dt><dt><span class="section"><a href="#d0e1509">10.13. <code class="filename">Inventory.php</code></a></span></dt><dt><span class="section"><a href="#d0e1553">10.14. <code class="filename">PlayerAuctions.php</code></a></span></dt><dt><span class="section"><a href="#d0e1572">10.15. <code class="filename">SearchAuctions.php</code></a></span></dt><dt><span class="section"><a href="#xref_PHP_Error_Handling">10.16. PHP Error handling</a></span></dt></dl></dd></dl></div><div class="chapter" title="Chapter&nbsp;8.&nbsp;Overview"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Auction_House_Implementation"></a>Chapter&nbsp;8.&nbsp;Overview</h2></div></div></div><p>This section describes an example web interface to FantasyDemo. It
  shows how to implement a web auctioning system in order to illustrate
  functions accessible from the BigWorld web integration module, such
  as:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Authentication of player login details.</p></li><li class="listitem"><p>Retrieval of an entity mailbox.</p></li><li class="listitem"><p>Access to base methods that exist on a base entity through a
      mailbox.</p></li><li class="listitem"><p>Passing parameters to and receiving data from the BigWorld Python
      scripting layer using the web scripting layer.</p></li></ul></div><p>The example platform used in this document is the PHP scripting
  language, combined with the Apache HTTP server. This guide uses a variety of
  well-documented techniques for web applications (such as handling session
  variables). Features and techniques used in the example code are common to
  other web scripting languages; thus the techniques presented can also be
  used in other web scripting environments.</p><p>We provide examples on querying the player for inventory and character
  statistics. The item and inventory system is based on the BigWorld
  FantasyDemo item and inventory system. Any item or inventory system with
  similar concepts of item serial numbers, item types and item locking can be
  adapted for the web scripts. Other extensions to this model are
  possible.</p><p>We provide a working example of an Auction House, which the player can
  interact with to:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Create auctions.</p></li><li class="listitem"><p>Search for auctions.</p></li><li class="listitem"><p>Bid on auctions.</p></li></ul></div><p>Auctions have the following characteristics:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Refer to individual items in a player's inventory.</p></li><li class="listitem"><p>Have a starting bid, and may optionally have a buyout
      price.</p></li><li class="listitem"><p>Have adjustable expiry times specified when they are
      created.</p></li><li class="listitem"><p>Every player can bid on auctions made by other players.</p></li><li class="listitem"><p>Players can specify a maximum value for their bid which allows
      automated incremental bidding on behalf of the player, up to the
      specified maximum allowed value.</p><p>This is known as proxy bidding, and this Auction House model is
      common in other popular Internet-based auction houses. In the code, it
      is referred to as an <code class="classname">IncrementalAuction</code>. When
      entering a maximum bid, the entire amount is considered to be passed to
      the auction house; on auction resolution, the difference between the
      maximum bid amount and the actual bid amount is returned back to the
      player.</p></li></ul></div><p>We will walk through the source and highlight the salient areas
  relevant to building a trading system. This example consists of a
  presentation layer written in PHP, and a logic layer that is implemented as
  part of the base entity scripts for the appropriate entities, namely
  <code class="classname">Avatar</code>, <code class="classname">TradingSupervisor</code> and
  <code class="classname">AuctionHouse</code>.</p><div class="informalfigure"><div class="mediaobject"><img src="images/block_system_diagram.png"><span class="caption"><p>Block system diagram</p></span></div></div><p>The logic for the <code class="classname">AuctionHouse</code> entity is
  implemented in the game scripting layer in Python, alongside other entity
  logic in a BigWorld game. With some alterations, the example code used in
  this document can be adapted for use in a game that already has a currency
  and inventory system.</p><p>This document assumes that the reader has read the <a href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>, and is familiar with BigWorld
  Python scripting and has a basic operation of how return-value methods
  work.</p></div><div class="chapter" title="Chapter&nbsp;9.&nbsp;Use Cases"><div class="titlepage"><div><div><h2 class="title"><a name="d0e1022"></a>Chapter&nbsp;9.&nbsp;Use Cases</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The player supplies a username and password to log in, and
        becomes authenticated against the BigWorld game system &#8212; this gives
        access to character selection, and for a chosen character,
        character-specific views and operations.</p></li><li class="listitem"><p>The player views their character statistics in real-time.</p></li><li class="listitem"><p>The player views their inventory and current gold pieces.</p></li><li class="listitem"><p>The player nominates an item in their inventory for which he
        wishes to create an auction, then sets its expiry time, initial bid
        price, and an optional buyout price.</p></li><li class="listitem"><p>The player searches for auctions matching an item type name
        and/or bid range.</p></li><li class="listitem"><p>The player selects an auction and specifies a maximum
        bid.</p></li><li class="listitem"><p>The player logs out.</p></li></ul></div></div><div class="chapter" title="Chapter&nbsp;10.&nbsp;PHP Presentation Layer"><div class="titlepage"><div><div><h2 class="title"><a name="d0e1047"></a>Chapter&nbsp;10.&nbsp;PHP Presentation Layer</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e1055">10.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e1075">10.2. Required packages</a></span></dt><dt><span class="section"><a href="#d0e1091">10.3. Constants in <code class="filename">Constants.php</code></a></span></dt><dt><span class="section"><a href="#d0e1111">10.4. XHTML-MP helper functions</a></span></dt><dt><span class="section"><a href="#d0e1223">10.5. Debugging PHP example scripts</a></span></dt><dt><span class="section"><a href="#d0e1283">10.6. <code class="classname">XHTMLMPPage</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1326">10.7. <code class="classname">AuthenticatedXHTMLMPPage</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1369">10.8. <code class="classname">BWAuthenticator</code> objects</a></span></dt><dt><span class="section"><a href="#d0e1407">10.9. <code class="filename">Login.php</code></a></span></dt><dt><span class="section"><a href="#d0e1435">10.10. <code class="filename">Characters.php</code></a></span></dt><dt><span class="section"><a href="#d0e1477">10.11. <code class="filename">News.php</code></a></span></dt><dt><span class="section"><a href="#d0e1493">10.12. <code class="filename">Character.php</code></a></span></dt><dt><span class="section"><a href="#d0e1509">10.13. <code class="filename">Inventory.php</code></a></span></dt><dt><span class="section"><a href="#d0e1553">10.14. <code class="filename">PlayerAuctions.php</code></a></span></dt><dt><span class="section"><a href="#d0e1572">10.15. <code class="filename">SearchAuctions.php</code></a></span></dt><dt><span class="section"><a href="#xref_PHP_Error_Handling">10.16. PHP Error handling</a></span></dt></dl></div><p>The presentation layer is written in PHP. It handles requests from web
  user agents (such as mobile phones and PC browsers) and presents information
  from the game. The example code PHP sources are found at <code class="filename">fantasydemo/src/web/php</code>.</p><div class="section" title="10.1.&nbsp;Overview"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1055"></a>10.1.&nbsp;Overview</h2></div></div></div><p>PHP pages in the example code are represented as PHP objects, and
    the PHP class definition for
    <span class="literal"><em class="replaceable"><code>&lt;class&gt;</code></em></span> is located in
    <span class="literal"><em class="replaceable"><code>&lt;class&gt;</code></em>.php</span>.
    Generally, after the class definition an instance of the page object is
    created and asked to render itself.</p><p>We do not recommend this way of structuring a web interface. The
    purpose of this PHP construction is to illustrate, as clearly as possible,
    solutions to common problems encountered when implementing a web interface
    to a BigWorld game instance. It is not meant to illustrate best practices
    in web interface implementation.</p><p>Developers can use any frameworks that they wish to implement a web
    interface in PHP or Python. BigWorld does not limit the use of third-party
    frameworks, from complex systems such as Zope to simple templating engines
    such as PHP Smarty.</p><p>The examples adhere to the XHTML-MP standard (XHTML Mobile
    Profile).</p></div><div class="section" title="10.2.&nbsp;Required packages"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1075"></a>10.2.&nbsp;Required packages</h2></div></div></div><p>The Web Integration example requires some packages to be installed
    on the machine running Apache:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>JSON: TwistedWeb queries return data as JSON objects. Install
        this package by running the following as root:</p><pre class="programlisting"># yum install php-pecl-json</pre></li><li class="listitem"><p>Image processing: The FantasyDemo PHP scripts make use of the
        GraphicsDraw library of image processing functions. To install this
        package, run the following as root:</p><pre class="programlisting"># yum install php-gd</pre></li></ul></div></div><div class="section" title="10.3.&nbsp;Constants in Constants.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1091"></a>10.3.&nbsp;Constants in <code class="filename">Constants.php</code></h2></div></div></div><p>Configuration constants and static data are defined in
    <code class="filename">Constants.php</code>. Among other things, it
    contains:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The static item type data (such as URLs to image icons, image
        statistics, etc.) that are used when displaying player
        inventory.</p></li><li class="listitem"><p>The URL of the login page.</p></li><li class="listitem"><p>The URL of the welcome page after authentication.</p></li></ul></div></div><div class="section" title="10.4.&nbsp;XHTML-MP helper functions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1111"></a>10.4.&nbsp;XHTML-MP helper functions</h2></div></div></div><p><span class="literal">XHTML-MP-functions.php</span> contains functions for
    commonly used XHTML-MP (XHTML Mobile Profile) element constructs. The
    simple base ones are listed below:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="function">xhtmlMpSingleTag( <em class="parameter"><code>$name</code></em>, 
        <em class="parameter"><code>$className=''</code></em>, 
        <em class="parameter"><code>$attrString=''</code></em> )</code></p><p>Returns the element source of a single unenclosed XHTML element
        with the given name, class and attribute string.</p></li><li class="listitem"><p><code class="function">xhtmlMpTag( <em class="parameter"><code>$name</code></em>, 
        <em class="parameter"><code>$contents</code></em>,  <em class="parameter"><code>$className=''</code></em>, 
        <em class="parameter"><code>$attrString=''</code></em> )</code></p><p>Returns the element source of a single enclosed XHTML element
        with the given name, contents, class and attribute string.</p></li><li class="listitem"><p><code class="function">xhtmlMpAddAttribute(
        <em class="parameter"><code>$attrString=''</code></em>,  <em class="parameter"><code>$key</code></em>, 
        <em class="parameter"><code>$value</code></em> )</code></p><p>Adds a key value attribute to an attribute string and returns
        it.</p></li></ul></div><p>From these, the other common XHTML elements are built. Here are some
    examples:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="function">xhtmlMpHeading( <em class="parameter"><code>$contents</code></em>, 
        <em class="parameter"><code>$level=1</code></em>,  <em class="parameter"><code>$className=''</code></em>, 
        <em class="parameter"><code>$attrString=''</code></em> )</code></p><p>Returns the element source of a single unenclosed XHTML element
        with the given name, class and attribute string.</p></li><li class="listitem"><p><code class="function">xhtmlMpDiv( <em class="parameter"><code>$contents</code></em>, 
        <em class="parameter"><code>$className=''</code></em>, 
        <em class="parameter"><code>$attrString=''</code></em> )</code></p><p>Returns the element source for a XHTML <span class="literal">DIV</span>
        element with the given optional class and attribute string.</p></li><li class="listitem"><p><code class="function">xhtmlMpPara( <em class="parameter"><code>$contents</code></em>, 
        <em class="parameter"><code>$className=''</code></em> $attrString )</code></p><p>Returns the element source for a XHTML paragraph.</p></li></ul></div><p>There is also a <code class="classname">XHTMLMPForm</code> class for
    creating XHTML MP forms.</p></div><div class="section" title="10.5.&nbsp;Debugging PHP example scripts"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1223"></a>10.5.&nbsp;Debugging PHP example scripts</h2></div></div></div><p>There is a debug library implemented in
    <code class="filename">Debug.php</code> that is used throughout the code example.
    You can use this to trace the flow of the example scripts using the
    various debugging output options.</p><p>Generally, debug output is displayed in a page as a XHTML
    comment.</p><pre class="programlisting">class SomePage extends AuthenticatedXHTMLMPPage
{
...
   function renderBody() 
   {
      ...
      debug( "this is a test" );
      ...
   }
...
}</pre><p><span class="citetitle">Example PHP using the debug function</span></p><p>The code above will generate HTTP output like this:</p><pre class="programlisting">&lt;!--
this is a test
--&gt;</pre><p><span class="citetitle">Example HTTP output</span></p><p>Additionally, you may use this in an overridden
    <code class="methodname">XHTMLMPPage::initialise</code> method. Because
    <code class="methodname">initialise</code> does not write output except for HTTP
    headers in order to perform actions such as HTTP redirects, debug output
    is deferred until the rendering stage of the page, where you will see
    debug output as:</p><pre class="programlisting">&lt;!-- deferred error output follows
debug output instance 1
debug output instance 2
debug output instance 3
deferred error output above --&gt;</pre><p><span class="citetitle">Example HTTP output</span></p><p>There are also some helpful debugging functions for getting
    representations of more complex PHP objects such as Arrays and class
    instance objects:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="methodname">debugStringObj</code></p><p>Returns the string output.</p></li><li class="listitem"><p><code class="methodname">debugObj</code></p><p>Sends the string output through
        <code class="function">debug()</code>.</p></li></ul></div><p>Both these functions generate debug strings representing the
    objects. This is useful for PHP Arrays and PHP class instance
    objects.</p><p>There is also a registered error handler that prints errors through
    <code class="function">debug()</code>, including information such as stack trace,
    function line numbers, and passed parameter values.</p></div><div class="section" title="10.6.&nbsp;XHTMLMPPage objects"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1283"></a>10.6.&nbsp;<code class="classname">XHTMLMPPage</code> objects</h2></div></div></div><p>These are abstractions of a page, and are the basis for all viewable
    pages on the web interface. Class definitions can be found in
    <code class="filename">Page.php</code>.</p><p>There are methods designed to be overridden for the processing stage
    and the output stage.</p><p>The <code class="methodname">XHTMLMPPage::initialise()</code> method is
    called by <code class="methodname">XHTMLMPPage::render()</code> for processing
    before any page source is output. Its purpose is to usually set up the
    page and provide a processing hook for processing HTTP GET/POST request
    parameters, and initialise page instance variables so they can be easily
    rendered in the output stage.</p><p><code class="methodname">XHTMLMPPage::initialise()</code> allows you to set
    redirections from a page to another URL &#8212;
    <code class="methodname">XHTMLMPPage::setRedirect()</code> takes a parameter
    <em class="parameter"><code>$url</code></em> for this purpose. After calling
    <code class="methodname">initialise()</code>, if a redirection has been set, then
    the browser redirects via the HTTP header <code class="code">Location</code>.</p><p><code class="methodname">XHTMLMPPage::renderBody()</code> (called from
    <code class="methodname">XHTMLMPPage::render()</code>) renders the page, and
    outputs the XHTML element for the page content.</p></div><div class="section" title="10.7.&nbsp;AuthenticatedXHTMLMPPage objects"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1326"></a>10.7.&nbsp;<code class="classname">AuthenticatedXHTMLMPPage</code> objects</h2></div></div></div><p>Authenticated XHTML Page inherited objects (class
    <code class="classname">AuthenticatedXHTMLMPPage</code> in
    <code class="filename">AuthenticatedPage.php</code>) are pages that only
    authenticated users can view. Authentication is performed by an instance
    of <code class="classname">Authenticator</code>, with the name of the
    <code class="classname">Authenticator</code> class used to do this (which is
    configured in <code class="filename">Constants.php</code>). For FantasyDemo
    scripts, it is the <code class="classname">BWAuthenticator</code> class.</p><p><code class="classname">Authenticator</code> objects also provide a means of
    storing key-value pairs as server-side session variables.</p><p>The absence of authentication token variables set in the session
    indicates that the user is not logged in, which instructs the client
    browser to redirect to the login page configured in
    <code class="filename">Constants.php</code>. This login page must process requests
    for logging in so that an authenticator object be created that
    authenticates the user and their password and creates the necessary
    authentication token variables.</p><p>There is also a timeout for an authenticated session; if no access
    has been made for a configured amount of time (for details, see
    <code class="filename">Constants.php</code>), then the session is invalidated, and
    browsers that have timed out are redirected back to the configured login
    page with an error message stating that their session has expired.</p><p>Authenticators are used by authenticated pages to check the presence
    of a valid authentication token:</p><pre class="programlisting">if ($this-&gt;auth-&gt;doesAuthTokenExist()) 
{
   $authErr = $this-&gt;auth-&gt;authenticateSessionToken();
   ...
}</pre></div><div class="section" title="10.8.&nbsp;BWAuthenticator objects"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1369"></a>10.8.&nbsp;<code class="classname">BWAuthenticator</code> objects</h2></div></div></div><p>This class provides an example of how to perform authentication with
    the BigWorld system. It involves invoking the
    <code class="function">db/LogOn</code> method with the user's name and
    password:</p><pre class="programlisting">$db = new RemoteEntity( "db" );
$result = $db-&gt;logOn( array( "username" =&gt; $username, "password" =&gt; $pass ) );
</pre><p>The result returned is a PHP object containing the entity's type and
    database id. These details are then stored for later.</p><pre class="programlisting">$this-&gt;setEntityDetails( $result[ "type" ], $result[ "id" ] );</pre><p>This stores the string that is required to create a
    <span class="literal">RemoteEntity</span>.</p><pre class="programlisting">function setEntityDetails( $type, $id )
{
    ...
    $this-&gt;setVariable( BW_AUTHENTICATOR_TOKEN_KEY_ENTITY_PATH,
            "entities_by_id/" . $entityType . '/' . $id );
}</pre><p>The mailbox can then be later retrieved with the
    <code class="code">entity()</code> function.</p><pre class="programlisting">function entity()
{
    $entityPath =
        $this-&gt;getVariable( BW_AUTHENTICATOR_TOKEN_KEY_ENTITY_PATH );
    ...

    return new RemoteEntity( $entityPath );
}</pre><p>Authenticated pages can access this mailbox by their authentication
    object:</p><pre class="programlisting">$playerMailbox = $this-&gt;auth-&gt;entity();</pre><p>Methods can then be called with:</p><pre class="programlisting">$playerMailbox.someMethod();</pre></div><div class="section" title="10.9.&nbsp;Login.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1407"></a>10.9.&nbsp;<code class="filename">Login.php</code></h2></div></div></div><p>This page is responsible for collecting the user name and password
    to be authenticated against the BigWorld server. Thus, any user name and
    password that is valid when logging in with the FantasyDemo client is also
    valid here, so that the <span class="literal">bw.xml</span> configuration options
    <span class="literal">dbMgr/createUnknown</span> and
    <span class="literal">dbMgr/rememberUnknown</span> become relevant (for details on
    these configuration options, see the document <a href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a> <span class="symbol">&#8594;</span> <a href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>).</p><p>Authentication is performed by making a request to the authenticator
    object, for example:</p><pre class="programlisting">$this-&gt;auth-&gt;authenticateUserPass( $_REQUEST['username'], $_REQUEST['password'] );</pre></div><div class="section" title="10.10.&nbsp;Characters.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1435"></a>10.10.&nbsp;<code class="filename">Characters.php</code></h2></div></div></div><p>Once the user authenticates using a username and password, the
    <code class="classname">Account</code> mailbox is queried for its list of
    associated <code class="classname">Avatar</code> characters. This is done as
    follows:</p><pre class="programlisting">$account = $this-&gt;auth-&gt;entity();
$res = $account-&gt;webGetCharacterList();</pre><p>This returns the list of character descriptors in
    <code class="code">$res['characters']</code>. Each character descriptor is a dictionary
    with keys <span class="literal">name</span> and <span class="literal">type</span> (of entity,
    usually <code class="classname">Avatar</code>).</p><p>You can also create characters via this page:</p><pre class="programlisting">$res = $account-&gt;webCreateCharacter( array( "name" =&gt; $_GET['new_character_name'] ) );</pre><p>You choose a character to progress. Once chosen, the session player
    <code class="classname">Account</code> mailbox is replaced by a mailbox to the
    player <code class="classname">Avatar</code> entity and the keep-alive period is
    set on the newly made character mailbox.</p><pre class="programlisting">$res = $account-&gt;webChooseCharacter( array(
            "name" =&gt; $_GET[ 'character' ],
            "type" =&gt; "Avatar" ) );
...
$this-&gt;auth-&gt;setEntityDetails( $res[ "type" ], $res[ "id" ] );</pre></div><div class="section" title="10.11.&nbsp;News.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1477"></a>10.11.&nbsp;<code class="filename">News.php</code></h2></div></div></div><p>This page is the entry point after a user has logged in and chosen a
    character. Currently, this is a static PHP page, but one possible
    extension to this is to have a <code class="classname">News</code> entity in the
    world, which is queried by this page each time it loads up.</p><p>A hook for doing this is present in the
    <code class="methodname">NewsPage::initialise()</code> method:</p><pre class="programlisting">// the articles could also come from an entity
// e.g.
// $newsagent = new RemoteEntity( "global_entities/NewsAgent" );
// $res = $newsagent-&gt;getNewsArticles();
// $this-&gt;articles = $res['articles'];</pre></div><div class="section" title="10.12.&nbsp;Character.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1493"></a>10.12.&nbsp;<code class="filename">Character.php</code></h2></div></div></div><p>This page queries the player <code class="classname">Avatar</code> mailbox
    in real-time via the <code class="methodname">Avatar.webGetPlayerInfo()</code>
    web method for the current statistics of the player for display:</p><pre class="programlisting">$player = $this-&gt;auth-&gt;entity();
$res = $player-&gt;webGetPlayerInfo();</pre><p>The position and the direction the player is currently facing is
    also reported back through this page if the player is online.</p></div><div class="section" title="10.13.&nbsp;Inventory.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1509"></a>10.13.&nbsp;<code class="filename">Inventory.php</code></h2></div></div></div><p>This page queries the player character mailbox via the
    <code class="methodname">Avatar.webGetGoldAndInventory()</code> web method. This
    method is defined in the entity definitions file for the
    <code class="classname">Avatar</code> entity type, in
    <code class="filename">fantasydemo/res/scripts/entity_defs/Avatar.def</code>:</p><pre class="programlisting">&lt;webGetGoldAndInventory&gt;
   &lt;ReturnValues&gt;
      &lt;!-- The Avatar's available gold pieces. --&gt;
      &lt;goldPieces&gt;        GOLDPIECES  &lt;/goldPieces&gt;

      &lt;!-- List of item descriptions as dictionaries with keys:
           'serial': the serial number of the item
           'itemType': the item type
           'lockHandle' : lock handle associated with this item
      --&gt;
      &lt;inventoryItems&gt;    PYTHON      &lt;/inventoryItems&gt;

      &lt;!-- List of dictionary with keys:
          'serials': a list of serial numbers of locked items
          'goldPieces': the gold pieces locked
      --&gt;
      &lt;lockedItems&gt;       PYTHON      &lt;/lockedItems&gt;
    &lt;/ReturnValues&gt;
&lt;/webGetGoldAndInventory&gt;</pre><p>The excerpt above shows that that the return value to the PHP
    scripting layer is an Array with keys <code class="varname">goldPieces</code>,
    <code class="varname">inventoryItems</code> and <code class="varname">lockedItems</code>. We
    store them in the class instance variable
    <code class="varname">$this-&gt;inventory</code>:</p><pre class="programlisting">$entity =&amp; $this-&gt;auth-&gt;entity();
...
$this-&gt;inventory = $entity-&gt;webGetGoldAndInventory();</pre><p>The gold pieces are accessible from this instance variable when
    displaying its value to the user:</p><pre class="programlisting">echo(
   xhtmlMpDiv(
      'Gold: '. $this-&gt;inventory['goldPieces'],
         'goldRow'
   )
);</pre><p>This page is also responsible for handling requests for creating
    auctions from the player. The player nominates an item in their inventory,
    based on its serial number, then sets the initial auction parameters
    through the form and on submission, and creating the auction is a case of
    invoking the <code class="methodname">Avatar.webCreateAuction</code>:</p><pre class="programlisting">$res = $entity-&gt;webCreateAuction( array(
    "itemSerial" =&gt; $itemSerialToAuction,
    "expiry" =&gt; $expiry,
    "startBid" =&gt; $bidPrice,
    "buyout" =&gt; $buyout ) );</pre></div><div class="section" title="10.14.&nbsp;PlayerAuctions.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1553"></a>10.14.&nbsp;<code class="filename">PlayerAuctions.php</code></h2></div></div></div><p>This page enables players to see the state of auctions they have
    created. The search criteria used is an instance of
    <code class="classname">SellerCriteria</code> with the current player's database
    ID. This is retrieved from
    <code class="methodname">Avatar.webGetPlayerInfo()</code>:</p><pre class="programlisting">$res = $this-&gt;player-&gt;webGetPlayerInfo();
$this-&gt;playerDBID = $res['databaseID'];</pre><p>The result is used in constructing and applying the
    <code class="classname">SellerCriteria</code> for getting search results to
    present to the user.</p></div><div class="section" title="10.15.&nbsp;SearchAuctions.php"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1572"></a>10.15.&nbsp;<code class="filename">SearchAuctions.php</code></h2></div></div></div><p>This page enables players to search for auctions by using the
    singleton <code class="classname">AuctionHouse</code> entity, and allows for
    bidding of searched auctions.</p><p>Search criteria objects are built up using various methods in
    AuctionHouse, for example:</p><pre class="programlisting">$res = $this-&gt;auctionHouse-&gt;webCreateItemTypeCriteria( array(
    "itemTypes" =&gt; $itemTypesList ) );
...
$searchCriteria = $res['criteria'];
...
$res = $this-&gt;auctionHouse-&gt;webCreateBidRangeCriteria( array(
    "minBid" =&gt; $searchMinBid,
    "maxBid" =&gt; $searchMaxBid ) );
$bidRangeCriteria = $res['criteria'];
$res = $this-&gt;auctionHouse-&gt;webCombineAnd( array(
                    "criteria1" =&gt; $searchCriteria,
                    "criteria2" =&gt; $bidRangeCriteria ) );
$searchCriteria = $res['criteria'];</pre><p>The <code class="varname">$searchCriteria</code> object contains the combined
    search criteria. It can be applied to a search via the
    <code class="methodname">AuctionHouse.webSearchAuctions()</code> method. This
    method returns a list of auction IDs that match the criteria.</p><p>To retrieve the auction descriptors (which contains information such
    as the seller player, the current bid amount, the item type), we use the
    <code class="methodname">AuctionHouse.webGetAuctionInfo()</code> which takes a
    list of auction IDs and returns a list of auction descriptors.</p><pre class="programlisting">$res = $this-&gt;auctionHouse-&gt;webSearchAuctions( array(
            "criteria" =&gt; $searchCriteria ) );
...
$res = $this-&gt;auctionHouse-&gt;webGetAuctionInfo( array(
            "auctions" =&gt; $res["searchedAuctions"] ) );
...
// store the auctions in an associative array by auction ID
$this-&gt;searchResults = Array();
foreach ($res['auctionInfo'] ) as $auctionInfo)
{
    $this-&gt;searchResults[$auctionInfo['auctionID'] = $auctionInfo;
}
...</pre></div><div class="section" title="10.16.&nbsp;PHP Error handling"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_PHP_Error_Handling"></a>10.16.&nbsp;PHP Error handling</h2></div></div></div><p>As described in section <a class="xref" href="#xref_BigWorld_php_Error_Handling" title="7.2.1.&nbsp;BigWorld.php Error handling">BigWorld.php Error handling</a>, all mailbox queries can
    fail, resulting in an error object being returned. In addition to errors
    coming from the server binaries, errors can be returned from the remote
    methods themselves. These are custom exception types that will be raised
    by the auction house scripts, the authentication scripts, and the other
    methods called remotely by the web client. For example, in the
    AuctionHouse methods called by the FantasyDemo web client PHP code, there
    are such error classes as <code class="classname">InsufficientGoldError</code> and
    <code class="classname">SearchCriteriaError</code>, allowing error messages that
    are displayed to the player to be as helpful as possible.</p><p>The file
    <code class="filename">fantasydemo/res/scripts/server_common/CustomErrors.py</code>
    contains the declarations of these custom Python exception classes. They
    are as follows:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="classname">AuctionHouseError</code></p><p>Attempt to access an AuctionHouse entity that is not allowed
          or non-existent</p></li><li class="listitem"><p><code class="classname">BidError</code></p><p>Bid for an auction with an invalid amount</p></li><li class="listitem"><p><code class="classname">BuyoutError</code></p><p>Set an invalid buyout price for an auction</p></li><li class="listitem"><p><code class="classname">CreateEntityError</code></p><p>An entity can't be created</p></li><li class="listitem"><p><code class="classname">DBError</code></p><p>A database query or modification fails</p></li><li class="listitem"><p><code class="classname">InsufficientGoldError</code></p><p>The player doesn't have enough gold for the desired
          transaction</p></li><li class="listitem"><p><code class="classname">InvalidAuctionError</code></p><p>Attempt to access an invalid or non-existent auction</p></li><li class="listitem"><p><code class="classname">InvalidDamageAmountError</code></p><p>Attempt to deal an invalid amount of damage to an
          entity</p></li><li class="listitem"><p><code class="classname">InvalidItemError</code></p><p>An item can't be accessed</p></li><li class="listitem"><p><code class="classname">ItemLockError</code></p><p>An item can't be locked</p></li><li class="listitem"><p><code class="classname">PriceError</code></p><p>Set an invalid price for an auction</p></li><li class="listitem"><p><code class="classname">SearchCriteriaError</code></p><p>Search criteria for an auction are invalid</p></li></ul></div><p>The TwistedWeb service will catch these exception objects, convert
    them to JSON objects and return them instead of the queried response
    object, as explained in <a class="xref" href="#xref_TwistedWebErrorHandling" title="2.7.&nbsp;TwistedWeb Error handling">TwistedWeb Error handling</a>.</p><p>Additional error types can be used by declaring them in
    <code class="filename">CustomErrors.py</code>. They must be derived from
    <code class="methodname">BWTwoWay.BWCustomError</code>. They should also be
    declared in <code class="filename">CustomErrors.php</code>, to allow them to be
    handled individually. For example:</p><pre class="programlisting"># CustomErrors.py

from BWTwoWay import BWCustomError

<em class="emphasis">class MyCustomGameError( BWCustomError ):
    pass</em></pre><pre class="programlisting">// CustomErrors.php

require_once( "BWError.php" );

class BWCustomError extends BWError {}

<em class="emphasis">class MyCustomGameError( BWCustomError ):
    pass</em></pre><p>After <code class="filename">BigWorld.php</code> receives a response, it
    decodes the returned JSON object. If the object is found to be an error,
    it will be raised as a PHP exception. The caller of the mailbox query must
    therefore handle any potential exceptions that may be raised. For
    example:</p><pre class="programlisting">try
{
    $result = $mailbox-&gt;someMethod();
}
catch( Exception $e )
{
    addExceptionMsg( $e );
    return;
}

// Use $result
...</pre><p>All built-in BigWorld errors and custom errors extend a common base
    class, <code class="classname">BWError</code>. This class implements a
    <code class="methodname">message</code> method, which creates a string containing
    both the underlying error type, and the exception message. It also returns
    a well-formatted string for BWGenericError objects, described in <a class="xref" href="#xref_BigWorld_php_Error_Handling" title="7.2.1.&nbsp;BigWorld.php Error handling">BigWorld.php Error handling</a>. This method can be used to
    generate error messages in an exception handler. For example:</p><pre class="programlisting">function getExceptionMsg( $exception )
{
    if ($exception instanceof BWError)
    {
        return $exception-&gt;message();
    }
    else
    {
        // uses the built-in getMessage method
        return $exception-&gt;getMessage();
    }
}

function addExceptionMsg( $exception )
{
    $msg = $this-&gt;getExceptionMsg( $exception )

    // Create an error message from $msg
    ...
}</pre><p>For example:</p><pre class="programlisting">throw new NoConnectionError( "Unable to contact game server" );</pre><p>If the above exception is caught and the object sent as the argument
    to addExceptionMsg, the player will receive the following error
    message:</p><pre class="programlisting">NoConnectionError: Unable to contact game server</pre><p>Alternatively, if an instance of a
    <code class="classname">BWGenericError</code> or a
    non-<code class="classname">BWError</code> object is thrown with the same message,
    only that message would be emitted, and not the exception type:</p><pre class="programlisting">Unable to contact game server</pre><p>The complete error handling mechanism for the FantasyDemo web client
    is implemented in <code class="filename">Page.php</code>.</p><p><code class="filename">CustomErrors.php</code> also defines an error class
    for errors specific to the PHP, called <code class="classname">BWPHPError</code>.
    Errors of this type can be used to take advantage of the formatting of
    error messages using the <code class="methodname">message</code> method provided
    by <code class="classname">BWError</code>. This allows PHP errors to be handled
    and reported in a manner consistent with the error objects encountered by
    <code class="filename">BigWorld.php</code>:</p><pre class="programlisting">// CustomErrors.php

class BWPHPError extends BWError {}

<em class="emphasis">class InvalidFieldError extends BWPHPError {}</em></pre><pre class="programlisting">// BWAuthenticator.php

...
function authenticateUserPass( $username, $pass )
{
    if ($username == '')
    {
        throw new InvalidFieldError( "Username is empty" );
    }
    if ($pass == '')
    {
        throw new InvalidFieldError( "Password is empty" );
    }
    ...
}
...</pre><pre class="programlisting">// Login.php

...
    try
    {
        $auth-&gt;authenticateUserPass( $username, $pass );
    }
    catch( InvalidFieldError $e )
    {
        addExceptionMsg( $e );
        return;
    }
...</pre><p>Attempting to log in with an empty username will result in the
    following error message being displayed:</p><pre class="programlisting">InvalidFieldError: Username is empty</pre></div></div></div></div></div></body></html>